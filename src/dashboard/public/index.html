<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bastilon OS — Dashboard</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#d4a843">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="/icon-192.png">
  <style>
    :root {
      --bg: #0d1117;
      --bg2: #161b22;
      --bg3: #21262d;
      --border: #30363d;
      --text: #e6edf3;
      --text2: #8b949e;
      --accent: #58a6ff;
      --green: #3fb950;
      --yellow: #d29922;
      --red: #f85149;
      --purple: #bc8cff;
      --orange: #f0883e;
      --sidebar-w: 240px;
      --voice-sidebar-w: 380px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    /* ── Sidebar ────────────────────────────────── */
    .sidebar {
      width: var(--sidebar-w);
      background: var(--bg2);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow-y: auto;
      transition: width 0.2s;
    }
    .sidebar.collapsed { width: 48px; }
    .sidebar.collapsed .nav-label,
    .sidebar.collapsed .sidebar-header span,
    .sidebar.collapsed .nav-group-title,
    .sidebar.collapsed .health-badge span { display: none; }
    .sidebar.collapsed .nav-item { justify-content: center; padding: 10px 0; }
    .sidebar.collapsed .nav-icon { margin: 0; }

    .sidebar-header {
      padding: 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }
    .sidebar-header .brand {
      font-weight: 700; font-size: 15px;
      display: flex; align-items: center; gap: 8px;
    }
    .sidebar-header .brand em { color: var(--accent); font-style: normal; }
    .sidebar-toggle {
      background: none; border: none; color: var(--text2);
      cursor: pointer; font-size: 16px; padding: 4px;
    }
    .sidebar-toggle:hover { color: var(--text); }

    .health-badge {
      margin: 8px 12px;
      padding: 6px 10px;
      background: var(--bg3);
      border-radius: 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .dot-green { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .dot-yellow { background: var(--yellow); }
    .dot-red { background: var(--red); }

    .nav-group-title {
      padding: 12px 16px 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text2);
    }
    .nav-item {
      display: flex;
      align-items: center;
      padding: 8px 16px;
      font-size: 13px;
      color: var(--text2);
      cursor: pointer;
      transition: all 0.1s;
      text-decoration: none;
      border-left: 3px solid transparent;
    }
    .nav-item:hover { background: var(--bg3); color: var(--text); }
    .nav-item.active {
      color: var(--accent);
      background: rgba(88,166,255,.08);
      border-left-color: var(--accent);
    }
    .nav-icon { width: 20px; text-align: center; margin-right: 10px; font-size: 14px; }
    .nav-label { white-space: nowrap; }
    .nav-badge {
      margin-left: auto;
      background: var(--bg3);
      padding: 1px 7px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    /* ── XP Badge (sidebar) ───────────────────── */
    .xp-badge {
      margin: 4px 12px 8px;
      padding: 8px 10px;
      background: linear-gradient(135deg, rgba(88,166,255,.12), rgba(188,140,255,.12));
      border: 1px solid rgba(88,166,255,.25);
      border-radius: 8px;
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
    }
    .xp-badge:hover { border-color: var(--accent); }
    .xp-badge .xp-level {
      font-weight: 700;
      font-size: 11px;
      color: var(--purple);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .xp-badge .xp-points {
      font-weight: 700;
      font-size: 14px;
      color: var(--accent);
      margin-left: auto;
    }
    .xp-badge .xp-label {
      font-size: 10px;
      color: var(--text2);
    }
    .sidebar.collapsed .xp-badge .xp-level,
    .sidebar.collapsed .xp-badge .xp-label,
    .sidebar.collapsed .xp-badge .xp-points-suffix { display: none; }
    .sidebar.collapsed .xp-badge { justify-content: center; padding: 6px; }

    /* ── Main Content ───────────────────────────── */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .view { display: none; flex-direction: column; flex: 1; overflow: hidden; }
    .view.active { display: flex; }

    .view-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      background: var(--bg2);
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .view-body { flex: 1; overflow-y: auto; padding: 16px 20px; }

    /* ── Cards ───────────────────────────────────── */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }
    .card {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
    }
    .card .card-title { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text2); margin-bottom: 8px; }
    .card .card-value { font-size: 24px; font-weight: 700; color: var(--accent); }
    .card .card-sub { font-size: 12px; color: var(--text2); margin-top: 4px; }
    .xp-progress-bar { background: var(--border); border-radius: 4px; height: 8px; margin-top: 8px; overflow: hidden; }
    .xp-progress-bar .xp-fill { background: var(--accent); height: 100%; border-radius: 4px; transition: width 0.3s; }

    /* ── Table ───────────────────────────────────── */
    .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
    .data-table th {
      text-align: left; padding: 8px 12px;
      background: var(--bg2); color: var(--text2);
      font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0;
    }
    .data-table td {
      padding: 8px 12px;
      border-bottom: 1px solid rgba(48,54,61,.5);
    }
    .data-table tr:hover td { background: var(--bg2); }

    .badge-sm {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
    }
    .badge-green { background: rgba(63,185,80,.15); color: var(--green); }
    .badge-red { background: rgba(248,81,73,.15); color: var(--red); }
    .badge-yellow { background: rgba(210,153,34,.15); color: var(--yellow); }
    .badge-blue { background: rgba(88,166,255,.15); color: var(--accent); }
    .badge-purple { background: rgba(188,140,255,.15); color: var(--purple); }

    /* ── Search ──────────────────────────────────── */
    .search-box {
      width: 100%; padding: 8px 12px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text);
      font-size: 13px; outline: none;
      margin-bottom: 12px;
    }
    .search-box:focus { border-color: var(--accent); }

    /* ── Log viewer ─────────────────────────────── */
    .log-viewer {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: 'Cascadia Code', 'Fira Code', 'Consolas', monospace;
      font-size: 12px;
      line-height: 1.6;
      padding: 12px;
      overflow-y: auto;
      flex: 1;
      white-space: pre-wrap;
      word-break: break-all;
    }
    .log-line { padding: 1px 0; }
    .log-debug { color: var(--text2); }
    .log-info { color: var(--text); }
    .log-warn { color: var(--yellow); }
    .log-error { color: var(--red); }

    /* ── Config editor ──────────────────────────── */
    .config-row {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 6px 0;
      border-bottom: 1px solid rgba(48,54,61,.5);
    }
    .config-key {
      font-family: monospace; font-size: 12px; color: var(--accent);
      min-width: 240px;
    }
    .config-val {
      flex: 1; background: var(--bg); border: 1px solid var(--border);
      border-radius: 6px; padding: 4px 8px; color: var(--text);
      font-size: 12px; font-family: monospace; outline: none;
    }
    .config-val:focus { border-color: var(--accent); }
    .config-val.secret { color: var(--text2); }

    /* ── Chat (preserved from original) ─────────── */
    .chat-tabs {
      display: flex;
      background: var(--bg2);
      border-bottom: 1px solid var(--border);
    }
    .chat-tab {
      flex: 1; padding: 10px;
      text-align: center; font-size: 13px; font-weight: 600;
      cursor: pointer; border-bottom: 2px solid transparent;
      color: var(--text2); transition: all 0.15s;
    }
    .chat-tab:hover { color: var(--text); background: var(--bg3); }
    .chat-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .chat-tab.emile.active { color: var(--purple); border-bottom-color: var(--purple); }

    .chat-messages {
      flex: 1; overflow-y: auto; padding: 16px;
      display: flex; flex-direction: column; gap: 12px;
    }
    .msg {
      max-width: 80%; padding: 10px 14px;
      border-radius: 12px; font-size: 14px; line-height: 1.5;
      word-wrap: break-word; white-space: pre-wrap;
    }
    .msg-user {
      align-self: flex-end;
      background: var(--accent); color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg-assistant {
      align-self: flex-start;
      background: var(--bg3); color: var(--text);
      border-bottom-left-radius: 4px;
      border: 1px solid var(--border);
    }
    .msg-assistant.emile { border-color: rgba(188,140,255,.3); }
    .msg-system {
      align-self: center;
      color: var(--text2); font-size: 12px; font-style: italic;
    }

    .chat-input-area {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      background: var(--bg2);
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: end;
    }
    .chat-controls {
      grid-column: 1 / -1;
      display: flex; gap: 8px; align-items: center;
    }
    .chat-controls select, .chat-controls input {
      background: var(--bg3); color: var(--text);
      border: 1px solid var(--border); border-radius: 8px;
      padding: 6px 10px; font-size: 12px; outline: none;
    }
    .chat-input-area textarea {
      flex: 1; background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px; padding: 10px 14px;
      color: var(--text); font-size: 14px;
      font-family: inherit; resize: none;
      outline: none; min-height: 42px; max-height: 120px;
    }
    .chat-input-area textarea:focus { border-color: var(--accent); }
    .chat-input-area button {
      background: var(--accent); color: #fff; border: none;
      border-radius: 8px; padding: 0 20px;
      font-size: 14px; font-weight: 600; cursor: pointer;
    }
    .chat-input-area button.secondary {
      background: var(--bg3); color: var(--text);
      border: 1px solid var(--border); padding: 0 12px; min-height: 36px;
    }
    .chat-input-area button:hover { opacity: 0.85; }
    .chat-input-area button:disabled { opacity: 0.4; cursor: not-allowed; }
    .chat-input-area button.emile-btn { background: var(--purple); }
    .chat-input-area button.conseil-btn {
      background: linear-gradient(135deg, var(--accent), var(--purple));
    }

    .msg-label { font-size: 11px; font-weight: 700; margin-bottom: 4px; letter-spacing: 0.3px; }
    .msg-label.kingston { color: var(--accent); }
    .msg-label.emile { color: var(--purple); }
    .msg-assistant.kingston-msg { border-color: rgba(88,166,255,.3); }
    .msg-assistant.emile-msg { border-color: rgba(188,140,255,.3); }

    .continue-bar {
      padding: 8px 16px; border-top: 1px solid var(--border);
      background: var(--bg2); display: flex; gap: 8px; justify-content: center;
    }
    .continue-bar button {
      background: var(--bg3); color: var(--text);
      border: 1px solid var(--border); border-radius: 8px;
      padding: 6px 16px; font-size: 12px; cursor: pointer;
    }
    .continue-bar button:hover { border-color: var(--accent); background: var(--bg); }
    .continue-bar button:disabled { opacity: 0.4; cursor: not-allowed; }

    .typing-indicator {
      display: flex; gap: 4px; padding: 8px 14px; align-self: flex-start;
    }
    .typing-indicator span {
      width: 6px; height: 6px; background: var(--text2);
      border-radius: 50%; animation: bounce 1.4s infinite ease-in-out;
    }
    .typing-indicator span:nth-child(1) { animation-delay: 0s; }
    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); }
      40% { transform: scale(1); }
    }
    .typing-progress {
      font-size: 12px; color: var(--accent); font-style: italic;
    }
    .msg pre { background: var(--bg); padding: 8px 12px; border-radius: 6px; overflow-x: auto; font-size: 13px; border: 1px solid var(--border); }
    .msg pre code { background: none; padding: 0; color: var(--text); }
    .msg code { background: var(--bg3); padding: 2px 5px; border-radius: 3px; font-size: 13px; }
    .msg ul, .msg ol { margin: 4px 0; padding-left: 20px; }
    .msg li { margin: 2px 0; }
    .msg a { color: var(--accent); text-decoration: underline; }
    .msg h3 { font-size: 15px; margin: 8px 0 4px; color: var(--text); font-weight: 600; }
    .msg strong { color: var(--text); font-weight: 600; }
    .msg em { font-style: italic; color: var(--text2); }
    .msg blockquote { border-left: 3px solid var(--accent); padding-left: 8px; margin: 4px 0; color: var(--text2); font-style: italic; }

    /* ── Rate limit banner ──────────────────────── */
    .rate-limit-banner {
      background: rgba(248,81,73,.1); border: 1px solid rgba(248,81,73,.3);
      color: var(--red); padding: 6px 20px; font-size: 13px;
      text-align: center; display: none;
    }
    .rate-limit-banner.visible { display: block; }

    /* ── Namespace group ─────────────────────────── */
    .ns-group { margin-bottom: 16px; }
    .ns-title {
      font-size: 13px; font-weight: 700; color: var(--accent);
      padding: 8px 0 4px; border-bottom: 1px solid var(--border);
      margin-bottom: 6px;
    }
    .skill-row {
      display: flex; align-items: center; gap: 12px;
      padding: 5px 8px; font-size: 12px;
      border-radius: 6px;
    }
    .skill-row:hover { background: var(--bg2); }
    .skill-name { font-family: monospace; color: var(--text); min-width: 200px; }
    .skill-desc { color: var(--text2); flex: 1; }
    .skill-args { color: var(--text2); font-family: monospace; font-size: 11px; }

    /* ── Memory items ────────────────────────────── */
    .mem-item {
      padding: 8px 12px;
      border-bottom: 1px solid rgba(48,54,61,.5);
      font-size: 13px;
    }
    .mem-item:hover { background: var(--bg2); }
    .mem-cat {
      display: inline-block; padding: 1px 6px; border-radius: 8px;
      font-size: 10px; font-weight: 600; margin-right: 6px;
    }
    .mem-cat-profile { background: rgba(88,166,255,.15); color: var(--accent); }
    .mem-cat-preference { background: rgba(188,140,255,.15); color: var(--purple); }
    .mem-cat-event { background: rgba(210,153,34,.15); color: var(--yellow); }
    .mem-cat-knowledge { background: rgba(63,185,80,.15); color: var(--green); }
    .mem-cat-skill { background: rgba(240,136,62,.15); color: var(--orange); }
    .mem-cat-project { background: rgba(248,81,73,.15); color: var(--red); }

    /* ── Voice Sidebar (right) ────────────────────── */
    .voice-sidebar {
      width: var(--voice-sidebar-w);
      background: var(--bg2);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: width 0.3s, opacity 0.3s;
      overflow: hidden;
      position: relative;
    }
    .voice-sidebar.collapsed {
      width: 0;
      opacity: 0;
      border-left: none;
    }
    .voice-sidebar-toggle {
      position: absolute;
      left: -32px;
      top: 12px;
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text2);
      width: 28px; height: 28px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.2s;
    }
    .voice-sidebar-toggle:hover { color: var(--text); border-color: var(--accent); }
    .voice-sidebar.collapsed .voice-sidebar-toggle { left: -40px; }
    .voice-sidebar .voice-transcript { flex: 1; }
    .voice-sidebar .voice-controls-bar { flex-shrink: 0; }
    .voice-sidebar .voice-wake-bar { flex-shrink: 0; }
    .voice-sidebar .voice-msg { max-width: 95%; font-size: 13px; }

    /* Kingston Avatar Indicator */
    .kingston-avatar {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 16px 12px 12px;
      border-bottom: 1px solid var(--border);
      gap: 8px;
    }
    .kingston-orb {
      width: 56px; height: 56px;
      border-radius: 50%;
      background: var(--bg3);
      border: 2px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      transition: all 0.4s ease;
      position: relative;
    }
    .kingston-orb[data-state="wake"] {
      border-color: var(--yellow);
      box-shadow: 0 0 12px rgba(210,153,34,.3);
      animation: orb-breathe 2.5s ease-in-out infinite;
    }
    .kingston-orb[data-state="listen"] {
      border-color: var(--green);
      box-shadow: 0 0 16px rgba(63,185,80,.4);
      animation: orb-breathe 2s ease-in-out infinite;
    }
    .kingston-orb[data-state="think"] {
      border-color: var(--purple);
      box-shadow: 0 0 20px rgba(188,140,255,.5);
      animation: orb-spin 1.2s linear infinite;
    }
    .kingston-orb[data-state="speak"] {
      border-color: var(--accent);
      box-shadow: 0 0 20px rgba(88,166,255,.5);
      animation: orb-pulse 0.8s ease-in-out infinite;
    }
    @keyframes orb-breathe {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.06); }
    }
    @keyframes orb-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @keyframes orb-pulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(88,166,255,.5); }
      50% { transform: scale(1.08); box-shadow: 0 0 28px rgba(88,166,255,.7); }
    }
    .kingston-avatar-label {
      font-size: 11px;
      color: var(--text2);
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
    }
    .kingston-avatar-status {
      font-size: 12px;
      color: var(--text2);
    }

    /* Floating voice toggle when sidebar is collapsed */
    .voice-float-toggle {
      position: fixed;
      right: 12px;
      top: 12px;
      background: var(--accent);
      color: #fff;
      border: none;
      width: 40px; height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0,0,0,.3);
      z-index: 100;
      transition: transform 0.2s;
    }
    .voice-float-toggle:hover { transform: scale(1.1); }
    .voice-float-toggle.visible { display: flex; }

    /* ── Gallery ──────────────────────────────────── */
    .gallery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 12px;
    }
    .gallery-item {
      background: var(--bg2);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      transition: border-color 0.2s, transform 0.15s;
    }
    .gallery-item:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
    }
    .gallery-item img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      display: block;
    }
    .gallery-item-info {
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text2);
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
    }
    .gallery-item-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 70%;
    }
    .gallery-preview-overlay {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,.88);
      z-index: 300;
      align-items: center;
      justify-content: center;
    }
    .gallery-preview-overlay.visible { display: flex; }
    .gallery-preview-content {
      position: relative;
      max-width: 90vw;
      max-height: 90vh;
    }
    .gallery-preview-content img {
      max-width: 90vw;
      max-height: 85vh;
      border-radius: 8px;
      display: block;
    }
    .gallery-preview-info {
      text-align: center;
      padding: 8px;
      color: var(--text2);
      font-size: 12px;
    }
    .gallery-preview-close {
      position: absolute;
      top: -12px; right: -12px;
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text);
      width: 32px; height: 32px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .gallery-preview-close:hover { background: var(--red); color: #fff; }
    .gallery-empty {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
    }

    /* ── Chat Sidebar (right panel) ─────────────── */
    .chat-sidebar {
      width: 380px;
      background: var(--bg2);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      transition: width 0.3s ease, min-width 0.3s ease;
      overflow: hidden;
      position: relative;
    }
    .chat-sidebar.collapsed {
      width: 48px;
      min-width: 48px;
    }
    .chat-sidebar.collapsed .chat-sidebar-body { display: none; }
    .chat-sidebar.collapsed .chat-sidebar-header { display: none; }
    .chat-sidebar-header {
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .chat-sidebar-header .cs-title {
      font-weight: 600; font-size: 14px;
    }
    .chat-sidebar-toggle-btn {
      background: none; border: none;
      color: var(--text2); cursor: pointer;
      font-size: 16px; padding: 4px 8px;
    }
    .chat-sidebar-toggle-btn:hover { color: var(--text); }
    .chat-sidebar-collapsed-icon {
      display: none;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      padding: 16px 0;
      cursor: pointer;
    }
    .chat-sidebar.collapsed .chat-sidebar-collapsed-icon { display: flex; }
    .chat-sidebar-body {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
    }
    .chat-sidebar .msg { max-width: 95%; }
    .chat-sidebar .chat-input-area {
      grid-template-columns: 1fr auto;
    }
    .cs-badge {
      background: var(--accent);
      color: #fff; font-size: 10px; font-weight: 700;
      min-width: 18px; height: 18px;
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      padding: 0 4px;
    }
    .cs-badge:empty { display: none; }
    /* Chat media viewer (center panel when chat view is active) */
    .chat-media-grid {
      display: flex; flex-wrap: wrap; gap: 12px;
      align-content: start;
    }
    .chat-media-grid img {
      width: 200px; height: 200px; object-fit: cover;
      border-radius: 8px; cursor: pointer;
      border: 1px solid var(--border);
      transition: transform 0.2s;
    }
    .chat-media-grid img:hover { transform: scale(1.05); }
    .chat-media-placeholder {
      color: var(--text2); font-size: 14px;
      text-align: center; padding: 40px 20px;
    }
    /* Clickable images in chat sidebar */
    .chat-sidebar .msg img {
      cursor: pointer;
      max-width: 100%; max-height: 200px;
      border-radius: 6px;
      transition: opacity 0.2s;
    }
    .chat-sidebar .msg img:hover { opacity: 0.8; }

    /* ── Scrollbar ───────────────────────────────── */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--bg3); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border); }

    /* ── Responsive ──────────────────────────────── */
    @media (max-width: 1200px) {
      .voice-sidebar { width: 0; opacity: 0; border-left: none; }
      .chat-sidebar { width: 0; min-width: 0; opacity: 0; border-left: none; }
      .voice-float-toggle { display: flex; }
    }
    @media (max-width: 900px) {
      .sidebar { width: 48px; }
      .sidebar .nav-label, .sidebar .sidebar-header span,
      .sidebar .nav-group-title, .sidebar .health-badge span { display: none; }
      .sidebar .nav-item { justify-content: center; padding: 10px 0; }
      .sidebar .nav-icon { margin: 0; }
    }

    .btn {
      background: var(--accent); color: #fff; border: none;
      border-radius: 8px; padding: 6px 16px;
      font-size: 13px; font-weight: 600; cursor: pointer;
    }
    .btn:hover { opacity: 0.85; }
    .btn-sm { padding: 4px 10px; font-size: 12px; }
    .btn-secondary {
      background: var(--bg3); color: var(--text);
      border: 1px solid var(--border);
    }

    .filter-bar {
      display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;
    }
    .filter-btn {
      background: var(--bg3); color: var(--text2);
      border: 1px solid var(--border); border-radius: 16px;
      padding: 4px 12px; font-size: 11px; cursor: pointer;
    }
    .filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .filter-btn:hover { border-color: var(--accent); }

    /* ── Voice ────────────────────────────────────── */
    .voice-transcript {
      flex: 1; overflow-y: auto; padding: 16px 20px;
      display: flex; flex-direction: column; gap: 10px;
    }
    .voice-msg {
      max-width: 80%; padding: 10px 14px;
      border-radius: 12px; font-size: 14px; line-height: 1.5;
      word-wrap: break-word; white-space: pre-wrap;
    }
    .voice-msg-user {
      align-self: flex-end;
      background: var(--accent); color: #fff;
      border-bottom-right-radius: 4px;
    }
    .voice-msg-kingston {
      align-self: flex-start;
      background: var(--bg3); color: var(--text);
      border-bottom-left-radius: 4px;
      border: 1px solid var(--border);
    }
    .voice-msg-system {
      align-self: center;
      color: var(--text2); font-size: 12px; font-style: italic;
    }
    .voice-msg-label {
      font-size: 11px; font-weight: 700; margin-bottom: 4px;
      letter-spacing: 0.3px;
    }
    .voice-msg-label.lbl-user { color: #fff; }
    .voice-msg-label.lbl-kingston { color: var(--accent); }

    .voice-wake-bar {
      padding: 8px 20px;
      background: var(--bg2);
      border-top: 1px solid var(--border);
      font-size: 12px; color: var(--text2);
      font-style: italic;
      min-height: 32px;
      display: none;
    }
    .voice-wake-bar.visible { display: block; }
    .voice-wake-bar .heard { color: var(--yellow); font-weight: 600; }

    .voice-controls-bar {
      padding: 10px 16px;
      border-top: 1px solid var(--border);
      background: var(--bg2);
      display: flex; gap: 8px; align-items: center;
    }
    .voice-ctrl-btn {
      background: var(--bg3); color: var(--text2);
      border: 1px solid var(--border); border-radius: 8px;
      padding: 8px 14px; font-size: 12px; cursor: pointer;
      font-family: inherit; transition: all 0.15s;
      white-space: nowrap;
    }
    .voice-ctrl-btn:hover { border-color: var(--accent); color: var(--text); }
    .voice-ctrl-btn.on {
      background: rgba(88,166,255,.1); color: var(--accent);
      border-color: var(--accent);
    }
    .voice-mic-btn {
      width: 42px; height: 42px; border-radius: 50%;
      border: 2px solid var(--border); background: var(--bg3);
      cursor: pointer; font-size: 18px;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; flex-shrink: 0;
    }
    .voice-mic-btn:hover { border-color: var(--accent); }
    .voice-mic-btn.active {
      border-color: var(--green); background: rgba(63,185,80,.12);
    }
    .voice-mic-btn.speaking {
      border-color: var(--accent); background: rgba(88,166,255,.12);
    }
    .voice-mic-btn.processing {
      border-color: var(--purple); background: rgba(188,140,255,.12);
    }
    .voice-text-input {
      flex: 1; padding: 8px 12px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text);
      font-size: 13px; font-family: inherit; outline: none;
    }
    .voice-text-input:focus { border-color: var(--accent); }
    .voice-send-btn {
      background: var(--accent); color: #fff; border: none;
      border-radius: 8px; padding: 8px 14px;
      font-size: 14px; cursor: pointer;
    }
    .voice-send-btn:hover { opacity: 0.85; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <nav class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="brand"><em>B</em><span>astilon OS</span></div>
      <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar">&#9776;</button>
    </div>
    <div class="health-badge" id="health-badge">
      <span class="dot dot-green" id="dot-health"></span>
      <span id="health-text">Online</span>
    </div>
    <div class="xp-badge" id="xp-badge" onclick="navigate('overview')" title="Kingston XP">
      <div>
        <div class="xp-level" id="xp-level">--</div>
        <div class="xp-label">Kingston XP</div>
      </div>
      <div class="xp-points" id="xp-points">--</div>
    </div>

    <div class="nav-group-title">Chat</div>
    <a class="nav-item active" data-view="chat" onclick="navigate('chat')">
      <span class="nav-icon">&#128172;</span>
      <span class="nav-label">Chat</span>
    </a>

    <div class="nav-group-title">Control</div>
    <a class="nav-item" data-view="overview" onclick="navigate('overview')">
      <span class="nav-icon">&#9673;</span>
      <span class="nav-label">Overview</span>
    </a>
    <a class="nav-item" data-view="sessions" onclick="navigate('sessions')">
      <span class="nav-icon">&#128279;</span>
      <span class="nav-label">Sessions</span>
    </a>
    <a class="nav-item" data-view="scheduler" onclick="navigate('scheduler')">
      <span class="nav-icon">&#9200;</span>
      <span class="nav-label">Scheduler</span>
    </a>

    <div class="nav-group-title">Agents</div>
    <a class="nav-item" data-view="agents" onclick="navigate('agents')">
      <span class="nav-icon">&#129302;</span>
      <span class="nav-label">Agents</span>
      <span class="nav-badge" id="nav-agent-count">0</span>
    </a>
    <a class="nav-item" data-view="skills" onclick="navigate('skills')">
      <span class="nav-icon">&#128295;</span>
      <span class="nav-label">Skills</span>
      <span class="nav-badge" id="nav-skill-count">--</span>
    </a>
    <a class="nav-item" data-view="memory" onclick="navigate('memory')">
      <span class="nav-icon">&#129504;</span>
      <span class="nav-label">Memory</span>
    </a>

    <div class="nav-group-title">Media</div>
    <a class="nav-item" data-view="gallery" onclick="navigate('gallery')">
      <span class="nav-icon">&#128444;</span>
      <span class="nav-label">Gallery</span>
    </a>
    <a class="nav-item" data-view="dungeon" onclick="navigate('dungeon')">
      <span class="nav-icon">&#128009;</span>
      <span class="nav-label">Dungeon</span>
    </a>

    <div class="nav-group-title">Settings</div>
    <a class="nav-item" data-view="config" onclick="navigate('config')">
      <span class="nav-icon">&#9881;</span>
      <span class="nav-label">Config</span>
    </a>
    <a class="nav-item" data-view="logs" onclick="navigate('logs')">
      <span class="nav-icon">&#128220;</span>
      <span class="nav-label">Logs</span>
    </a>
    <a class="nav-item" data-view="debug" onclick="navigate('debug')">
      <span class="nav-icon">&#128027;</span>
      <span class="nav-label">Debug</span>
    </a>

    <div class="nav-group-title">Trading</div>
    <a class="nav-item" data-view="trading" onclick="navigate('trading')">
      <span class="nav-icon">&#128200;</span>
      <span class="nav-label">Portfolio</span>
    </a>
    <a class="nav-item" data-view="engagement" onclick="navigate('engagement')">
      <span class="nav-icon">&#128202;</span>
      <span class="nav-label">Engagement</span>
    </a>

    <a class="nav-item" data-view="llm-usage" onclick="navigate('llm-usage')">
      <span class="nav-icon">&#129689;</span>
      <span class="nav-label">LLM Usage</span>
    </a>

    <div class="nav-group-title">System</div>
    <a class="nav-item" data-view="system" onclick="navigate('system')">
      <span class="nav-icon">&#128187;</span>
      <span class="nav-label">OS Info</span>
    </a>
  </nav>

  <!-- Main Content -->
  <div class="main-content">
    <div class="rate-limit-banner" id="rate-banner">
      Rate limit actif — agents en pause jusqu'a <span id="rate-reset-time">--</span>
    </div>

    <!-- ═══ VIEW: Chat Media (center — chat itself is in right sidebar) ═══ -->
    <div class="view active" id="view-chat">
      <div class="view-header">
        Chat
        <button class="btn btn-sm btn-secondary" onclick="toggleChatSidebar()">&#9776; Toggle Chat</button>
      </div>
      <div class="view-body" id="chat-media-body">
        <div class="chat-media-placeholder" id="chat-media-placeholder">
          Images et medias des conversations apparaitront ici.<br>
          Clique sur une image dans le chat pour l'agrandir.
        </div>
        <div class="chat-media-grid" id="chat-media-grid"></div>
      </div>
    </div>

    <!-- ═══ VIEW: Overview ═══ -->
    <div class="view" id="view-overview">
      <div class="view-header">Overview <span style="font-size:12px;color:var(--text2);margin-left:12px;" id="overview-uptime"></span></div>
      <div class="view-body" id="overview-body"></div>
    </div>

    <!-- ═══ VIEW: Sessions ═══ -->
    <div class="view" id="view-sessions">
      <div class="view-header">Sessions CLI</div>
      <div class="view-body" id="sessions-body"></div>
    </div>

    <!-- ═══ VIEW: Scheduler ═══ -->
    <div class="view" id="view-scheduler">
      <div class="view-header">Scheduler</div>
      <div class="view-body" id="scheduler-body"></div>
    </div>

    <!-- ═══ VIEW: Agents ═══ -->
    <div class="view" id="view-agents">
      <div class="view-header">Agent Monitor</div>
      <div class="view-body" id="agents-body"></div>
    </div>

    <!-- ═══ VIEW: Skills ═══ -->
    <div class="view" id="view-skills">
      <div class="view-header">
        Skills Browser
        <span style="font-size:12px;color:var(--text2);" id="skills-total"></span>
      </div>
      <div class="view-body">
        <input class="search-box" id="skills-search" placeholder="Rechercher un skill..." oninput="filterSkills()">
        <div id="skills-container"></div>
      </div>
    </div>

    <!-- ═══ VIEW: Memory ═══ -->
    <div class="view" id="view-memory">
      <div class="view-header">Semantic Memory</div>
      <div class="view-body">
        <div class="cards-grid" id="memory-stats"></div>
        <div class="filter-bar" id="memory-filters"></div>
        <div id="memory-items"></div>
      </div>
    </div>

    <!-- ═══ VIEW: Config ═══ -->
    <div class="view" id="view-config">
      <div class="view-header">
        Configuration
        <button class="btn btn-sm" onclick="saveConfig()">Save & Reload</button>
      </div>
      <div class="view-body">
        <input class="search-box" id="config-search" placeholder="Rechercher..." oninput="filterConfig()">
        <div id="config-container"></div>
      </div>
    </div>

    <!-- ═══ VIEW: Logs ═══ -->
    <div class="view" id="view-logs">
      <div class="view-header">
        Live Logs
        <div style="display:flex;gap:8px;align-items:center;">
          <label style="font-size:12px;color:var(--text2);display:flex;align-items:center;gap:4px;">
            <input type="checkbox" id="log-autoscroll" checked> Auto-scroll
          </label>
          <select id="log-level-filter" onchange="filterLogs()" style="background:var(--bg3);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:3px 8px;font-size:12px;">
            <option value="all">Tous</option>
            <option value="info">Info+</option>
            <option value="warn">Warn+</option>
            <option value="error">Error</option>
          </select>
        </div>
      </div>
      <div class="log-viewer" id="log-viewer"></div>
    </div>

    <!-- ═══ VIEW: Debug ═══ -->
    <div class="view" id="view-debug">
      <div class="view-header">Debug</div>
      <div class="view-body" id="debug-body"></div>
    </div>

    <!-- ═══ VIEW: Trading ═══ -->
    <div class="view" id="view-trading">
      <div class="view-header">Trading Portfolio</div>
      <div class="view-body" id="trading-body" style="padding:16px;">
        <div id="trading-loading" style="color:var(--text2);">Loading...</div>
      </div>
    </div>

    <!-- ═══ VIEW: Engagement ═══ -->
    <div class="view" id="view-engagement">
      <div class="view-header">Engagement Dashboard</div>
      <div class="view-body" id="engagement-body" style="padding:16px;">
        <div id="engagement-loading" style="color:var(--text2);">Loading...</div>
      </div>
    </div>

    <!-- ═══ VIEW: LLM Usage ═══ -->
    <div class="view" id="view-llm-usage">
      <div class="view-header">LLM Token Usage & Cost</div>
      <div class="view-body" id="llm-usage-body" style="padding:16px;">
        <div class="cards-grid" id="llm-usage-today"></div>
        <div style="margin-top:20px;">
          <h3 style="font-size:14px;color:var(--text);margin-bottom:12px;">7-Day Trend</h3>
          <div id="llm-usage-chart" style="background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:16px;min-height:200px;"></div>
        </div>
        <div style="margin-top:20px;">
          <h3 style="font-size:14px;color:var(--text);margin-bottom:12px;">Detail by Provider</h3>
          <div id="llm-usage-table"></div>
        </div>
      </div>
    </div>

    <!-- ═══ VIEW: System ═══ -->
    <div class="view" id="view-system">
      <div class="view-header">System Information</div>
      <div class="view-body" id="system-body"></div>
    </div>

    <!-- ═══ VIEW: Gallery ═══ -->
    <div class="view" id="view-gallery">
      <div class="view-header">
        Gallery
        <span style="font-size:12px;color:var(--text2);margin-left:8px;" id="gallery-count"></span>
      </div>
      <div class="view-body" id="gallery-body" style="padding:16px;">
        <div class="gallery-grid" id="gallery-grid"></div>
        <div class="gallery-empty" id="gallery-empty" style="display:none;">
          <div style="font-size:48px;opacity:0.3;">&#128444;</div>
          <div style="font-size:14px;color:var(--text2);margin-top:8px;">Aucune image disponible</div>
        </div>
      </div>
    </div>

    <!-- Dungeon Master View -->
    <div class="view" id="view-dungeon">
      <div class="view-header">
        &#128009; Dungeon Master
        <span style="font-size:12px;color:var(--text2);margin-left:8px;" id="dungeon-session-name"></span>
        <a href="/dungeon.html" target="_blank" style="margin-left:auto;padding:6px 14px;background:linear-gradient(135deg,#d2aa4a,#b28a2e);color:#1b1a17;border-radius:6px;text-decoration:none;font-size:12px;font-weight:700;font-family:'Cinzel',serif;letter-spacing:0.5px;">&#9876; Mode Immersif</a>
      </div>
      <div class="view-body" id="dungeon-body" style="padding:0;display:flex;flex-direction:column;height:100%;">
        <!-- Session selector (shown when no active session) -->
        <div id="dungeon-selector" style="padding:16px;">
          <div style="display:flex;gap:12px;margin-bottom:16px;">
            <input id="dungeon-new-name" placeholder="Nom de la campagne..." style="flex:1;padding:8px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text1);font-size:13px;">
            <input id="dungeon-new-setting" placeholder="Setting (ex: Dark Fantasy)" style="flex:1;padding:8px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text1);font-size:13px;">
            <input id="dungeon-new-chars" placeholder="Personnages: Nom/Race/Classe, ..." style="flex:2;padding:8px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:6px;color:var(--text1);font-size:13px;" value="Aventurier/Humain/Guerrier">
            <button onclick="dungeonCreate()" style="padding:8px 16px;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Creer</button>
          </div>
          <div id="dungeon-sessions-list"></div>
        </div>
        <!-- Game layout (shown when session active) -->
        <div id="dungeon-game" style="display:none;flex:1;overflow:hidden;">
          <div style="display:flex;height:100%;">
            <!-- Left: Party panel -->
            <div id="dungeon-party" style="width:220px;border-right:1px solid var(--border);overflow-y:auto;padding:12px;flex-shrink:0;">
              <div style="font-weight:700;font-size:13px;margin-bottom:12px;color:var(--accent);">Groupe</div>
              <div id="dungeon-characters"></div>
              <div style="margin-top:16px;border-top:1px solid var(--border);padding-top:12px;">
                <div style="font-weight:700;font-size:12px;margin-bottom:8px;color:var(--text2);">Dice Roller</div>
                <div style="display:flex;flex-wrap:wrap;gap:4px;" id="dungeon-dice-buttons">
                  <button onclick="dungeonQuickRoll('d4')" style="padding:4px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text1);cursor:pointer;font-size:11px;">d4</button>
                  <button onclick="dungeonQuickRoll('d6')" style="padding:4px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text1);cursor:pointer;font-size:11px;">d6</button>
                  <button onclick="dungeonQuickRoll('d8')" style="padding:4px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text1);cursor:pointer;font-size:11px;">d8</button>
                  <button onclick="dungeonQuickRoll('d10')" style="padding:4px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text1);cursor:pointer;font-size:11px;">d10</button>
                  <button onclick="dungeonQuickRoll('d12')" style="padding:4px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text1);cursor:pointer;font-size:11px;">d12</button>
                  <button onclick="dungeonQuickRoll('d20')" style="padding:6px 10px;background:var(--accent);border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:12px;font-weight:700;">d20</button>
                  <button onclick="dungeonQuickRoll('2d6')" style="padding:4px 8px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text1);cursor:pointer;font-size:11px;">2d6</button>
                </div>
                <div id="dungeon-roll-result" style="margin-top:8px;font-size:12px;color:var(--text2);min-height:20px;"></div>
              </div>
              <div style="margin-top:12px;">
                <button onclick="dungeonBackToSessions()" style="width:100%;padding:6px;background:var(--bg2);border:1px solid var(--border);border-radius:4px;color:var(--text2);cursor:pointer;font-size:11px;">&#8592; Campagnes</button>
              </div>
            </div>
            <!-- Center: Narrative chat -->
            <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
              <div id="dungeon-narrative" style="flex:1;overflow-y:auto;padding:16px;"></div>
              <div style="padding:12px;border-top:1px solid var(--border);display:flex;gap:8px;">
                <input id="dungeon-action-input" placeholder="Ton action..." style="flex:1;padding:10px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text1);font-size:13px;" onkeydown="if(event.key==='Enter')dungeonPlay()">
                <button onclick="dungeonPlay()" id="dungeon-play-btn" style="padding:10px 20px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;">Jouer</button>
                <button onclick="dungeonGenerateScene()" title="Generer image de scene" style="padding:10px 12px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;color:var(--text1);cursor:pointer;font-size:15px;">&#127912;</button>
              </div>
            </div>
            <!-- Right: Scene images -->
            <div id="dungeon-scenes" style="width:260px;border-left:1px solid var(--border);overflow-y:auto;padding:12px;flex-shrink:0;">
              <div style="font-weight:700;font-size:13px;margin-bottom:12px;color:var(--accent);">Scenes</div>
              <div id="dungeon-scene-main" style="margin-bottom:12px;"></div>
              <div id="dungeon-scene-gallery" style="display:flex;flex-wrap:wrap;gap:4px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Chat Sidebar (always visible on all views) -->
  <aside class="chat-sidebar" id="chat-sidebar">
    <div class="chat-sidebar-collapsed-icon" onclick="toggleChatSidebar()" title="Ouvrir le chat">
      &#128172;
      <span class="cs-badge" id="cs-unread-badge"></span>
    </div>
    <div class="chat-sidebar-header">
      <span class="cs-title">Chat</span>
      <button class="chat-sidebar-toggle-btn" onclick="toggleChatSidebar()" title="Reduire">&#9666;</button>
    </div>
    <div class="chat-sidebar-body">
      <div class="chat-tabs">
        <div class="chat-tab active" data-tab="kingston" onclick="switchTab('kingston')">Kingston</div>
        <div class="chat-tab emile" data-tab="emile" onclick="switchTab('emile')">Emile</div>
        <div class="chat-tab" data-tab="aster" onclick="switchTab('aster')">Aster</div>
        <div class="chat-tab" data-tab="conseil" onclick="switchTab('conseil')"
          style="background:linear-gradient(135deg,rgba(88,166,255,.05),rgba(188,140,255,.05));">
          Conseil
        </div>
      </div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="continue-bar" id="continue-bar" style="display:none;">
        <button class="continue-kingston" onclick="continueDialogue('kingston')" id="cont-kingston">Kingston repond</button>
        <button class="continue-emile" onclick="continueDialogue('emile')" id="cont-emile">Emile repond</button>
        <button class="continue-both" onclick="continueDialogue('both')" id="cont-both">Relancer le dialogue</button>
        <button onclick="stopConseil()" id="cont-stop" style="display:none;border-color:var(--red);color:var(--red);">Stop</button>
        <span style="font-size:11px;color:var(--text2);align-self:center;" id="rounds-label"></span>
      </div>
      <div class="chat-input-area">
        <div class="chat-controls">
          <select id="direct-target" onchange="updateDirectTargetUi()">
            <option value="active">Onglet actif</option>
            <option value="kingston">Kingston</option>
            <option value="emile">Emile</option>
            <option value="both">Kingston + Emile</option>
          </select>
          <input id="auth-token" type="password" placeholder="Token (optionnel)">
          <button class="secondary" onclick="saveAuthToken()">Token</button>
          <button class="secondary" onclick="resetSessions()">Reset</button>
        </div>
        <textarea id="chat-input" rows="1" placeholder="Parle a Kingston..."
          onkeydown="handleKeyDown(event)"></textarea>
        <button id="send-btn" onclick="sendMessage()">Envoyer</button>
      </div>
    </div>
  </aside>

  <!-- Image preview overlay -->
  <div class="gallery-preview-overlay" id="gallery-preview-overlay" onclick="closeGalleryPreview()">
    <div class="gallery-preview-content" onclick="event.stopPropagation()">
      <img id="gallery-preview-img" src="" alt="Preview">
      <div class="gallery-preview-info" id="gallery-preview-info"></div>
      <button class="gallery-preview-close" onclick="closeGalleryPreview()">&#10005;</button>
    </div>
  </div>

  <!-- Voice Sidebar (right) — always visible on all views -->
  <aside class="voice-sidebar" id="voice-sidebar">
    <button class="voice-sidebar-toggle" onclick="toggleVoiceSidebar()" title="Toggle voice">&#9666;</button>
    <div class="kingston-avatar" id="kingston-avatar">
      <div class="kingston-orb" id="kingston-orb" data-state="off">&#9775;</div>
      <div class="kingston-avatar-label">Kingston</div>
      <div class="kingston-avatar-status" id="kingston-avatar-status">Inactif</div>
    </div>
    <div class="voice-transcript" id="voice-transcript">
      <div class="voice-msg voice-msg-system">Dis "Computer" ou clique le micro pour commencer.</div>
    </div>
    <div class="voice-wake-bar" id="voice-wake-bar">
      <span id="voice-wake-text">Ecoute...</span>
    </div>
    <div class="voice-controls-bar">
      <button class="voice-ctrl-btn" id="voice-wake-toggle" title="Wake word Computer">&#128276; Computer</button>
      <button class="voice-ctrl-btn" id="voice-mode-toggle" title="Changer mode: Local (Ollama) / Cloud (Gemini Live)" style="font-size:11px;padding:6px 8px;">&#9729; Local</button>
      <button class="voice-mic-btn" id="voice-mic-btn" title="Micro">&#127908;</button>
      <input class="voice-text-input" id="voice-text-input" type="text" placeholder="Message..." />
      <button class="voice-send-btn" id="voice-send-btn" title="Envoyer">&#10148;</button>
    </div>
  </aside>

  <!-- Floating voice toggle (visible when sidebar collapsed/responsive) -->
  <button class="voice-float-toggle" id="voice-float-toggle" onclick="toggleVoiceSidebar()">&#127908;</button>

<script>
// ══════════════════════════════════════════════════════════════
// State
// ══════════════════════════════════════════════════════════════
let currentView = 'chat';
let activeTab = 'kingston';
let ws = null;
let typingSeq = 0;
const CHAT_TIMEOUT_MS = 300000; // 5min — tool chains can be long
const AUTH_TOKEN_STORAGE_KEY = 'dashboard_auth_token';
let authToken = '';
let allSkills = [];
let allConfig = {};
let allLogLines = [];
let logAutoScroll = true;
let memoryFilter = 'all';

const chatHistory = { kingston: [], emile: [], aster: [], conseil: [] };

// ══════════════════════════════════════════════════════════════
// Navigation
// ══════════════════════════════════════════════════════════════
function navigate(view) {
  currentView = view;
  location.hash = view;
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const viewEl = document.getElementById('view-' + view);
  const navEl = document.querySelector(`.nav-item[data-view="${view}"]`);
  if (viewEl) viewEl.classList.add('active');
  if (navEl) navEl.classList.add('active');
  // Load data for view
  loadView(view);
}

function loadView(view) {
  switch(view) {
    case 'chat': refreshChatMedia(); break;
    case 'overview': loadOverview(); break;
    case 'sessions': loadSessions(); break;
    case 'scheduler': loadScheduler(); break;
    case 'agents': loadAgents(); break;
    case 'skills': loadSkills(); break;
    case 'memory': loadMemory(); break;
    case 'config': loadConfig(); break;
    case 'logs': loadLogs(); break;
    case 'debug': loadDebug(); break;
    case 'system': loadSystem(); break;
    case 'trading': loadTrading(); break;
    case 'engagement': loadEngagement(); break;
    case 'llm-usage': loadLLMUsage(); break;
    case 'gallery': loadGallery(); break;
    case 'dungeon': loadDungeon(); break;
  }
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
}

function toggleChatSidebar() {
  const cs = document.getElementById('chat-sidebar');
  cs.classList.toggle('collapsed');
  localStorage.setItem('chat_sidebar_collapsed', cs.classList.contains('collapsed'));
}

// Show an image from chat in the center media viewer
function showInMediaViewer(src) {
  navigate('chat');
  const grid = document.getElementById('chat-media-grid');
  const placeholder = document.getElementById('chat-media-placeholder');
  if (placeholder) placeholder.style.display = 'none';
  // Check if already shown
  const existing = grid.querySelector(`img[src="${src}"]`);
  if (!existing) {
    const img = document.createElement('img');
    img.src = src;
    img.onclick = () => openGalleryPreview(src);
    grid.appendChild(img);
  }
}

// Collect all images from chat history into the media grid
function refreshChatMedia() {
  const grid = document.getElementById('chat-media-grid');
  const placeholder = document.getElementById('chat-media-placeholder');
  if (!grid) return;
  grid.innerHTML = '';
  let hasImages = false;
  for (const tab of Object.values(chatHistory)) {
    for (const msg of tab) {
      if (!msg.content) continue;
      const imgRegex = /(?:!\[[^\]]*\]\(([^)]+)\)|(?:https?:\/\/[^\s]+\.(?:png|jpg|jpeg|gif|webp)(?:\?[^\s]*)?)|((?:uploads|images)\/[^\s"']+\.(?:png|jpg|jpeg|gif|webp)))/gi;
      let match;
      while ((match = imgRegex.exec(msg.content)) !== null) {
        const src = match[1] || match[0];
        if (src) {
          hasImages = true;
          const img = document.createElement('img');
          img.src = src.startsWith('http') ? src : '/' + src;
          img.onclick = () => openGalleryPreview(img.src, 'Chat Image', '');
          img.loading = 'lazy';
          grid.appendChild(img);
        }
      }
    }
  }
  if (placeholder) placeholder.style.display = hasImages ? 'none' : 'block';
}

// ══════════════════════════════════════════════════════════════
// WebSocket
// ══════════════════════════════════════════════════════════════
function connectWS() {
  const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${protocol}//${location.host}/ws`);
  ws.onopen = () => {
    document.getElementById('dot-health').className = 'dot dot-green';
    document.getElementById('health-text').textContent = 'Online';
  };
  ws.onclose = () => {
    document.getElementById('dot-health').className = 'dot dot-red';
    document.getElementById('health-text').textContent = 'Offline';
    setTimeout(connectWS, 3000);
  };
  ws.onmessage = (event) => {
    const msg = JSON.parse(event.data);
    if (msg.event === 'init') {
      const agents = msg.data.agents || [];
      document.getElementById('nav-agent-count').textContent = agents.filter(a => a.status === 'idle' || a.status === 'running').length;
    } else if (msg.event === 'log') {
      appendLogLine(msg.data);
    } else if (msg.event === 'agent_run' && currentView === 'agents') {
      loadAgents();
    }
  };
}

// ══════════════════════════════════════════════════════════════
// API
// ══════════════════════════════════════════════════════════════
function getAuthHeaders(base = {}) {
  if (!authToken) return base;
  return { ...base, 'X-Auth-Token': authToken };
}

async function api(path) {
  const res = await fetch(`/api/${path}`, {
    headers: getAuthHeaders(),
  });
  const ct = res.headers.get('content-type') || '';
  let data = ct.includes('json') ? await res.json() : { ok: false, error: await res.text() };
  if (!res.ok || data.ok === false) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

async function postApi(path, body) {
  const res = await fetch(`/api/${path}`, {
    method: 'POST',
    headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
    body: JSON.stringify(body),
  });
  const ct = res.headers.get('content-type') || '';
  let data = ct.includes('json') ? await res.json() : { ok: false, error: await res.text() };
  if (!res.ok || data.ok === false) throw new Error(data.error || `HTTP ${res.status}`);
  return data;
}

async function postChat(agent, message) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), CHAT_TIMEOUT_MS);
  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ agent, message }),
      signal: controller.signal,
    });
    const ct = res.headers.get('content-type') || '';
    let data = ct.includes('json') ? await res.json() : { ok: false, error: await res.text() };
    if (!res.ok || data.ok === false) throw new Error(data.error || `HTTP ${res.status}`);
    return data.response || 'No response.';
  } catch (err) {
    if (err && err.name === 'AbortError') throw new Error('Timeout 5min');
    throw err;
  } finally {
    clearTimeout(timeout);
  }
}

async function postChatStream(message, onProgress) {
  const controller = new AbortController();
  const timeout = setTimeout(() => controller.abort(), CHAT_TIMEOUT_MS);
  try {
    const res = await fetch('/api/chat/kingston/stream', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ message }),
      signal: controller.signal,
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let finalResponse = '';
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream: true });
      const lines = buffer.split('\n');
      buffer = lines.pop() || '';
      let eventType = '';
      for (const line of lines) {
        if (line.startsWith('event: ')) {
          eventType = line.slice(7).trim();
        } else if (line.startsWith('data: ')) {
          const raw = line.slice(6);
          try {
            const data = JSON.parse(raw);
            if (eventType === 'progress' && onProgress) {
              onProgress(data.tool, data.status, data.detail);
            } else if (eventType === 'done') {
              finalResponse = data.response || '';
            } else if (eventType === 'error') {
              throw new Error(data.error || 'Stream error');
            }
          } catch (e) {
            if (e.message && !e.message.includes('JSON')) throw e;
          }
          eventType = '';
        }
      }
    }
    return finalResponse || 'No response.';
  } catch (err) {
    if (err && err.name === 'AbortError') throw new Error('Timeout 5min');
    throw err;
  } finally {
    clearTimeout(timeout);
  }
}

// ══════════════════════════════════════════════════════════════
// VIEW: Overview
// ══════════════════════════════════════════════════════════════
async function loadOverview() {
  try {
    const [stats, agents, memStats, xp] = await Promise.all([
      api('stats'), api('agents'), api('memory/stats').catch(() => ({ total: 0 })),
      api('xp').catch(() => ({ totalXp: 0, level: 'Apprenti', nextLevel: null }))
    ]);
    const el = document.getElementById('overview-body');
    document.getElementById('overview-uptime').textContent = 'Uptime: ' + formatDuration(stats.uptime);

    // Rate limit
    const banner = document.getElementById('rate-banner');
    if (agents.rateLimited) {
      banner.classList.add('visible');
      document.getElementById('rate-reset-time').textContent = new Date(agents.rateLimitReset).toLocaleTimeString('fr-CA');
    } else {
      banner.classList.remove('visible');
    }

    const totalRuns = (stats.agentStats || []).reduce((s, a) => s + a.total, 0);
    const totalErrors = (stats.agentStats || []).reduce((s, a) => s + a.errors, 0);
    const activeAgents = (agents.agents || []).filter(a => a.status === 'idle' || a.status === 'running').length;

    // Update sidebar XP badge
    updateXpBadge(xp);

    // XP calculations
    const xpTotal = xp.totalXp || 0;
    const xpLevel = xp.level || 'Apprenti';
    const xpToday = xp.todayXp || 0;
    const xpNext = xp.nextLevel;
    const xpProgressPct = xpNext ? Math.min(100, Math.round((xpTotal / xpNext.threshold) * 100)) : 100;
    const xpLevelColor = xpLevel === 'Architecte' ? 'var(--orange)' : xpLevel === 'Autonome' ? 'var(--purple)' : xpLevel === 'Operateur' ? 'var(--accent)' : 'var(--text2)';

    // Recent XP history rows
    const xpHistoryHtml = (xp.history || []).slice(0, 8).map(h => {
      const sign = h.points > 0 ? '+' : '';
      const color = h.points > 0 ? 'var(--green)' : 'var(--red)';
      const time = new Date(h.created_at * 1000).toLocaleDateString('fr-CA', { month: 'short', day: 'numeric' });
      return '<tr><td style="color:' + color + ';font-weight:600;">' + sign + h.points + '</td><td>' + escapeHtml(h.event_type.replace(/_/g, ' ')) + '</td><td style="color:var(--text2);font-size:12px;">' + escapeHtml((h.reason || '').slice(0, 60)) + '</td><td style="color:var(--text2);font-size:11px;">' + time + '</td></tr>';
    }).join('');

    el.innerHTML = `
      <div class="cards-grid">
        <div class="card" style="border:1px solid ${xpLevelColor};background:linear-gradient(135deg, var(--bg3), rgba(88,166,255,.06));">
          <div class="card-title" style="color:${xpLevelColor};font-weight:700;">Kingston XP</div>
          <div class="card-value" style="color:${xpLevelColor};font-size:32px;">${xpTotal}</div>
          <div style="margin:6px 0 4px;background:var(--bg);border-radius:4px;height:6px;overflow:hidden;">
            <div style="height:100%;width:${xpProgressPct}%;background:${xpLevelColor};border-radius:4px;transition:width 0.3s;"></div>
          </div>
          <div class="card-sub" style="color:${xpLevelColor};">${xpLevel}${xpNext ? ' &rarr; ' + escapeHtml(xpNext.name) + ' (' + xpNext.remaining + ' restants)' : ' (MAX)'}</div>
          <div class="card-sub">Aujourd'hui: ${xpToday > 0 ? '+' : ''}${xpToday} | ${xp.totalEvents || 0} events</div>
        </div>
        <div class="card">
          <div class="card-title">Agents actifs</div>
          <div class="card-value">${activeAgents}</div>
          <div class="card-sub">${(agents.agents || []).length} total</div>
        </div>
        <div class="card">
          <div class="card-title">Runs (24h)</div>
          <div class="card-value">${totalRuns}</div>
        </div>
        <div class="card">
          <div class="card-title">Erreurs (24h)</div>
          <div class="card-value" style="color:${totalErrors > 0 ? 'var(--red)' : 'var(--green)'}">${totalErrors}</div>
          <div class="card-sub">${stats.errorCount} non resolues</div>
        </div>
        <div class="card">
          <div class="card-title">RAM (heap)</div>
          <div class="card-value">${stats.memory?.heap || '--'}<span style="font-size:14px;color:var(--text2);">MB</span></div>
        </div>
        <div class="card">
          <div class="card-title">Notes</div>
          <div class="card-value">${stats.noteCount || 0}</div>
        </div>
        <div class="card">
          <div class="card-title">Memories</div>
          <div class="card-value">${memStats.total || 0}</div>
        </div>
        <div class="card">
          <div class="card-title">WS Clients</div>
          <div class="card-value">${stats.wsClients || 0}</div>
        </div>
        <div class="card">
          <div class="card-title">Skills</div>
          <div class="card-value" id="overview-skills">--</div>
        </div>
      </div>
      ${xpHistoryHtml ? '<h3 style="margin:16px 0 8px;font-size:14px;">XP Recent</h3><table class="data-table"><tr><th>XP</th><th>Event</th><th>Raison</th><th>Date</th></tr>' + xpHistoryHtml + '</table>' : ''}
      <h3 style="margin-bottom:12px;font-size:14px;">Agents</h3>
      <table class="data-table">
        <tr><th>Agent</th><th>Status</th><th>Cycle</th><th>Runs</th><th>Errors</th><th>Dernier</th></tr>
        ${(agents.agents || []).map(a => `
          <tr>
            <td style="font-weight:600;">${escapeHtml(a.name)}</td>
            <td><span class="badge-sm badge-${statusBadge(a.status)}">${escapeHtml(a.status)}</span></td>
            <td>${a.cycle}</td>
            <td>${a.totalRuns}</td>
            <td style="color:${a.consecutiveErrors > 0 ? 'var(--red)' : 'var(--text2)'}">${a.consecutiveErrors}</td>
            <td style="color:var(--text2);font-size:12px;">${a.lastRunAt ? new Date(a.lastRunAt * 1000).toLocaleTimeString('fr-CA') : 'jamais'}</td>
          </tr>
        `).join('')}
      </table>
    `;
    // Load skills count
    api('skills').then(s => {
      document.getElementById('overview-skills').textContent = s.length;
      document.getElementById('nav-skill-count').textContent = s.length;
    }).catch(() => {});
  } catch (err) {
    document.getElementById('overview-body').innerHTML = `<p style="color:var(--red);">Erreur: ${err.message}</p>`;
  }
}

// ══════════════════════════════════════════════════════════════
// VIEW: Sessions
// ══════════════════════════════════════════════════════════════
async function loadSessions() {
  try {
    const data = await api('sessions');
    document.getElementById('sessions-body').innerHTML = `
      <table class="data-table">
        <tr><th>Chat ID</th><th>Label</th><th>Turns</th></tr>
        ${data.map(s => `
          <tr>
            <td style="font-family:monospace;">${s.chatId}</td>
            <td>${escapeHtml(s.label)}</td>
            <td>${s.turns}</td>
          </tr>
        `).join('')}
      </table>
    `;
  } catch (err) {
    document.getElementById('sessions-body').innerHTML = `<p style="color:var(--red);">${err.message}</p>`;
  }
}

// ══════════════════════════════════════════════════════════════
// VIEW: Scheduler
// ══════════════════════════════════════════════════════════════
async function loadScheduler() {
  try {
    const data = await api('scheduler');
    const el = document.getElementById('scheduler-body');
    el.innerHTML = `
      <h3 style="margin-bottom:12px;font-size:14px;">Reminders</h3>
      <table class="data-table">
        <tr><th>ID</th><th>Message</th><th>Fire At</th></tr>
        ${(data.reminders || []).map(r => `
          <tr>
            <td>${r.id}</td>
            <td>${escapeHtml(r.message || '')}</td>
            <td>${new Date(r.fire_at * 1000).toLocaleString('fr-CA')}</td>
          </tr>
        `).join('') || '<tr><td colspan="3" style="color:var(--text2)">Aucun reminder</td></tr>'}
      </table>
      <h3 style="margin:20px 0 12px;font-size:14px;">Recent Runs</h3>
      <table class="data-table">
        <tr><th>Event</th><th>Last Run</th></tr>
        ${(data.recent || []).map(r => `
          <tr>
            <td style="font-family:monospace;">${escapeHtml(r.event_key || '')}</td>
            <td>${new Date(r.last_run_at * 1000).toLocaleString('fr-CA')}</td>
          </tr>
        `).join('') || '<tr><td colspan="2" style="color:var(--text2)">Aucun run</td></tr>'}
      </table>
    `;
  } catch (err) {
    document.getElementById('scheduler-body').innerHTML = `<p style="color:var(--red);">${err.message}</p>`;
  }
}

// ══════════════════════════════════════════════════════════════
// VIEW: Agents
// ══════════════════════════════════════════════════════════════
async function loadAgents() {
  try {
    const data = await api('agents');
    const agents = data.agents || [];
    document.getElementById('nav-agent-count').textContent = agents.filter(a => a.status === 'idle' || a.status === 'running').length;

    let html = '<div class="cards-grid">';
    for (const a of agents) {
      const nextRun = a.lastRunAt ? formatCountdown(a.lastRunAt * 1000 + a.heartbeatMs - Date.now()) : '--';
      const lastRun = a.lastRunAt ? new Date(a.lastRunAt * 1000).toLocaleTimeString('fr-CA') : 'jamais';
      html += `
        <div class="card" style="cursor:pointer;" onclick="loadAgentRuns('${a.id}')">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="font-weight:700;font-size:15px;"><span class="dot dot-${statusColor(a.status)}"></span> ${escapeHtml(a.name)}</span>
            <span class="badge-sm badge-${statusBadge(a.status)}">${escapeHtml(a.status)}</span>
          </div>
          <div style="font-size:12px;color:var(--text2);line-height:1.8;">
            Cycle: ${a.cycle} &bull; Runs: ${a.totalRuns} &bull; Errors: ${a.consecutiveErrors}<br>
            Dernier: ${lastRun} &bull; Prochain: ${nextRun}
          </div>
        </div>
      `;
    }
    html += '</div>';
    html += '<div id="agent-runs-detail"></div>';
    document.getElementById('agents-body').innerHTML = html;
  } catch (err) {
    document.getElementById('agents-body').innerHTML = `<p style="color:var(--red);">${err.message}</p>`;
  }
}

async function loadAgentRuns(agentId) {
  try {
    const runs = await api(`agents/${agentId}/runs`);
    const el = document.getElementById('agent-runs-detail');
    el.innerHTML = `
      <h3 style="margin:16px 0 12px;font-size:14px;">${agentId} — Recent Runs</h3>
      <table class="data-table">
        <tr><th>Cycle</th><th>Outcome</th><th>Duration</th><th>Started</th><th>Error</th></tr>
        ${runs.slice(0, 30).map(r => `
          <tr>
            <td>${r.cycle}</td>
            <td><span class="badge-sm badge-${r.outcome === 'success' ? 'green' : r.outcome === 'error' ? 'red' : 'yellow'}">${r.outcome}</span></td>
            <td>${r.duration_ms ? (r.duration_ms / 1000).toFixed(1) + 's' : '--'}</td>
            <td style="font-size:12px;">${new Date(r.started_at * 1000).toLocaleString('fr-CA')}</td>
            <td style="font-size:11px;color:var(--red);">${escapeHtml((r.error_msg || '').slice(0, 60))}</td>
          </tr>
        `).join('')}
      </table>
    `;
  } catch {}
}

// ══════════════════════════════════════════════════════════════
// VIEW: Skills
// ══════════════════════════════════════════════════════════════
async function loadSkills() {
  if (allSkills.length === 0) {
    try {
      allSkills = await api('skills');
    } catch { allSkills = []; }
  }
  document.getElementById('skills-total').textContent = `${allSkills.length} skills`;
  document.getElementById('nav-skill-count').textContent = allSkills.length;
  renderSkills(allSkills);
}

function filterSkills() {
  const q = (document.getElementById('skills-search').value || '').toLowerCase();
  const filtered = q ? allSkills.filter(s =>
    s.name.toLowerCase().includes(q) || s.description.toLowerCase().includes(q)
  ) : allSkills;
  renderSkills(filtered);
}

function renderSkills(skills) {
  // Group by namespace
  const groups = {};
  for (const s of skills) {
    const ns = s.name.split('.')[0];
    if (!groups[ns]) groups[ns] = [];
    groups[ns].push(s);
  }
  const sorted = Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]));

  let html = '';
  for (const [ns, items] of sorted) {
    html += `<div class="ns-group">`;
    html += `<div class="ns-title">${ns} <span style="color:var(--text2);font-weight:400;font-size:12px;">(${items.length})</span></div>`;
    for (const s of items) {
      const argStr = s.args.length > 0
        ? s.args.map(a => `${a.required ? '' : '?'}${a.name}:${a.type}`).join(', ')
        : '';
      html += `
        <div class="skill-row">
          <span class="skill-name">${escapeHtml(s.name)}${s.adminOnly ? ' <span class="badge-sm badge-red">admin</span>' : ''}</span>
          <span class="skill-desc">${escapeHtml(s.description)}</span>
          <span class="skill-args">${escapeHtml(argStr)}</span>
        </div>
      `;
    }
    html += '</div>';
  }
  document.getElementById('skills-container').innerHTML = html;
}

// ══════════════════════════════════════════════════════════════
// VIEW: Memory
// ══════════════════════════════════════════════════════════════
async function loadMemory() {
  try {
    const [stats, items] = await Promise.all([
      api('memory/stats'),
      api('memory/items'),
    ]);
    // Stats cards
    const cats = stats.byCategory || {};
    let statsHtml = `
      <div class="card"><div class="card-title">Total</div><div class="card-value">${stats.total}</div></div>
      <div class="card"><div class="card-title">Avg Salience</div><div class="card-value">${(stats.avgSalience || 0).toFixed(2)}</div></div>
    `;
    for (const [cat, count] of Object.entries(cats)) {
      statsHtml += `<div class="card"><div class="card-title">${cat}</div><div class="card-value">${count}</div></div>`;
    }
    document.getElementById('memory-stats').innerHTML = statsHtml;

    // Filter buttons
    const allCats = ['all', ...Object.keys(cats)];
    document.getElementById('memory-filters').innerHTML = allCats.map(c =>
      `<button class="filter-btn ${memoryFilter === c ? 'active' : ''}" onclick="setMemoryFilter('${c}')">${c}</button>`
    ).join('');

    // Items
    renderMemoryItems(items);
  } catch (err) {
    document.getElementById('memory-stats').innerHTML = `<p style="color:var(--red);">${err.message}</p>`;
  }
}

function setMemoryFilter(cat) {
  memoryFilter = cat;
  loadMemory();
}

function renderMemoryItems(items) {
  const filtered = memoryFilter === 'all' ? items : items.filter(i => i.category === memoryFilter);
  document.getElementById('memory-items').innerHTML = filtered.map(m => `
    <div class="mem-item">
      <span class="mem-cat mem-cat-${m.category}">${m.category}</span>
      <strong style="font-size:12px;">${(m.salience || 0).toFixed(2)}</strong>
      <span style="color:var(--text2);font-size:11px;margin-left:8px;">x${m.access_count || 0}</span>
      <div style="margin-top:4px;color:var(--text);font-size:13px;">${escapeHtml((m.content || '').slice(0, 200))}</div>
    </div>
  `).join('') || '<p style="color:var(--text2);">Aucune memoire.</p>';
}

// ══════════════════════════════════════════════════════════════
// VIEW: Config
// ══════════════════════════════════════════════════════════════
async function loadConfig() {
  try {
    allConfig = await api('config');
    renderConfig(allConfig);
  } catch (err) {
    document.getElementById('config-container').innerHTML = `<p style="color:var(--red);">${err.message}</p>`;
  }
}

function filterConfig() {
  const q = (document.getElementById('config-search').value || '').toLowerCase();
  const filtered = {};
  for (const [k, v] of Object.entries(allConfig)) {
    if (k.toLowerCase().includes(q) || String(v).toLowerCase().includes(q)) {
      filtered[k] = v;
    }
  }
  renderConfig(filtered);
}

function renderConfig(cfg) {
  const secretKeys = new Set([
    'telegramToken', 'geminiApiKey', 'anthropicApiKey', 'twilioAuthToken',
    'deepgramApiKey', 'elevenlabsApiKey', 'adminPassphrase', 'braveSearchApiKey', 'dashboardToken'
  ]);
  let html = '';
  for (const [key, val] of Object.entries(cfg)) {
    const isSecret = secretKeys.has(key);
    const displayVal = typeof val === 'object' ? JSON.stringify(val) : String(val);
    html += `
      <div class="config-row">
        <span class="config-key">${key}</span>
        <input class="config-val${isSecret ? ' secret' : ''}"
          data-key="${key}" value="${escapeHtml(displayVal)}"
          ${isSecret ? 'disabled title="Secret — cannot be edited via dashboard"' : ''}>
      </div>
    `;
  }
  document.getElementById('config-container').innerHTML = html;
}

async function saveConfig() {
  const inputs = document.querySelectorAll('.config-val:not([disabled])');
  const updates = {};
  for (const input of inputs) {
    const key = input.dataset.key;
    const origVal = allConfig[key];
    const newVal = input.value;
    if (String(origVal) !== newVal) {
      // Map camelCase config key to UPPER_SNAKE env key
      const envKey = key.replace(/([A-Z])/g, '_$1').toUpperCase();
      updates[envKey] = newVal;
    }
  }
  if (Object.keys(updates).length === 0) {
    alert('Aucun changement detecte.');
    return;
  }
  try {
    await postApi('config', updates);
    alert('Config sauvegardee et rechargee!');
    loadConfig();
  } catch (err) {
    alert('Erreur: ' + err.message);
  }
}

// ══════════════════════════════════════════════════════════════
// VIEW: Logs
// ══════════════════════════════════════════════════════════════
async function loadLogs() {
  try {
    const logs = await api('logs');
    allLogLines = logs;
    renderLogs();
  } catch (err) {
    document.getElementById('log-viewer').textContent = 'Error: ' + err.message;
  }
}

function appendLogLine(data) {
  allLogLines.push(data);
  if (allLogLines.length > 500) allLogLines.shift();
  if (currentView === 'logs') {
    const viewer = document.getElementById('log-viewer');
    const levelFilter = document.getElementById('log-level-filter').value;
    if (shouldShowLog(data.level, levelFilter)) {
      const div = document.createElement('div');
      div.className = 'log-line log-' + data.level;
      div.textContent = data.message;
      viewer.appendChild(div);
      if (document.getElementById('log-autoscroll').checked) {
        viewer.scrollTop = viewer.scrollHeight;
      }
    }
  }
}

function filterLogs() { renderLogs(); }

function shouldShowLog(level, filter) {
  if (filter === 'all') return true;
  const levels = { debug: 0, info: 1, warn: 2, error: 3 };
  return (levels[level] || 0) >= (levels[filter] || 0);
}

function renderLogs() {
  const viewer = document.getElementById('log-viewer');
  const filter = document.getElementById('log-level-filter').value;
  const filtered = allLogLines.filter(l => shouldShowLog(l.level, filter));
  viewer.innerHTML = filtered.map(l =>
    `<div class="log-line log-${l.level}">${escapeHtml(l.message)}</div>`
  ).join('');
  if (document.getElementById('log-autoscroll').checked) {
    viewer.scrollTop = viewer.scrollHeight;
  }
}

// ══════════════════════════════════════════════════════════════
// VIEW: Debug
// ══════════════════════════════════════════════════════════════
async function loadDebug() {
  try {
    const [stats, errors, learning] = await Promise.all([
      api('stats'), api('errors'), api('learning').catch(() => null)
    ]);
    let html = `
      <div class="cards-grid">
        <div class="card">
          <div class="card-title">WS Clients</div>
          <div class="card-value">${stats.wsClients}</div>
        </div>
        <div class="card">
          <div class="card-title">Heap Used</div>
          <div class="card-value">${stats.memory?.heap}MB</div>
        </div>
        <div class="card">
          <div class="card-title">RSS</div>
          <div class="card-value">${stats.memory?.rss}MB</div>
        </div>
        <div class="card">
          <div class="card-title">Rate Limited</div>
          <div class="card-value" style="color:${stats.rateLimited ? 'var(--red)' : 'var(--green)'}">${stats.rateLimited ? 'OUI' : 'Non'}</div>
        </div>
      </div>
    `;
    // Learning insights
    if (learning && learning.summary) {
      const s = learning.summary;
      html += `
        <h3 style="margin:16px 0 12px;font-size:14px;">Learning Patterns</h3>
        <div class="cards-grid">
          <div class="card"><div class="card-title">Patterns</div><div class="card-value">${s.totalPatterns}</div></div>
          <div class="card"><div class="card-title">Graduated</div><div class="card-value" style="color:var(--purple)">${s.graduatedRules}</div></div>
          <div class="card"><div class="card-title">Effective</div><div class="card-value" style="color:var(--green)">${s.effectiveRules}</div></div>
          <div class="card"><div class="card-title">Near Graduation</div><div class="card-value" style="color:var(--yellow)">${s.nearGraduation}</div></div>
        </div>
      `;
    }
    // Recent errors
    html += `<h3 style="margin:16px 0 12px;font-size:14px;">Recent Errors (${errors.length})</h3>`;
    html += `<table class="data-table">
      <tr><th>Time</th><th>Message</th><th>Context</th></tr>
      ${errors.slice(0, 20).map(e => `
        <tr>
          <td style="white-space:nowrap;font-size:12px;">${new Date(e.timestamp * 1000).toLocaleString('fr-CA')}</td>
          <td style="font-size:12px;">${escapeHtml((e.error_message || '').slice(0, 120))}</td>
          <td style="font-size:11px;color:var(--orange);">${escapeHtml(e.context || '')}</td>
        </tr>
      `).join('')}
    </table>`;
    document.getElementById('debug-body').innerHTML = html;
  } catch (err) {
    document.getElementById('debug-body').innerHTML = `<p style="color:var(--red);">${err.message}</p>`;
  }
}

// ══════════════════════════════════════════════════════════════
// VIEW: System
// ══════════════════════════════════════════════════════════════
async function loadSystem() {
  try {
    const data = await api('system');
    document.getElementById('system-body').innerHTML = `
      <div class="cards-grid">
        <div class="card">
          <div class="card-title">Platform</div>
          <div class="card-value" style="font-size:18px;">${escapeHtml(data.platform)}</div>
          <div class="card-sub">${escapeHtml(data.arch)} — ${escapeHtml(data.release)}</div>
        </div>
        <div class="card">
          <div class="card-title">Hostname</div>
          <div class="card-value" style="font-size:18px;">${escapeHtml(data.hostname)}</div>
        </div>
        <div class="card">
          <div class="card-title">CPU</div>
          <div class="card-value" style="font-size:16px;">${data.cpu.cores} cores</div>
          <div class="card-sub">${escapeHtml(data.cpu.model)}</div>
        </div>
        <div class="card">
          <div class="card-title">RAM</div>
          <div class="card-value">${data.memory.percent}%</div>
          <div class="card-sub">${(data.memory.used / 1024).toFixed(1)}GB / ${(data.memory.total / 1024).toFixed(1)}GB</div>
        </div>
        <div class="card">
          <div class="card-title">Node.js</div>
          <div class="card-value" style="font-size:18px;">${escapeHtml(data.nodeVersion)}</div>
        </div>
        <div class="card">
          <div class="card-title">Process PID</div>
          <div class="card-value">${data.process.pid}</div>
          <div class="card-sub">Uptime: ${formatDuration(data.process.uptime * 1000)}</div>
        </div>
        <div class="card">
          <div class="card-title">Process RSS</div>
          <div class="card-value">${data.process.memory.rss}<span style="font-size:14px;color:var(--text2);">MB</span></div>
        </div>
        <div class="card">
          <div class="card-title">OS Uptime</div>
          <div class="card-value" style="font-size:18px;">${formatDuration(data.uptime * 1000)}</div>
        </div>
      </div>
    `;
  } catch (err) {
    document.getElementById('system-body').innerHTML = `<p style="color:var(--red);">${err.message}</p>`;
  }
}

// ══════════════════════════════════════════════════════════════
// VIEW: Trading
// ══════════════════════════════════════════════════════════════
// ═══ LLM Usage ═══
async function loadLLMUsage() {
  const todayEl = document.getElementById('llm-usage-today');
  const chartEl = document.getElementById('llm-usage-chart');
  const tableEl = document.getElementById('llm-usage-table');
  try {
    const [todayData, trendData] = await Promise.all([
      api('llm-usage/today'),
      api('llm-usage/trend?days=7'),
    ]);
    // Today cards
    const providers = Object.entries(todayData);
    const totalReqs = providers.reduce((s, [, v]) => s + v.requests, 0);
    const totalCost = providers.reduce((s, [, v]) => s + v.cost, 0);
    const totalTokens = providers.reduce((s, [, v]) => s + v.input + v.output, 0);
    const colors = { gemini: 'var(--accent)', claude: 'var(--purple)', groq: 'var(--green)', ollama: 'var(--orange)', haiku: 'var(--yellow)' };
    todayEl.innerHTML = `
      <div class="card" style="border-left:3px solid var(--accent);">
        <div class="card-title">Today — Requests</div>
        <div class="card-value">${totalReqs}</div>
        <div class="card-sub">${providers.map(([p,v]) => `${p}: ${v.requests}`).join(' · ')}</div>
      </div>
      <div class="card" style="border-left:3px solid var(--green);">
        <div class="card-title">Today — Tokens</div>
        <div class="card-value">${(totalTokens/1000).toFixed(1)}K</div>
        <div class="card-sub">${providers.map(([p,v]) => `${p}: ${((v.input+v.output)/1000).toFixed(1)}K`).join(' · ')}</div>
      </div>
      <div class="card" style="border-left:3px solid var(--yellow);">
        <div class="card-title">Today — Est. Cost</div>
        <div class="card-value">$${totalCost.toFixed(4)}</div>
        <div class="card-sub">${providers.map(([p,v]) => `${p}: $${v.cost.toFixed(4)}`).join(' · ')}</div>
      </div>
    `;

    // 7-day trend — simple ASCII-style bar chart
    const trend = trendData.trend || [];
    if (trend.length === 0) {
      chartEl.innerHTML = '<div style="color:var(--text2);text-align:center;padding:40px;">No usage data yet.</div>';
    } else {
      // Group by date
      const byDate = {};
      for (const r of trend) {
        if (!byDate[r.date]) byDate[r.date] = { requests: 0, tokens: 0, cost: 0, providers: {} };
        byDate[r.date].requests += r.requests;
        byDate[r.date].tokens += r.input_tokens + r.output_tokens;
        byDate[r.date].cost += r.cost;
        byDate[r.date].providers[r.provider] = (byDate[r.date].providers[r.provider] || 0) + r.requests;
      }
      const dates = Object.keys(byDate).sort();
      const maxReqs = Math.max(...dates.map(d => byDate[d].requests), 1);
      let chartHTML = '<div style="display:flex;flex-direction:column;gap:6px;">';
      for (const date of dates) {
        const d = byDate[date];
        const pct = (d.requests / maxReqs * 100).toFixed(0);
        const provBars = Object.entries(d.providers).map(([p, c]) => {
          const w = (c / maxReqs * 100).toFixed(0);
          return `<div style="height:100%;width:${w}%;background:${colors[p]||'var(--accent)'};border-radius:2px;" title="${p}: ${c} reqs"></div>`;
        }).join('');
        chartHTML += `
          <div style="display:flex;align-items:center;gap:8px;">
            <span style="font-size:11px;color:var(--text2);width:70px;flex-shrink:0;">${date.slice(5)}</span>
            <div style="flex:1;height:20px;background:var(--bg3);border-radius:3px;display:flex;overflow:hidden;">${provBars}</div>
            <span style="font-size:11px;color:var(--text2);width:50px;text-align:right;">${d.requests} req</span>
            <span style="font-size:11px;color:var(--yellow);width:60px;text-align:right;">$${d.cost.toFixed(3)}</span>
          </div>`;
      }
      chartHTML += '</div>';
      // Legend
      chartHTML += '<div style="display:flex;gap:12px;margin-top:10px;justify-content:center;">';
      for (const [p, c] of Object.entries(colors)) {
        chartHTML += `<span style="font-size:11px;color:var(--text2);display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:10px;height:10px;background:${c};border-radius:2px;"></span>${p}</span>`;
      }
      chartHTML += '</div>';
      chartEl.innerHTML = chartHTML;
    }

    // Detail table
    const summary = await api('llm-usage/summary?days=7');
    if (summary.length === 0) {
      tableEl.innerHTML = '<div style="color:var(--text2);">No data.</div>';
    } else {
      let html = '<table style="width:100%;font-size:12px;border-collapse:collapse;">';
      html += '<tr style="border-bottom:1px solid var(--border);"><th style="text-align:left;padding:6px;color:var(--text2);">Date</th><th style="text-align:left;padding:6px;color:var(--text2);">Provider</th><th style="text-align:right;padding:6px;color:var(--text2);">Requests</th><th style="text-align:right;padding:6px;color:var(--text2);">In Tokens</th><th style="text-align:right;padding:6px;color:var(--text2);">Out Tokens</th><th style="text-align:right;padding:6px;color:var(--text2);">Cost</th></tr>';
      for (const r of summary.slice(0, 50)) {
        const c = colors[r.provider] || 'var(--text)';
        html += `<tr style="border-bottom:1px solid var(--border);">
          <td style="padding:6px;">${r.date}</td>
          <td style="padding:6px;color:${c};font-weight:600;">${r.provider}</td>
          <td style="padding:6px;text-align:right;">${r.requests}</td>
          <td style="padding:6px;text-align:right;">${(r.input_tokens/1000).toFixed(1)}K</td>
          <td style="padding:6px;text-align:right;">${(r.output_tokens/1000).toFixed(1)}K</td>
          <td style="padding:6px;text-align:right;color:var(--yellow);">$${r.estimated_cost_usd.toFixed(4)}</td>
        </tr>`;
      }
      html += '</table>';
      tableEl.innerHTML = html;
    }
  } catch (err) {
    todayEl.innerHTML = `<div style="color:var(--red);">Error: ${err.message}</div>`;
  }
}

let tradingRefreshTimer = null;
async function loadTrading() {
  if (tradingRefreshTimer) clearInterval(tradingRefreshTimer);
  try {
    const data = await api('trading');
    if (data.error) { document.getElementById('trading-body').innerHTML = `<p style="color:var(--red);">${escapeHtml(data.error)}</p>`; return; }
    renderTrading(data);
    // Auto-refresh every 30s while on trading view
    tradingRefreshTimer = setInterval(async () => {
      if (currentView !== 'trading') { clearInterval(tradingRefreshTimer); return; }
      try { const d = await api('trading'); renderTrading(d); } catch {}
    }, 30000);
  } catch (err) {
    document.getElementById('trading-body').innerHTML = `<p style="color:var(--red);">${err.message}</p>`;
  }
}

function renderTrading(data) {
  const a = data.account || {};
  const positions = data.positions || [];
  const orders = data.orders || [];
  const clock = data.clock || {};
  const watchlist = data.watchlist || [];

  const equity = parseFloat(a.portfolio_value || 0);
  const cash = parseFloat(a.cash || 0);
  const bp = parseFloat(a.buying_power || 0);
  const lastEquity = parseFloat(a.last_equity || equity);
  const dayPL = equity - lastEquity;
  const dayPLPct = lastEquity > 0 ? (dayPL / lastEquity * 100) : 0;
  const plColor = dayPL >= 0 ? 'var(--green, #22c55e)' : 'var(--red, #ef4444)';
  const marketStatus = clock.is_open ? '<span style="color:var(--green, #22c55e);">OPEN</span>' : '<span style="color:var(--red, #ef4444);">CLOSED</span>';

  // Calculate total unrealized P&L
  let totalPL = 0;
  for (const p of positions) totalPL += parseFloat(p.unrealized_pl || 0);

  let html = `
    <div class="cards-grid">
      <div class="card">
        <div class="card-title">Portfolio Value</div>
        <div class="card-value" style="font-size:22px;">$${equity.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}</div>
        <div class="card-sub">Cash: $${cash.toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2})}</div>
      </div>
      <div class="card">
        <div class="card-title">Day P&L</div>
        <div class="card-value" style="font-size:22px;color:${plColor};">${dayPL >= 0 ? '+' : ''}$${dayPL.toFixed(2)}</div>
        <div class="card-sub" style="color:${plColor};">${dayPLPct >= 0 ? '+' : ''}${dayPLPct.toFixed(2)}%</div>
      </div>
      <div class="card">
        <div class="card-title">Unrealized P&L</div>
        <div class="card-value" style="font-size:22px;color:${totalPL >= 0 ? 'var(--green, #22c55e)' : 'var(--red, #ef4444)'};">${totalPL >= 0 ? '+' : ''}$${totalPL.toFixed(2)}</div>
        <div class="card-sub">${positions.length} positions</div>
      </div>
      <div class="card">
        <div class="card-title">Market</div>
        <div class="card-value" style="font-size:20px;">${marketStatus}</div>
        <div class="card-sub">Buying Power: $${bp.toLocaleString('en-US', {maximumFractionDigits:0})}</div>
      </div>
    </div>

    <h3 style="margin:20px 0 8px;color:var(--text1);">Positions</h3>
    <table style="width:100%;border-collapse:collapse;font-size:13px;">
      <thead>
        <tr style="border-bottom:1px solid var(--border);text-align:left;">
          <th style="padding:8px;">Symbol</th>
          <th style="padding:8px;text-align:right;">Qty</th>
          <th style="padding:8px;text-align:right;">Entry</th>
          <th style="padding:8px;text-align:right;">Current</th>
          <th style="padding:8px;text-align:right;">P&L $</th>
          <th style="padding:8px;text-align:right;">P&L %</th>
          <th style="padding:8px;text-align:right;">Day Chg</th>
          <th style="padding:8px;text-align:right;">Mkt Value</th>
        </tr>
      </thead>
      <tbody>`;

  for (const p of positions) {
    const pl = parseFloat(p.unrealized_pl || 0);
    const plPct = parseFloat(p.unrealized_plpc || 0) * 100;
    const dayChg = parseFloat(p.change_today || 0) * 100;
    const c = pl >= 0 ? 'var(--green, #22c55e)' : 'var(--red, #ef4444)';
    const dc = dayChg >= 0 ? 'var(--green, #22c55e)' : 'var(--red, #ef4444)';
    html += `
        <tr style="border-bottom:1px solid var(--border);">
          <td style="padding:8px;font-weight:bold;">${escapeHtml(p.symbol)}</td>
          <td style="padding:8px;text-align:right;">${p.qty}</td>
          <td style="padding:8px;text-align:right;">$${parseFloat(p.avg_entry_price).toFixed(2)}</td>
          <td style="padding:8px;text-align:right;">$${parseFloat(p.current_price).toFixed(2)}</td>
          <td style="padding:8px;text-align:right;color:${c};">${pl >= 0 ? '+' : ''}$${pl.toFixed(2)}</td>
          <td style="padding:8px;text-align:right;color:${c};">${plPct >= 0 ? '+' : ''}${plPct.toFixed(2)}%</td>
          <td style="padding:8px;text-align:right;color:${dc};">${dayChg >= 0 ? '+' : ''}${dayChg.toFixed(2)}%</td>
          <td style="padding:8px;text-align:right;">$${parseFloat(p.market_value).toFixed(2)}</td>
        </tr>`;
  }
  if (positions.length === 0) {
    html += `<tr><td colspan="8" style="padding:16px;text-align:center;color:var(--text2);">No open positions</td></tr>`;
  }
  html += `</tbody></table>`;

  // Active orders
  const activeOrders = orders.filter(o => ['new','partially_filled','accepted','pending_new'].includes(o.status));
  if (activeOrders.length > 0) {
    html += `<h3 style="margin:20px 0 8px;color:var(--text1);">Active Orders (${activeOrders.length})</h3>
    <table style="width:100%;border-collapse:collapse;font-size:13px;">
      <thead><tr style="border-bottom:1px solid var(--border);text-align:left;">
        <th style="padding:8px;">Symbol</th><th style="padding:8px;">Side</th><th style="padding:8px;">Type</th>
        <th style="padding:8px;text-align:right;">Qty</th><th style="padding:8px;">Status</th><th style="padding:8px;">Created</th>
      </tr></thead><tbody>`;
    for (const o of activeOrders) {
      const sideColor = o.side === 'buy' ? 'var(--green, #22c55e)' : 'var(--red, #ef4444)';
      html += `<tr style="border-bottom:1px solid var(--border);">
        <td style="padding:8px;font-weight:bold;">${escapeHtml(o.symbol)}</td>
        <td style="padding:8px;color:${sideColor};text-transform:uppercase;">${o.side}</td>
        <td style="padding:8px;">${o.type}</td>
        <td style="padding:8px;text-align:right;">${o.qty}</td>
        <td style="padding:8px;">${o.status}</td>
        <td style="padding:8px;">${new Date(o.created_at).toLocaleString()}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
  }

  // Watchlist
  if (watchlist.length > 0) {
    html += `<h3 style="margin:20px 0 8px;color:var(--text1);">Watchlist (${watchlist.length})</h3>
    <table style="width:100%;border-collapse:collapse;font-size:13px;">
      <thead><tr style="border-bottom:1px solid var(--border);text-align:left;">
        <th style="padding:8px;">Symbol</th><th style="padding:8px;">Reason</th><th style="padding:8px;">Added</th>
      </tr></thead><tbody>`;
    for (const w of watchlist) {
      html += `<tr style="border-bottom:1px solid var(--border);">
        <td style="padding:8px;font-weight:bold;">${escapeHtml(w.symbol || '')}</td>
        <td style="padding:8px;color:var(--text2);font-size:12px;">${escapeHtml(w.reason || '')}</td>
        <td style="padding:8px;">${w.addedAt ? new Date(w.addedAt).toLocaleDateString() : ''}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
  }

  html += `<p style="margin-top:16px;font-size:11px;color:var(--text2);">Auto-refresh every 30s | Paper trading (Alpaca)</p>`;
  document.getElementById('trading-body').innerHTML = html;
}

// ══════════════════════════════════════════════════════════════
// Chat (preserved from original)
// ══════════════════════════════════════════════════════════════
function getDirectTarget() {
  const select = document.getElementById('direct-target');
  if (!select) return activeTab === 'emile' ? 'emile' : 'kingston';
  const value = select.value;
  if (value === 'kingston' || value === 'emile' || value === 'both') return value;
  return activeTab === 'emile' ? 'emile' : 'kingston';
}

function getErrorMessage(err) {
  if (err && typeof err === 'object' && 'message' in err) return String(err.message || 'Erreur inconnue');
  return String(err || 'Erreur inconnue');
}

function saveAuthToken() {
  const input = document.getElementById('auth-token');
  authToken = (input.value || '').trim();
  if (authToken) localStorage.setItem(AUTH_TOKEN_STORAGE_KEY, authToken);
  else localStorage.removeItem(AUTH_TOKEN_STORAGE_KEY);
  addMessage(activeTab, 'system', authToken ? 'Token sauvegarde.' : 'Token retire.');
}

async function resetSessions() {
  try {
    await postApi('chat/reset', {});
    addMessage(activeTab, 'system', 'Sessions Kingston + Emile reset.');
  } catch (err) {
    addMessage(activeTab, 'system', 'Erreur reset: ' + getErrorMessage(err));
  }
}

function updateDirectTargetUi() {
  const btn = document.getElementById('send-btn');
  const target = getDirectTarget();
  if (activeTab === 'conseil') return;
  if (target === 'emile') { btn.className = 'emile-btn'; btn.style.background = 'var(--purple)'; }
  else if (target === 'both') { btn.className = 'conseil-btn'; btn.style.background = 'linear-gradient(135deg, var(--accent), var(--purple))'; }
  else { btn.className = ''; btn.style.background = 'var(--accent)'; }
}

function switchTab(tab) {
  activeTab = tab;
  document.querySelectorAll('.chat-tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
  const input = document.getElementById('chat-input');
  const continueBar = document.getElementById('continue-bar');
  const targetSelect = document.getElementById('direct-target');

  if (tab === 'emile') {
    input.placeholder = 'Parle a Emile...';
    targetSelect.disabled = false;
    updateDirectTargetUi();
    continueBar.style.display = 'none';
  } else if (tab === 'aster') {
    input.placeholder = 'Aster parle a Kingston + Emile...';
    targetSelect.disabled = true;
    const btn = document.getElementById('send-btn');
    btn.className = 'conseil-btn';
    btn.style.background = 'linear-gradient(135deg, var(--accent), var(--purple))';
    continueBar.style.display = 'none';
  } else if (tab === 'conseil') {
    input.placeholder = 'Pose une question aux deux...';
    targetSelect.disabled = true;
    const btn = document.getElementById('send-btn');
    btn.className = 'conseil-btn';
    btn.style.background = 'linear-gradient(135deg, var(--accent), var(--purple))';
    continueBar.style.display = chatHistory.conseil.length > 1 ? 'flex' : 'none';
  } else {
    input.placeholder = 'Parle a Kingston...';
    targetSelect.disabled = false;
    updateDirectTargetUi();
    continueBar.style.display = 'none';
  }
  renderChat();
}

function renderChat() {
  const container = document.getElementById('chat-messages');
  const history = chatHistory[activeTab];
  container.innerHTML = history.map(m => {
    if (m.role === 'system') return `<div class="msg msg-system">${m.content}</div>`;
    if (m.role === 'user') return `<div class="msg msg-user">${escapeHtml(m.content)}</div>`;
    const content = renderMsgContent(m.content);
    if ((activeTab === 'conseil' || activeTab === 'aster') && m.agent) {
      const agentCls = m.agent === 'kingston' ? 'kingston-msg' : 'emile-msg';
      const labelCls = m.agent === 'kingston' ? 'kingston' : 'emile';
      const label = m.agent === 'kingston' ? 'KINGSTON' : 'EMILE';
      return `<div class="msg msg-assistant ${agentCls}">
        <div class="msg-label ${labelCls}">${label}</div>
        ${content}
      </div>`;
    }
    const cls = `msg-assistant${activeTab === 'emile' ? ' emile' : ''}`;
    return `<div class="msg ${cls}">${content}</div>`;
  }).join('');
  container.scrollTop = container.scrollHeight;
}

function renderMsgContent(text) {
  if (!text) return '';
  // Split out fenced code blocks first (preserve them from other transforms)
  const codeBlocks = [];
  let safe = text.replace(/```(\w*)\n?([\s\S]*?)```/g, (_, lang, code) => {
    const idx = codeBlocks.length;
    codeBlocks.push('<pre><code class="' + escapeHtml(lang) + '">' + escapeHtml(code.trim()) + '</code></pre>');
    return '\x00CB' + idx + '\x00';
  });
  // Escape HTML in the rest
  safe = escapeHtml(safe);
  // Restore code blocks
  safe = safe.replace(/\x00CB(\d+)\x00/g, (_, i) => codeBlocks[+i]);
  // Inline code
  safe = safe.replace(/`([^`]+)`/g, '<code>$1</code>');
  // Images: markdown syntax
  safe = safe.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1" style="max-width:100%;max-height:400px;border-radius:6px;margin:4px 0;cursor:pointer;" loading="lazy" onclick="showInMediaViewer(this.src)" onerror="this.style.display=\'none\'">');
  // Images: bare URLs
  safe = safe.replace(/(https?:\/\/[^\s]+\.(?:png|jpg|jpeg|gif|webp|svg)(?:\?[^\s]*)?)/gi,
    '<img src="$1" style="max-width:100%;max-height:400px;border-radius:6px;margin:4px 0;cursor:pointer;" loading="lazy" onclick="showInMediaViewer(this.src)" onerror="this.style.display=\'none\'">');
  // Images: upload paths
  safe = safe.replace(/((?:uploads|images)\/[^\s"']+\.(?:png|jpg|jpeg|gif|webp))/gi,
    '<img src="/$1" style="max-width:100%;max-height:400px;border-radius:6px;margin:4px 0;cursor:pointer;" loading="lazy" onclick="showInMediaViewer(this.src)" onerror="this.style.display=\'none\'">');
  // Links
  safe = safe.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
  // Bold
  safe = safe.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  // Italic
  safe = safe.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1</em>');
  // Headings (# ## ###)
  safe = safe.replace(/(^|\n)#{1,3}\s+(.+)/g, '$1<h3>$2</h3>');
  // Blockquotes
  safe = safe.replace(/(^|\n)&gt;\s?(.+)/g, '$1<blockquote>$2</blockquote>');
  // Unordered lists: consecutive lines starting with - or *
  safe = safe.replace(/((?:^|\n)[*-]\s+.+(?:\n[*-]\s+.+)*)/g, (match) => {
    const items = match.trim().split('\n').map(l => '<li>' + l.replace(/^[*-]\s+/, '') + '</li>').join('');
    return '<ul>' + items + '</ul>';
  });
  // Line breaks
  safe = safe.replace(/\n/g, '<br>');
  return safe;
}

function addMessage(tab, role, content, meta) {
  const entry = { role, content };
  if (meta) entry.meta = meta;
  chatHistory[tab].push(entry);
  if (activeTab === tab) renderChat();
}

function showTyping() {
  const container = document.getElementById('chat-messages');
  const el = document.createElement('div');
  const id = `typing-${++typingSeq}`;
  el.dataset.typingId = id;
  el.className = 'typing-indicator';
  el.innerHTML = '<span></span><span></span><span></span>';
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
  return id;
}

function hideTyping(id) {
  const el = id
    ? document.querySelector(`[data-typing-id="${id}"]`)
    : document.querySelector('.typing-indicator');
  if (el) el.remove();
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const message = input.value.trim();
  if (!message) return;
  input.value = '';
  input.style.height = 'auto';

  if (activeTab === 'conseil') {
    addMessage('conseil', 'user', message);
    conseilRunning = false;
    await sleep(300);
    conseilSend(message);
    return;
  }
  if (activeTab === 'aster') {
    addMessage('aster', 'user', message);
    fetchAsterParallel(message);
    return;
  }
  const target = getDirectTarget();
  if (target === 'both') {
    addMessage('kingston', 'user', message);
    addMessage('emile', 'user', message);
    fetchAgent('kingston', message);
    fetchAgent('emile', message);
    return;
  }
  addMessage(target, 'user', message);
  if (activeTab !== target) addMessage(activeTab, 'system', `Envoye a ${target}.`);
  fetchAgent(target, message);
}

async function fetchAgent(agent, message) {
  const typingId = showTyping();
  try {
    if (agent === 'kingston') {
      // SSE streaming with tool progress
      const response = await postChatStream(message, (tool, status, detail) => {
        updateTypingProgress(typingId, tool, status, detail);
      });
      hideTyping(typingId);
      addMessage(agent, 'assistant', response);
    } else {
      // Emile: batch mode
      const response = await postChat(agent, message);
      hideTyping(typingId);
      addMessage(agent, 'assistant', response);
    }
  } catch (err) {
    hideTyping(typingId);
    addMessage(agent, 'system', `Erreur: ${getErrorMessage(err)}`);
  }
}

function updateTypingProgress(typingId, tool, status, detail) {
  const el = document.querySelector(`[data-typing-id="${typingId}"]`);
  if (!el) return;
  const toolLabel = tool ? tool.split('.').pop() : '...';
  const icon = status === 'running' ? '\u2699\uFE0F' : '\u2713';
  const detailStr = detail ? ': ' + detail.slice(-40) : '';
  el.innerHTML = `<span class="typing-progress">${icon} ${escapeHtml(toolLabel)}${escapeHtml(detailStr)}...</span>`;
  const container = document.getElementById('chat-messages');
  if (container) container.scrollTop = container.scrollHeight;
}

function fetchAsterParallel(message) {
  fetchAgentForTab('aster', 'kingston', message);
  fetchAgentForTab('aster', 'emile', message);
}

async function fetchAgentForTab(tab, agent, message) {
  const typingId = showTyping();
  try {
    const response = await postChat(agent, message);
    hideTyping(typingId);
    chatHistory[tab].push({ role: 'assistant', content: response, agent });
    if (activeTab === tab) renderChat();
  } catch (err) {
    hideTyping(typingId);
    addMessage(tab, 'system', `Erreur ${agent}: ${getErrorMessage(err)}`);
  }
}

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// ── Conseil Mode ────────────────────────────────────────────
const MAX_AUTO_ROUNDS = Infinity;
let conseilRunning = false;
let conseilRound = 0;

async function conseilSend(message) {
  conseilRunning = true;
  conseilRound = 0;
  showStopButton(true);
  updateRoundsLabel();

  const context = buildContext();
  const kingstonPrompt = context
    ? `[MODE CONSEIL]\n${context}\n\nNICOLAS: ${message}\n\nINSTRUCTIONS: Lis le code, analyse, agis. FAIT: [actions] / SUITE: [prochaine etape pour Emile]`
    : `[MODE CONSEIL]\nNICOLAS: ${message}\n\nINSTRUCTIONS: Lis le code, analyse, agis. FAIT: [actions] / SUITE: [prochaine etape pour Emile]`;
  const kingstonResponse = await agentRespond('kingston', kingstonPrompt);
  if (!conseilRunning) return;

  const updatedContext = buildContext();
  await agentRespond('emile',
    `[MODE CONSEIL — REVUE]\n${updatedContext}\n\nINSTRUCTIONS: Revise Kingston, continue l'implementation. FAIT: [actions] / SUITE: [prochaine etape pour Kingston]`
  );
  if (!conseilRunning) return;

  conseilRound = 1;
  updateRoundsLabel();
  await autoDialogue();
}

async function autoDialogue() {
  while (conseilRunning && conseilRound < MAX_AUTO_ROUNDS) {
    const context = buildContext();
    await agentRespond('kingston',
      `[CONSEIL TOUR ${conseilRound + 1} — KINGSTON]\n${context}\n\nImplemente la suggestion d'Emile. FAIT: [actions] / SUITE: [prochaine etape]`
    );
    if (!conseilRunning) break;

    const updatedContext = buildContext();
    await agentRespond('emile',
      `[CONSEIL TOUR ${conseilRound + 1} — EMILE]\n${updatedContext}\n\nRevise Kingston. FAIT: [actions] / SUITE: [prochaine etape]`
    );
    if (!conseilRunning) break;
    conseilRound++;
    updateRoundsLabel();
  }
  conseilRunning = false;
  showStopButton(false);
  document.getElementById('continue-bar').style.display = 'flex';
  addMessage('conseil', 'system', `Dialogue arrete apres ${conseilRound} tours.`);
}

async function agentRespond(agent, prompt) {
  const typingId = showTyping();
  try {
    const response = await postChat(agent, prompt);
    hideTyping(typingId);
    chatHistory.conseil.push({ role: 'assistant', content: response, agent });
    renderChat();
    return response;
  } catch (err) {
    hideTyping(typingId);
    addMessage('conseil', 'system', `Erreur ${agent}: ${getErrorMessage(err)}`);
    conseilRunning = false;
    return '';
  }
}

function buildContext() {
  return chatHistory.conseil
    .filter(m => m.role !== 'system').slice(-6)
    .map(m => `${m.agent ? m.agent.toUpperCase() : 'NICOLAS'}: ${m.content}`)
    .join('\n\n');
}

async function continueDialogue(who) {
  if (who === 'both') {
    conseilRunning = true;
    conseilRound = 0;
    showStopButton(true);
    autoDialogue();
    return;
  }
  const context = buildContext();
  agentRespond(who, `[CONVERSATION — ${who.toUpperCase()} CONTINUE]\n${context}\n\nContinue. FAIT: [actions] / SUITE: [prochaine etape]`);
}

function stopConseil() {
  conseilRunning = false;
  hideTyping();
  showStopButton(false);
  addMessage('conseil', 'system', 'Dialogue interrompu.');
}

function showStopButton(show) {
  document.getElementById('cont-stop').style.display = show ? 'inline-block' : 'none';
  document.getElementById('cont-kingston').style.display = show ? 'none' : 'inline-block';
  document.getElementById('cont-emile').style.display = show ? 'none' : 'inline-block';
  document.getElementById('cont-both').style.display = show ? 'none' : 'inline-block';
  document.getElementById('continue-bar').style.display = 'flex';
}

function updateRoundsLabel() {
  document.getElementById('rounds-label').textContent = conseilRunning ? `Tour ${conseilRound + 1}` : '';
}

function handleKeyDown(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
  const input = e.target;
  setTimeout(() => { input.style.height = 'auto'; input.style.height = Math.min(input.scrollHeight, 120) + 'px'; }, 0);
}

// ══════════════════════════════════════════════════════════════
// Helpers
// ══════════════════════════════════════════════════════════════
function statusColor(status) {
  switch (status) {
    case 'running': case 'idle': return 'green';
    case 'error': case 'stopped': return 'red';
    case 'backoff': return 'yellow';
    default: return 'yellow';
  }
}
function statusBadge(status) {
  switch (status) {
    case 'running': case 'idle': return 'green';
    case 'error': case 'stopped': return 'red';
    case 'backoff': return 'yellow';
    default: return 'blue';
  }
}
function formatDuration(ms) {
  const d = Math.floor(ms / 86400000);
  const h = Math.floor((ms % 86400000) / 3600000);
  const m = Math.floor((ms % 3600000) / 60000);
  const s = Math.floor((ms % 60000) / 1000);
  if (d > 0) return `${d}d ${h}h${m}m`;
  if (h > 0) return `${h}h${m}m`;
  if (m > 0) return `${m}m${s}s`;
  return `${s}s`;
}
function formatCountdown(ms) {
  if (ms <= 0) return 'now';
  const m = Math.floor(ms / 60000);
  const s = Math.floor((ms % 60000) / 1000);
  if (m > 0) return `${m}m${s}s`;
  return `${s}s`;
}
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ── XP sidebar badge updater ──
function updateXpBadge(xp) {
  const levelEl = document.getElementById('xp-level');
  const pointsEl = document.getElementById('xp-points');
  if (levelEl) levelEl.textContent = xp.level || 'Apprenti';
  if (pointsEl) pointsEl.textContent = (xp.totalXp || 0) + ' XP';
}

// Load XP badge on page init (runs once)
api('xp').then(xp => updateXpBadge(xp)).catch(() => {});

// ══════════════════════════════════════════════════════════════
// VIEW: Voice — Wake Word + Local/Cloud Mode
// ══════════════════════════════════════════════════════════════
let voiceWakeEnabled = false, voiceWakeActive = false, voiceWakeRecog = null;
let voiceSessionActive = false, voiceLocalProcessing = false;
let voiceLocalRecog = null, voiceLocalListening = false;
let voiceFinalText = '', voiceSilenceTimer = null;
let voicePlayCtx = null, voiceLocalAudio = null;
let voiceInited = false;
// Cloud mode (Gemini Live WebSocket)
let voiceMode = localStorage.getItem('kingston_sidebar_voice_mode') || 'cloud'; // 'local' or 'cloud'
let voiceWs = null, voiceWsRetries = 0;
let voiceCloudMicStream = null, voiceCloudAudioCtx = null, voiceCloudWorklet = null;
let voiceCloudPlayQueue = [], voiceCloudNextPlayTime = 0, voiceCloudSpeaking = false;

const VOICE_WAKE_REGEX = /comput[eè]r|ordinat[eè]ur|computer/i;

// ─── Language detection for dual voice (fr/en) ───
function voiceDetectLang(text) {
  if (!text) return 'fr-male';
  const lower = text.toLowerCase();
  const frSignals = (lower.match(/[àâäéèêëïîôùûüÿçœæ]/g) || []).length;
  const frWords = ['je ', 'tu ', 'il ', 'elle ', 'nous ', 'vous ', 'les ', 'des ', 'est ', 'une ', 'dans ', 'pour ', 'que ', 'qui ', 'sur ', 'avec ', 'pas ', 'mais ', 'oui ', 'non ', 'bien ', 'fait ', 'très ', 'comme ', 'cette ', 'sont ', 'tout ', 'aussi ', "c'est ", "j'ai ", "l'", "d'", "n'", "qu'"];
  const enWords = ['the ', 'is ', 'are ', 'was ', 'were ', 'have ', 'has ', 'been ', 'will ', 'would ', 'could ', 'should ', 'this ', 'that ', 'with ', 'from ', 'they ', 'what ', 'when ', 'where ', 'which ', 'there ', 'their ', 'your ', 'about ', "it's ", "don't ", "can't ", "i'm "];
  let frScore = frSignals * 2;
  let enScore = 0;
  for (const w of frWords) { if (lower.includes(w)) frScore++; }
  for (const w of enWords) { if (lower.includes(w)) enScore++; }
  return enScore > frScore ? 'en-male' : 'fr-male';
}

function hasVoiceWebSpeech() {
  return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
}

function voiceSetStatus(state, label) {
  const mic = document.getElementById('voice-mic-btn');
  // Update Kingston orb indicator
  const orb = document.getElementById('kingston-orb');
  const orbStatus = document.getElementById('kingston-avatar-status');
  if (orb) orb.dataset.state = state;
  if (orbStatus) orbStatus.textContent = label;
  if (mic) {
    mic.className = 'voice-mic-btn' + ({
      listen: ' active', speak: ' speaking', think: ' processing'
    }[state] || '');
  }
}

function voiceAddMsg(role, text) {
  const container = document.getElementById('voice-transcript');
  if (!container) return;
  const div = document.createElement('div');
  if (role === 'user') {
    div.className = 'voice-msg voice-msg-user';
    const lbl = document.createElement('div');
    lbl.className = 'voice-msg-label lbl-user';
    lbl.textContent = 'Toi';
    div.appendChild(lbl);
    const c = document.createElement('div');
    c.textContent = text;
    div.appendChild(c);
  } else if (role === 'kingston') {
    div.className = 'voice-msg voice-msg-kingston';
    const lbl = document.createElement('div');
    lbl.className = 'voice-msg-label lbl-kingston';
    lbl.textContent = 'Kingston';
    div.appendChild(lbl);
    const c = document.createElement('div');
    c.textContent = text;
    div.appendChild(c);
  } else {
    div.className = 'voice-msg voice-msg-system';
    div.textContent = text;
  }
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function voicePlayBeep(freq, dur) {
  try {
    const c = new AudioContext();
    const o = c.createOscillator();
    const g = c.createGain();
    o.frequency.value = freq; o.type = 'sine'; g.gain.value = 0.12;
    o.connect(g); g.connect(c.destination); o.start();
    g.gain.exponentialRampToValueAtTime(0.001, c.currentTime + dur / 1000);
    o.stop(c.currentTime + dur / 1000 + 0.05);
    setTimeout(() => c.close(), dur + 200);
  } catch {}
}

// ── Wake Word (NO FLASH fix) ──────────────────────────
function voiceStartWake() {
  if (!hasVoiceWebSpeech() || voiceWakeActive || voiceSessionActive) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  voiceWakeRecog = new SR();
  voiceWakeRecog.continuous = true;
  voiceWakeRecog.interimResults = true;
  voiceWakeRecog.lang = 'fr-CA';

  voiceWakeRecog.onstart = () => {
    voiceWakeActive = true;
    // Show wake bar and set text — STABLE, no toggling
    const bar = document.getElementById('voice-wake-bar');
    const txt = document.getElementById('voice-wake-text');
    if (bar) bar.classList.add('visible');
    if (txt) { txt.textContent = 'Ecoute... dis "Computer"'; txt.className = ''; }
    if (!voiceSessionActive) voiceSetStatus('wake', 'Dis "Computer"...');
  };

  voiceWakeRecog.onresult = (e) => {
    let interim = '', final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) final += t; else interim += t;
    }
    const display = (final || interim).trim();
    const txt = document.getElementById('voice-wake-text');
    if (display && txt) txt.textContent = display;
    const check = (final || interim).toLowerCase().replace(/[.,!?;:'"]/g, '');
    if (VOICE_WAKE_REGEX.test(check)) voiceOnWakeDetected();
  };

  voiceWakeRecog.onerror = (e) => {
    // no-speech and aborted are normal — restart silently without flash
    if (e.error === 'no-speech' || e.error === 'aborted') return;
    if (e.error === 'not-allowed') {
      voiceWakeActive = false;
      voiceWakeEnabled = false;
      const btn = document.getElementById('voice-wake-toggle');
      if (btn) btn.classList.remove('on');
      const bar = document.getElementById('voice-wake-bar');
      if (bar) bar.classList.remove('visible');
      voiceSetStatus('off', 'Micro refuse');
      return;
    }
    // Other errors: restart silently
    if (voiceWakeEnabled && !voiceSessionActive) {
      setTimeout(voiceRestartWake, 500);
    }
  };

  voiceWakeRecog.onend = () => {
    voiceWakeActive = false;
    // KEY FIX: do NOT hide the bar on restart. Just restart silently.
    if (voiceWakeEnabled && !voiceSessionActive) {
      setTimeout(voiceRestartWake, 300);
    } else {
      // Only hide when actually disabled
      const bar = document.getElementById('voice-wake-bar');
      if (bar) bar.classList.remove('visible');
      if (!voiceSessionActive) voiceSetStatus('off', 'Inactif');
    }
  };

  try { voiceWakeRecog.start(); } catch {}
}

function voiceStopWake() {
  voiceWakeActive = false;
  try { if (voiceWakeRecog) voiceWakeRecog.stop(); } catch {}
  voiceWakeRecog = null;
}

function voiceRestartWake() {
  if (!voiceWakeEnabled || voiceSessionActive || voiceWakeActive) return;
  // Do NOT call voiceStopWake() which would hide the bar
  // Just stop the recognition object and restart
  try { if (voiceWakeRecog) voiceWakeRecog.stop(); } catch {}
  voiceWakeRecog = null;
  setTimeout(() => {
    if (voiceWakeEnabled && !voiceSessionActive) voiceStartWake();
  }, 200);
}

function voiceOnWakeDetected() {
  // Anti-double: cross-tab lock via localStorage
  const lastWake = parseInt(localStorage.getItem('kingston_wake_lock') || '0');
  if (Date.now() - lastWake < 3000) return; // Another tab already handling
  localStorage.setItem('kingston_wake_lock', String(Date.now()));

  voiceAddMsg('system', '"Computer" detecte!');
  voicePlayBeep(880, 120);
  const txt = document.getElementById('voice-wake-text');
  if (txt) { txt.textContent = 'Detecte!'; txt.className = 'heard'; }
  voiceStopWake();
  const bar = document.getElementById('voice-wake-bar');
  if (bar) bar.classList.remove('visible');
  if (voiceMode === 'cloud') {
    voiceStartCloudSession();
  } else {
    voiceSpeakGreeting().then(() => { voiceStartLocalSession(); });
  }
}

async function voiceSpeakGreeting() {
  const texts = ['Bonjour Nicolas!', 'Oui Nicolas?', 'Je t\'ecoute Nicolas.', 'A ton service Nicolas.'];
  const text = texts[Math.floor(Math.random() * texts.length)];
  voiceAddMsg('kingston', text);
  voiceSetStatus('speak', 'Kingston...');
  try {
    if (!voicePlayCtx) voicePlayCtx = new AudioContext({ sampleRate: 24000 });
    if (voicePlayCtx.state === 'suspended') await voicePlayCtx.resume();
    const r = await fetch('/api/tts', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ text, voice: 'fr-male' })
    });
    if (r.ok) {
      const ab = await r.arrayBuffer();
      const decoded = await voicePlayCtx.decodeAudioData(ab);
      const src = voicePlayCtx.createBufferSource();
      src.buffer = decoded;
      src.connect(voicePlayCtx.destination);
      await new Promise(res => { src.onended = res; src.start(); });
    }
  } catch (e) { console.warn('[voice-greeting] TTS error:', e); }
}

// ── Local Session (STT → Claude → TTS) ────────────────
function voiceStartLocalSession() {
  if (voiceSessionActive) return;
  voiceSessionActive = true;
  voiceLocalProcessing = false;
  voiceFinalText = '';
  voiceStopWake();
  const bar = document.getElementById('voice-wake-bar');
  if (bar) bar.classList.remove('visible');
  voiceAddMsg('system', 'Session locale — parle, Kingston ecoute...');
  voiceStartLocalListening();
}

function voiceStartLocalListening() {
  if (!hasVoiceWebSpeech() || voiceLocalProcessing || voiceLocalListening) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  voiceLocalRecog = new SR();
  voiceLocalRecog.continuous = true;
  voiceLocalRecog.interimResults = true;
  voiceLocalRecog.lang = 'fr-CA';

  voiceLocalRecog.onstart = () => {
    voiceLocalListening = true;
    voiceFinalText = '';
    const bar = document.getElementById('voice-wake-bar');
    const txt = document.getElementById('voice-wake-text');
    if (bar) bar.classList.add('visible');
    if (txt) { txt.textContent = 'Ecoute...'; txt.className = ''; }
    voiceSetStatus('listen', 'Kingston ecoute...');
  };

  voiceLocalRecog.onresult = (e) => {
    let interim = '', nf = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) nf += t; else interim += t;
    }
    if (nf) voiceFinalText += (voiceFinalText ? ' ' : '') + nf.trim();
    const display = (voiceFinalText + (interim ? ' ' + interim : '')).trim();
    const txt = document.getElementById('voice-wake-text');
    if (display && txt) txt.textContent = display;
    clearTimeout(voiceSilenceTimer);
    if (voiceFinalText) {
      voiceSilenceTimer = setTimeout(() => {
        if (voiceFinalText && !voiceLocalProcessing && voiceSessionActive) {
          voiceProcessLocal(voiceFinalText.trim());
        }
      }, 800);
    }
  };

  voiceLocalRecog.onerror = (e) => {
    if (e.error === 'no-speech' || e.error === 'aborted') return;
    if (e.error === 'not-allowed') { voiceStopLocalSession(); return; }
    if (voiceSessionActive && !voiceLocalProcessing) {
      voiceLocalListening = false;
      setTimeout(() => {
        if (voiceSessionActive && !voiceLocalProcessing) voiceStartLocalListening();
      }, 300);
    }
  };

  voiceLocalRecog.onend = () => {
    voiceLocalListening = false;
    // Don't hide bar during session — restart silently
    if (voiceSessionActive && !voiceLocalProcessing) {
      setTimeout(() => {
        if (voiceSessionActive && !voiceLocalProcessing) voiceStartLocalListening();
      }, 200);
    }
  };

  try { voiceLocalRecog.start(); } catch { voiceLocalListening = false; }
}

function voiceStopLocalListening() {
  voiceLocalListening = false;
  clearTimeout(voiceSilenceTimer);
  try { if (voiceLocalRecog) voiceLocalRecog.stop(); } catch {}
  voiceLocalRecog = null;
  const bar = document.getElementById('voice-wake-bar');
  if (bar) bar.classList.remove('visible');
}

async function voiceProcessLocal(text) {
  if (!text || voiceLocalProcessing) return;
  voiceLocalProcessing = true;
  voiceFinalText = '';
  voiceStopLocalListening();
  voiceAddMsg('user', text);
  voiceSetStatus('think', 'Kingston reflechit...');
  const bar = document.getElementById('voice-wake-bar');
  const txt = document.getElementById('voice-wake-text');
  if (bar) bar.classList.add('visible');
  if (txt) { txt.textContent = 'Reflexion...'; txt.className = ''; }

  // Pre-warm AudioContext early (don't wait for TTS response)
  if (!voicePlayCtx) voicePlayCtx = new AudioContext({ sampleRate: 24000 });
  if (voicePlayCtx.state === 'suspended') voicePlayCtx.resume().catch(() => {});

  try {
    // Full Kingston voice — all tools, memory, code.request
    const ctrl = new AbortController();
    const to = setTimeout(() => ctrl.abort(), 120000);
    const r = await fetch('/api/chat/voice', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ message: text }),
      signal: ctrl.signal
    });
    clearTimeout(to);
    if (!r.ok) throw new Error('API ' + r.status);
    const d = await r.json();
    const resp = d.response || 'Desole, pas de reponse.';
    voiceAddMsg('kingston', resp);

    // TTS — fire immediately after response
    voiceSetStatus('speak', 'Kingston parle...');
    if (txt) txt.textContent = 'Synthese...';
    const tCtrl = new AbortController();
    const tTo = setTimeout(() => tCtrl.abort(), 15000);
    const tr = await fetch('/api/tts', {
      method: 'POST',
      headers: getAuthHeaders({ 'Content-Type': 'application/json' }),
      body: JSON.stringify({ text: resp.slice(0, 500), voice: voiceDetectLang(resp) }),
      signal: tCtrl.signal
    });
    clearTimeout(tTo);
    if (tr.ok) {
      if (voicePlayCtx.state === 'suspended') await voicePlayCtx.resume();
      const ab = await tr.arrayBuffer();
      const decoded = await voicePlayCtx.decodeAudioData(ab);
      const src = voicePlayCtx.createBufferSource();
      src.buffer = decoded;
      src.connect(voicePlayCtx.destination);
      voiceLocalAudio = { stop: () => { try { src.stop(); } catch {} } };
      await new Promise(res => {
        src.onended = () => { voiceLocalAudio = null; res(); };
        src.start();
      });
    }
  } catch (err) {
    if (err.name === 'AbortError') voiceAddMsg('system', 'Timeout.');
    else voiceAddMsg('system', 'Erreur: ' + (err.message || ''));
  }

  voiceLocalProcessing = false;
  if (bar) bar.classList.remove('visible');
  if (voiceSessionActive) voiceStartLocalListening();
}

function voiceStopLocalSession() {
  voiceSessionActive = false;
  voiceLocalProcessing = false;
  voiceFinalText = '';
  clearTimeout(voiceSilenceTimer);
  voiceStopLocalListening();
  if (voiceLocalAudio) { try { voiceLocalAudio.stop(); } catch {} voiceLocalAudio = null; }
  const mic = document.getElementById('voice-mic-btn');
  if (mic) mic.className = 'voice-mic-btn';
  if (voiceWakeEnabled) {
    setTimeout(() => {
      if (!voiceSessionActive) {
        voiceStartWake();
        voiceSetStatus('wake', 'Dis "Computer"...');
      }
    }, 500);
  } else {
    voiceSetStatus('off', 'Inactif');
  }
}

function voiceToggleSession() {
  if (voiceSessionActive) {
    if (voiceMode === 'cloud') voiceStopCloudSession();
    else voiceStopLocalSession();
  } else {
    if (voiceMode === 'cloud') voiceStartCloudSession();
    else voiceStartLocalSession();
  }
}

// ── Cloud Mode (Gemini Live WebSocket) ────────────────
function voiceStartCloudSession() {
  if (voiceSessionActive) return;
  voiceSessionActive = true;
  voiceStopWake();
  const bar = document.getElementById('voice-wake-bar');
  if (bar) bar.classList.remove('visible');
  voiceAddMsg('system', 'Gemini Live — connexion...');
  voiceSetStatus('connecting', 'Connexion...');
  voiceCloudConnect();
}

function voiceCloudConnect() {
  if (voiceWs) return;
  const wsUrl = window.location.origin.replace(/^http/, 'ws') + '/ws/voice';
  try { voiceWs = new WebSocket(wsUrl); } catch (e) {
    voiceAddMsg('system', 'Erreur WebSocket: ' + e.message);
    voiceWs = null; return;
  }
  voiceWs.onopen = () => {
    voiceWsRetries = 0;
    voiceWs.send(JSON.stringify({
      type: 'auth', token: authToken || '', voice: 'Enceladus', language: 'fr,en'
    }));
  };
  voiceWs.onmessage = (ev) => {
    let m; try { m = JSON.parse(ev.data); } catch { return; }
    voiceCloudHandleMsg(m);
  };
  voiceWs.onerror = () => {};
  voiceWs.onclose = () => {
    voiceWs = null;
    if (voiceSessionActive && voiceWsRetries < 3) {
      voiceWsRetries++;
      voiceAddMsg('system', 'Reconnexion... (' + voiceWsRetries + '/3)');
      setTimeout(() => { if (voiceSessionActive) voiceCloudConnect(); }, 1500 * voiceWsRetries);
    } else if (voiceSessionActive) {
      voiceAddMsg('system', 'Connexion perdue.');
      voiceStopCloudSession();
    }
  };
}

function voiceCloudHandleMsg(m) {
  switch (m.type) {
    case 'ready':
      voiceSetStatus('listen', 'Kingston ecoute...');
      voiceAddMsg('system', 'Gemini Live connecte — parle!');
      voiceCloudStartMic();
      break;
    case 'audio':
      voiceCloudPlayChunk(m.data);
      if (!voiceCloudSpeaking) { voiceCloudSpeaking = true; voiceSetStatus('speak', 'Kingston parle...'); }
      break;
    case 'transcript':
      if (m.role === 'model') voiceAddMsg('kingston', m.text);
      else voiceAddMsg('user', m.text);
      break;
    case 'interrupted':
      voiceCloudStopPlayback();
      voiceCloudSpeaking = false;
      voiceSetStatus('listen', 'Kingston ecoute...');
      break;
    case 'turn_complete':
      voiceCloudSpeaking = false;
      voiceSetStatus('listen', 'Kingston ecoute...');
      break;
    case 'tool':
      if (m.status === 'calling') voiceAddMsg('system', '> ' + m.name + '...');
      else if (m.status === 'done') voiceAddMsg('system', '< ' + m.name + ': ' + (m.result || '').slice(0, 150));
      break;
    case 'image':
      voiceAddMsg('system', '🎨 Image: ' + (m.caption || ''));
      break;
    case 'session_closed':
      voiceAddMsg('system', 'Session Gemini expiree — reconnexion...');
      if (voiceWs) { try { voiceWs.close(); } catch {} voiceWs = null; }
      voiceCloudStopMic();
      voiceCloudStopPlayback();
      voiceCloudSpeaking = false;
      setTimeout(() => { if (voiceSessionActive) { voiceSetStatus('connecting', 'Reconnexion...'); voiceCloudConnect(); } }, 1500);
      break;
    case 'error':
      voiceAddMsg('system', 'Erreur: ' + m.message);
      break;
  }
}

async function voiceCloudStartMic() {
  try {
    voiceCloudMicStream = await navigator.mediaDevices.getUserMedia({
      audio: { channelCount: 1, sampleRate: 16000, echoCancellation: true, noiseSuppression: true }
    });
    voiceCloudAudioCtx = new AudioContext({ sampleRate: 16000 });
    if (voiceCloudAudioCtx.state === 'suspended') await voiceCloudAudioCtx.resume();
    const code = `class P extends AudioWorkletProcessor{constructor(){super();this.b=[];}process(i){const c=i[0]?.[0];if(!c)return true;for(let j=0;j<c.length;j++)this.b.push(c[j]);if(this.b.length>=1600){this.port.postMessage(new Float32Array(this.b.splice(0,1600)));}return true;}}registerProcessor('p',P);`;
    const blob = new Blob([code], { type: 'application/javascript' });
    const url = URL.createObjectURL(blob);
    await voiceCloudAudioCtx.audioWorklet.addModule(url);
    URL.revokeObjectURL(url);
    const src = voiceCloudAudioCtx.createMediaStreamSource(voiceCloudMicStream);
    voiceCloudWorklet = new AudioWorkletNode(voiceCloudAudioCtx, 'p');
    voiceCloudWorklet.port.onmessage = (e) => {
      if (!voiceWs || voiceWs.readyState !== 1) return;
      const f = e.data;
      const i16 = new Int16Array(f.length);
      for (let j = 0; j < f.length; j++) i16[j] = Math.max(-32768, Math.min(32767, Math.round(f[j] * 32767)));
      const b = new Uint8Array(i16.buffer);
      let s = ''; for (let j = 0; j < b.length; j++) s += String.fromCharCode(b[j]);
      voiceWs.send(JSON.stringify({ type: 'audio', data: btoa(s) }));
    };
    src.connect(voiceCloudWorklet);
    const gain = voiceCloudAudioCtx.createGain(); gain.gain.value = 0;
    voiceCloudWorklet.connect(gain); gain.connect(voiceCloudAudioCtx.destination);
  } catch (err) {
    voiceAddMsg('system', 'Erreur micro: ' + err.message);
  }
}

function voiceCloudStopMic() {
  if (voiceCloudWorklet) { voiceCloudWorklet.disconnect(); voiceCloudWorklet = null; }
  if (voiceCloudMicStream) { voiceCloudMicStream.getTracks().forEach(t => t.stop()); voiceCloudMicStream = null; }
  if (voiceCloudAudioCtx) { voiceCloudAudioCtx.close().catch(() => {}); voiceCloudAudioCtx = null; }
}

function voiceCloudPlayChunk(b64) {
  if (!voicePlayCtx) voicePlayCtx = new AudioContext({ sampleRate: 24000 });
  if (voicePlayCtx.state === 'suspended') voicePlayCtx.resume();
  const r = atob(b64);
  const b = new Uint8Array(r.length);
  for (let i = 0; i < r.length; i++) b[i] = r.charCodeAt(i);
  const i16 = new Int16Array(b.buffer);
  const f = new Float32Array(i16.length);
  for (let i = 0; i < i16.length; i++) f[i] = i16[i] / 32768;
  const buf = voicePlayCtx.createBuffer(1, f.length, 24000);
  buf.getChannelData(0).set(f);
  const src = voicePlayCtx.createBufferSource();
  src.buffer = buf; src.connect(voicePlayCtx.destination);
  const now = voicePlayCtx.currentTime;
  const at = Math.max(now + 0.01, voiceCloudNextPlayTime);
  src.start(at);
  voiceCloudNextPlayTime = at + buf.duration;
  voiceCloudPlayQueue.push(src);
  src.onended = () => { const idx = voiceCloudPlayQueue.indexOf(src); if (idx >= 0) voiceCloudPlayQueue.splice(idx, 1); };
}

function voiceCloudStopPlayback() {
  voiceCloudPlayQueue.forEach(s => { try { s.stop(); } catch {} });
  voiceCloudPlayQueue = [];
  voiceCloudNextPlayTime = 0;
}

function voiceStopCloudSession() {
  voiceSessionActive = false;
  voiceCloudStopMic();
  voiceCloudStopPlayback();
  voiceCloudSpeaking = false;
  if (voiceWs) { try { voiceWs.close(); } catch {} voiceWs = null; }
  const mic = document.getElementById('voice-mic-btn');
  if (mic) mic.className = 'voice-mic-btn';
  if (voiceWakeEnabled) {
    setTimeout(() => { if (!voiceSessionActive) { voiceStartWake(); voiceSetStatus('wake', 'Dis "Computer"...'); } }, 500);
  } else {
    voiceSetStatus('off', 'Inactif');
  }
}

function voiceToggleMode() {
  voiceMode = voiceMode === 'local' ? 'cloud' : 'local';
  localStorage.setItem('kingston_sidebar_voice_mode', voiceMode);
  const btn = document.getElementById('voice-mode-toggle');
  if (btn) {
    btn.innerHTML = voiceMode === 'cloud' ? '&#9729; Gemini' : '&#9729; Local';
    btn.title = voiceMode === 'cloud' ? 'Mode: Gemini Live (streaming)' : 'Mode: Local (Ollama + TTS)';
  }
  voiceAddMsg('system', 'Mode: ' + (voiceMode === 'cloud' ? 'Gemini Live (streaming audio)' : 'Local (Ollama + TTS)'));
}

function voiceToggleWake() {
  voiceWakeEnabled = !voiceWakeEnabled;
  const btn = document.getElementById('voice-wake-toggle');
  if (btn) btn.classList.toggle('on', voiceWakeEnabled);
  if (voiceWakeEnabled) {
    if (!voiceSessionActive) {
      voiceStartWake();
      voiceAddMsg('system', 'Wake word "Computer" active.');
    }
  } else {
    voiceStopWake();
    const bar = document.getElementById('voice-wake-bar');
    if (bar) bar.classList.remove('visible');
    if (!voiceSessionActive) voiceSetStatus('off', 'Inactif');
    voiceAddMsg('system', 'Wake word desactive.');
  }
}

function voiceSendText() {
  const input = document.getElementById('voice-text-input');
  if (!input) return;
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  if (voiceMode === 'cloud') {
    // Cloud mode: send text via WebSocket
    if (!voiceWs || voiceWs.readyState !== 1) {
      // Start session first, then send
      voiceStartCloudSession();
      // Wait for ready, then send text
      const waitAndSend = setInterval(() => {
        if (voiceWs && voiceWs.readyState === 1) {
          clearInterval(waitAndSend);
          voiceWs.send(JSON.stringify({ type: 'text', text }));
          voiceAddMsg('user', text);
        }
      }, 500);
      setTimeout(() => clearInterval(waitAndSend), 10000);
    } else {
      voiceWs.send(JSON.stringify({ type: 'text', text }));
      voiceAddMsg('user', text);
    }
  } else {
    // Local mode: existing behavior
    if (voiceSessionActive) voiceStopLocalSession();
    voiceSessionActive = true;
    voiceLocalProcessing = false;
    voiceFinalText = '';
    voiceStopWake();
    voiceProcessLocal(text);
  }
}

function loadVoice() {
  if (voiceInited) return;
  voiceInited = true;

  document.getElementById('voice-wake-toggle').addEventListener('click', voiceToggleWake);
  document.getElementById('voice-mic-btn').addEventListener('click', voiceToggleSession);
  document.getElementById('voice-send-btn').addEventListener('click', voiceSendText);
  document.getElementById('voice-text-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); voiceSendText(); }
  });
  // Mode toggle button
  const modeBtn = document.getElementById('voice-mode-toggle');
  if (modeBtn) {
    modeBtn.addEventListener('click', voiceToggleMode);
    modeBtn.innerHTML = voiceMode === 'cloud' ? '&#9729; Gemini' : '&#9729; Local';
    modeBtn.title = voiceMode === 'cloud' ? 'Mode: Gemini Live (streaming)' : 'Mode: Local (Ollama + TTS)';
  }

  if (!hasVoiceWebSpeech() && voiceMode === 'local') {
    voiceAddMsg('system', 'Web Speech API non supportee — utilise Gemini Live ou le texte.');
  }
}

// ══════════════════════════════════════════════════════════════
// ══════════════════════════════════════════════════════════════
// Engagement Dashboard
// ══════════════════════════════════════════════════════════════
let engagementRefreshTimer = null;

async function loadEngagement() {
  if (engagementRefreshTimer) clearInterval(engagementRefreshTimer);
  try {
    const data = await api('analytics/engagement');
    renderEngagement(data);
    engagementRefreshTimer = setInterval(async () => {
      if (currentView !== 'engagement') { clearInterval(engagementRefreshTimer); return; }
      try { const d = await api('analytics/engagement'); renderEngagement(d); } catch {}
    }, 60000);
  } catch (err) {
    document.getElementById('engagement-body').innerHTML = `<p style="color:var(--red);">${err.message}</p>`;
  }
}

function renderEngagement(data) {
  const t = data.trading || {};
  const c = data.content || {};
  const p = data.pipeline || {};
  const r = data.revenue || {};
  const tokens = Array.isArray(data.tokenUsage) ? data.tokenUsage : [];
  const agents = Array.isArray(data.agentPerformance) ? data.agentPerformance : [];
  const decisions = data.decisions || {};

  const tPnL = t.totalPnL || 0;
  const tColor = tPnL >= 0 ? 'var(--green, #22c55e)' : 'var(--red, #ef4444)';

  let html = `
    <div class="cards-grid">
      <div class="card">
        <div class="card-title">Trading P&L</div>
        <div class="card-value" style="font-size:22px;color:${tColor};">${tPnL >= 0 ? '+' : ''}$${tPnL.toFixed(2)}</div>
        <div class="card-sub">${t.positionCount || 0} positions | Equity: $${(t.equity || 0).toLocaleString()}</div>
      </div>
      <div class="card">
        <div class="card-title">Revenue</div>
        <div class="card-value" style="font-size:22px;color:${(r.net || 0) >= 0 ? 'var(--green, #22c55e)' : 'var(--red, #ef4444)'};">$${(r.net || 0).toFixed(2)}</div>
        <div class="card-sub">Income: $${(r.totalIncome || 0).toFixed(0)} | Expenses: $${(r.totalExpenses || 0).toFixed(0)}</div>
      </div>
      <div class="card">
        <div class="card-title">Content</div>
        <div class="card-value" style="font-size:22px;">${c.total || 0}</div>
        <div class="card-sub">${c.published || 0} published | ${c.drafts || 0} drafts | ${c.last7d || 0} this week</div>
      </div>
      <div class="card">
        <div class="card-title">Lead Pipeline</div>
        <div class="card-value" style="font-size:22px;">${p.total || 0}</div>
        <div class="card-sub">${(p.byStatus || []).map(s => s.status + ': ' + s.count).join(' | ') || 'No leads'}</div>
      </div>
    </div>`;

  // Trading positions table
  if (t.positions && t.positions.length > 0) {
    html += `<h3 style="margin:20px 0 8px;color:var(--text1);">Positions</h3>
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead><tr style="border-bottom:1px solid var(--border);text-align:left;">
          <th style="padding:6px;">Symbol</th>
          <th style="padding:6px;text-align:right;">Qty</th>
          <th style="padding:6px;text-align:right;">Price</th>
          <th style="padding:6px;text-align:right;">P&L</th>
          <th style="padding:6px;text-align:right;">P&L %</th>
          <th style="padding:6px;text-align:right;">Day %</th>
        </tr></thead><tbody>`;
    for (const pos of t.positions) {
      const plCol = pos.pnl >= 0 ? 'var(--green, #22c55e)' : 'var(--red, #ef4444)';
      const dayCol = pos.changePct >= 0 ? 'var(--green, #22c55e)' : 'var(--red, #ef4444)';
      html += `<tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px;font-weight:600;">${escapeHtml(pos.symbol)}</td>
        <td style="padding:6px;text-align:right;">${pos.qty}</td>
        <td style="padding:6px;text-align:right;">$${pos.currentPrice.toFixed(2)}</td>
        <td style="padding:6px;text-align:right;color:${plCol};">${pos.pnl >= 0 ? '+' : ''}$${pos.pnl.toFixed(2)}</td>
        <td style="padding:6px;text-align:right;color:${plCol};">${pos.pnlPct >= 0 ? '+' : ''}${pos.pnlPct.toFixed(1)}%</td>
        <td style="padding:6px;text-align:right;color:${dayCol};">${pos.changePct >= 0 ? '+' : ''}${pos.changePct.toFixed(1)}%</td>
      </tr>`;
    }
    html += `</tbody></table>`;
  }

  // Agent performance
  if (agents.length > 0) {
    html += `<h3 style="margin:20px 0 8px;color:var(--text1);">Agent Performance (24h)</h3>
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead><tr style="border-bottom:1px solid var(--border);text-align:left;">
          <th style="padding:6px;">Agent</th>
          <th style="padding:6px;text-align:right;">Runs</th>
          <th style="padding:6px;text-align:right;">Success</th>
          <th style="padding:6px;text-align:right;">Errors</th>
          <th style="padding:6px;text-align:right;">Avg Duration</th>
        </tr></thead><tbody>`;
    for (const a of agents) {
      const rate = a.runs > 0 ? Math.round(a.successes / a.runs * 100) : 0;
      const rateCol = rate >= 90 ? 'var(--green, #22c55e)' : rate >= 70 ? 'var(--yellow, #eab308)' : 'var(--red, #ef4444)';
      html += `<tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px;">${escapeHtml(a.agent_id)}</td>
        <td style="padding:6px;text-align:right;">${a.runs}</td>
        <td style="padding:6px;text-align:right;color:${rateCol};">${a.successes} (${rate}%)</td>
        <td style="padding:6px;text-align:right;color:${a.errors > 0 ? 'var(--red, #ef4444)' : 'var(--text2)'};">${a.errors}</td>
        <td style="padding:6px;text-align:right;">${a.avg_duration_ms ? (a.avg_duration_ms / 1000).toFixed(1) + 's' : '-'}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
  }

  // Token usage
  if (tokens.length > 0) {
    html += `<h3 style="margin:20px 0 8px;color:var(--text1);">Token Usage (7d)</h3>
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead><tr style="border-bottom:1px solid var(--border);text-align:left;">
          <th style="padding:6px;">Provider</th>
          <th style="padding:6px;text-align:right;">Requests</th>
          <th style="padding:6px;text-align:right;">Input Tokens</th>
          <th style="padding:6px;text-align:right;">Output Tokens</th>
          <th style="padding:6px;text-align:right;">Est. Cost</th>
        </tr></thead><tbody>`;
    for (const t of tokens) {
      html += `<tr style="border-bottom:1px solid var(--border);">
        <td style="padding:6px;">${escapeHtml(t.provider)}</td>
        <td style="padding:6px;text-align:right;">${(t.requests || 0).toLocaleString()}</td>
        <td style="padding:6px;text-align:right;">${(t.input_tokens || 0).toLocaleString()}</td>
        <td style="padding:6px;text-align:right;">${(t.output_tokens || 0).toLocaleString()}</td>
        <td style="padding:6px;text-align:right;">$${(t.cost || 0).toFixed(4)}</td>
      </tr>`;
    }
    html += `</tbody></table>`;
  }

  // Autonomous decisions
  if (decisions.last24h > 0) {
    html += `<h3 style="margin:20px 0 8px;color:var(--text1);">Autonomous Decisions (24h): ${decisions.last24h}</h3>`;
    if (decisions.byCategory && decisions.byCategory.length > 0) {
      html += `<div style="display:flex;gap:8px;flex-wrap:wrap;">`;
      for (const cat of decisions.byCategory) {
        html += `<span style="background:var(--bg3);padding:4px 10px;border-radius:12px;font-size:12px;">${escapeHtml(cat.category)}: ${cat.count}</span>`;
      }
      html += `</div>`;
    }
  }

  // Content by platform
  if (c.byPlatform && c.byPlatform.length > 0) {
    html += `<h3 style="margin:20px 0 8px;color:var(--text1);">Content by Platform</h3>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">`;
    for (const plat of c.byPlatform) {
      html += `<span style="background:var(--bg3);padding:4px 10px;border-radius:12px;font-size:12px;">${escapeHtml(plat.platform)}: ${plat.count}</span>`;
    }
    html += `</div>`;
  }

  document.getElementById('engagement-body').innerHTML = html;
}

// ══════════════════════════════════════════════════════════════
// Gallery
// ══════════════════════════════════════════════════════════════
async function loadGallery() {
  const grid = document.getElementById('gallery-grid');
  const empty = document.getElementById('gallery-empty');
  const count = document.getElementById('gallery-count');
  if (!grid) return;
  grid.innerHTML = '<div style="color:var(--text2);">Chargement...</div>';
  let files = [];
  try {
    const data = await api('gallery');
    files = data.files || [];
  } catch {
    // API not available yet (server needs restart) — probe known images
    const knownImages = [
      'design-tshirt-bastilon-transparent.png', 'design-tshirt-bastilon-raw.png',
      'design-tshirt-bastilon.png', 'meme-console-log.png',
      'design-01-404-shell.png', 'design-02-sudo-ocean.png', 'design-03-coding-3am.png',
      'photo_8189338836_1770442023236.jpg', 'photo_8189338836_1770565450654.jpg',
      'photo_8189338836_1770572624766.jpg', 'photo_8189338836_1770771134136.jpg',
      'photo_8189338836_1770775563049.jpg', 'photo_8189338836_1770793703478.jpg',
      'photo_8189338836_1770793848252.jpg', 'photo_8189338836_1770833120341.jpg'
    ];
    // Probe each to see if it exists
    const probes = await Promise.allSettled(
      knownImages.map(name => fetch('/uploads/' + name, { method: 'HEAD' }).then(r => r.ok ? name : null))
    );
    files = probes
      .filter(p => p.status === 'fulfilled' && p.value)
      .map(p => ({ name: p.value, url: '/uploads/' + p.value, size: 0, mtime: Date.now() }));
  }
  if (count) count.textContent = files.length + ' images';
  if (files.length === 0) {
    grid.innerHTML = '';
    if (empty) empty.style.display = 'flex';
    return;
  }
  if (empty) empty.style.display = 'none';
  grid.innerHTML = files.map(f => {
    const sizeKB = f.size ? Math.round(f.size / 1024) + ' KB' : '';
    const date = f.mtime > 1000000000000 ? new Date(f.mtime).toLocaleDateString('fr-CA') : '';
    const info = [sizeKB, date].filter(Boolean).join(' — ');
    return `<div class="gallery-item" onclick="openGalleryPreview('${escapeHtml(f.url)}', '${escapeHtml(f.name)}', '${escapeHtml(info)}')">
      <img src="${escapeHtml(f.url)}" alt="${escapeHtml(f.name)}" loading="lazy"
        onerror="this.parentElement.style.display='none'">
      <div class="gallery-item-info">
        <span class="gallery-item-name">${escapeHtml(f.name)}</span>
        <span>${escapeHtml(info)}</span>
      </div>
    </div>`;
  }).join('');
}

function openGalleryPreview(url, name, info) {
  const overlay = document.getElementById('gallery-preview-overlay');
  const img = document.getElementById('gallery-preview-img');
  const infoEl = document.getElementById('gallery-preview-info');
  if (overlay && img) {
    img.src = url;
    if (infoEl) infoEl.textContent = name + ' — ' + info;
    overlay.classList.add('visible');
  }
}

function closeGalleryPreview() {
  const overlay = document.getElementById('gallery-preview-overlay');
  if (overlay) overlay.classList.remove('visible');
}

// Keyboard: Escape closes gallery preview
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') closeGalleryPreview();
});

// ══════════════════════════════════════════════════════════════
// Dungeon Master
// ══════════════════════════════════════════════════════════════
let dungeonActiveSession = null;

async function loadDungeon() {
  if (dungeonActiveSession) {
    await dungeonLoadSession(dungeonActiveSession);
  } else {
    await dungeonShowSessions();
  }
}

async function dungeonShowSessions() {
  dungeonActiveSession = null;
  document.getElementById('dungeon-selector').style.display = 'block';
  document.getElementById('dungeon-game').style.display = 'none';
  document.getElementById('dungeon-session-name').textContent = '';
  try {
    const data = await api('dungeon/sessions');
    const list = document.getElementById('dungeon-sessions-list');
    if (!data.sessions || data.sessions.length === 0) {
      list.innerHTML = '<div style="color:var(--text2);font-size:13px;padding:20px;text-align:center;">Aucune campagne. Creez-en une ci-dessus!</div>';
      return;
    }
    list.innerHTML = data.sessions.map(s => {
      const status = s.status === 'active' ? '<span style="color:var(--green);">&#9679;</span>' : s.status === 'paused' ? '<span style="color:var(--yellow);">&#9646;&#9646;</span>' : '<span style="color:var(--text2);">&#10003;</span>';
      const date = new Date(s.created_at * 1000).toLocaleDateString('fr-CA');
      return `<div style="display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;cursor:pointer;" onclick="dungeonLoadSession(${s.id})">
        <div>${status} <b>${escapeHtml(s.name)}</b> <span style="color:var(--text2);font-size:12px;">— ${escapeHtml(s.setting||'Fantasy')} — Tour ${s.turn_number}</span></div>
        <div style="display:flex;gap:6px;align-items:center;">
          <span style="color:var(--text2);font-size:11px;">${date}</span>
          <button onclick="event.stopPropagation();dungeonDelete(${s.id})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:14px;" title="Supprimer">&#128465;</button>
        </div>
      </div>`;
    }).join('');
  } catch (e) {
    document.getElementById('dungeon-sessions-list').innerHTML = '<div style="color:var(--red);">Erreur: ' + escapeHtml(e.message) + '</div>';
  }
}

async function dungeonCreate() {
  const name = document.getElementById('dungeon-new-name').value.trim();
  const setting = document.getElementById('dungeon-new-setting').value.trim();
  const chars = document.getElementById('dungeon-new-chars').value.trim();
  if (!name) return alert('Donnez un nom a la campagne');
  try {
    const data = await postApi('dungeon/create', {
      name, setting: setting || 'Heroic Fantasy', characters: chars || 'Aventurier/Humain/Guerrier'
    });
    if (data.session) {
      document.getElementById('dungeon-new-name').value = '';
      document.getElementById('dungeon-new-setting').value = '';
      await dungeonLoadSession(data.session.id);
      return;
    }
  } catch (e) {
    console.error('Create error:', e);
  }
  await dungeonShowSessions();
}

async function dungeonLoadSession(id) {
  dungeonActiveSession = id;
  document.getElementById('dungeon-selector').style.display = 'none';
  document.getElementById('dungeon-game').style.display = 'flex';
  try {
    const data = await api('dungeon/session/' + id);
    if (!data.session) { dungeonActiveSession = null; return dungeonShowSessions(); }
    document.getElementById('dungeon-session-name').textContent = data.session.name + ' — ' + data.session.current_location;
    dungeonRenderParty(data.characters || []);
    dungeonRenderNarrative(data.turns || []);
    dungeonRenderScenes(data.turns || []);
  } catch (e) {
    console.error('Dungeon load error:', e);
  }
}

function dungeonRenderParty(characters) {
  const el = document.getElementById('dungeon-characters');
  if (!characters.length) { el.innerHTML = '<div style="color:var(--text2);font-size:12px;">Aucun personnage</div>'; return; }
  el.innerHTML = characters.map(c => {
    const hpPct = c.hp_max > 0 ? Math.round((c.hp / c.hp_max) * 100) : 0;
    const hpColor = hpPct > 60 ? 'var(--green)' : hpPct > 30 ? 'var(--yellow)' : 'var(--red)';
    const tag = c.is_npc ? ' <span style="color:var(--text2);font-size:10px;">(PNJ)</span>' : '';
    const stats = c.stats || {};
    const statStr = Object.keys(stats).length > 0 ? Object.entries(stats).map(([k,v]) => k.toUpperCase().slice(0,3) + ':' + v).join(' ') : '';
    const inv = Array.isArray(c.inventory) ? c.inventory : [];
    return `<div style="margin-bottom:12px;padding:8px;background:var(--bg);border-radius:6px;border:1px solid var(--border);">
      <div style="font-weight:600;font-size:12px;">${escapeHtml(c.name)}${tag}</div>
      <div style="font-size:11px;color:var(--text2);">${escapeHtml(c.race)} ${escapeHtml(c.class)} Niv.${c.level}</div>
      <div style="margin:4px 0;">
        <div style="display:flex;align-items:center;gap:6px;">
          <div style="flex:1;height:6px;background:var(--bg2);border-radius:3px;overflow:hidden;">
            <div style="height:100%;width:${hpPct}%;background:${hpColor};border-radius:3px;transition:width 0.3s;"></div>
          </div>
          <span style="font-size:10px;color:${hpColor};">${c.hp}/${c.hp_max}</span>
        </div>
      </div>
      ${statStr ? '<div style="font-size:10px;color:var(--text2);font-family:monospace;">' + statStr + '</div>' : ''}
      ${inv.length > 0 ? '<details style="margin-top:4px;"><summary style="font-size:10px;color:var(--text2);cursor:pointer;">Inventaire (' + inv.length + ')</summary><div style="font-size:10px;color:var(--text2);padding:4px 0;">' + inv.map(i => '- ' + escapeHtml(i)).join('<br>') + '</div></details>' : ''}
    </div>`;
  }).join('');
}

function dungeonRenderNarrative(turns) {
  const el = document.getElementById('dungeon-narrative');
  if (!turns.length) {
    el.innerHTML = '<div style="color:var(--text2);text-align:center;padding:40px;font-size:14px;"><div style="font-size:48px;margin-bottom:12px;">&#128009;</div>L\'aventure attend... Entrez votre premiere action ci-dessous!</div>';
    return;
  }
  el.innerHTML = turns.map(t => {
    let html = '';
    if (t.player_action) {
      html += `<div style="margin-bottom:8px;"><div style="display:inline-block;padding:8px 14px;background:var(--accent);color:#fff;border-radius:12px 12px 2px 12px;max-width:80%;font-size:13px;"><b>Joueur:</b> ${escapeHtml(t.player_action)}</div></div>`;
    }
    if (t.dm_narrative) {
      const narrative = t.dm_narrative.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>').replace(/\*([^*]+)\*/g, '<i>$1</i>').replace(/\[([^\]]+)\]/g, '<span style="color:var(--yellow);font-family:monospace;">[$1]</span>').replace(/\n/g, '<br>');
      html += `<div style="margin-bottom:8px;"><div style="padding:12px 16px;background:var(--bg2);border-left:3px solid var(--yellow);border-radius:4px;font-size:13px;line-height:1.6;color:var(--text);">${narrative}</div>`;
      if (t.event_type) html += `<div style="font-size:10px;color:var(--text2);margin-top:2px;">Tour ${t.turn_number} &middot; ${t.event_type}</div>`;
      html += '</div>';
    }
    if (t.image_url) {
      html += `<div style="margin-bottom:8px;text-align:center;"><img src="${escapeHtml(t.image_url)}" style="max-width:100%;max-height:300px;border-radius:8px;border:1px solid var(--border);" loading="lazy"></div>`;
    }
    return html;
  }).join('<div style="border-top:1px solid var(--border);margin:12px 0;"></div>');
  // Scroll to bottom
  setTimeout(() => el.scrollTop = el.scrollHeight, 100);
}

function dungeonRenderScenes(turns) {
  const mainEl = document.getElementById('dungeon-scene-main');
  const galleryEl = document.getElementById('dungeon-scene-gallery');
  const scenes = turns.filter(t => t.image_url).reverse();
  if (scenes.length === 0) {
    mainEl.innerHTML = '<div style="text-align:center;color:var(--text2);font-size:12px;padding:20px;">&#127912; Cliquez le bouton peinture pour generer une scene</div>';
    galleryEl.innerHTML = '';
    return;
  }
  const latest = scenes[0];
  mainEl.innerHTML = `<img src="${escapeHtml(latest.image_url)}" style="width:100%;border-radius:8px;border:1px solid var(--border);" loading="lazy">
    <div style="font-size:11px;color:var(--text2);margin-top:4px;">Tour ${latest.turn_number}</div>`;
  galleryEl.innerHTML = scenes.slice(1, 9).map(s =>
    `<img src="${escapeHtml(s.image_url)}" style="width:calc(50% - 2px);aspect-ratio:3/2;object-fit:cover;border-radius:4px;cursor:pointer;border:1px solid var(--border);" onclick="document.getElementById('dungeon-scene-main').querySelector('img').src='${escapeHtml(s.image_url)}'" loading="lazy">`
  ).join('');
}

async function dungeonPlay() {
  if (!dungeonActiveSession) return;
  const input = document.getElementById('dungeon-action-input');
  const action = input.value.trim();
  if (!action) return;
  input.value = '';
  const btn = document.getElementById('dungeon-play-btn');
  btn.disabled = true;
  btn.textContent = '...';
  // Immediately show player action
  const narrative = document.getElementById('dungeon-narrative');
  narrative.innerHTML += `<div style="border-top:1px solid var(--border);margin:12px 0;"></div><div style="margin-bottom:8px;"><div style="display:inline-block;padding:8px 14px;background:var(--accent);color:#fff;border-radius:12px 12px 2px 12px;max-width:80%;font-size:13px;"><b>Joueur:</b> ${escapeHtml(action)}</div></div>`;
  narrative.scrollTop = narrative.scrollHeight;
  try {
    const data = await postApi('dungeon/play', { session_id: dungeonActiveSession, action });
    // Render DM response
    if (data.narrative) {
      const dm = data.narrative.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>').replace(/\*([^*]+)\*/g, '<i>$1</i>').replace(/\[([^\]]+)\]/g, '<span style="color:var(--yellow);font-family:monospace;">[$1]</span>').replace(/\n/g, '<br>');
      narrative.innerHTML += `<div style="margin-bottom:8px;"><div style="padding:12px 16px;background:var(--bg2);border-left:3px solid var(--yellow);border-radius:4px;font-size:13px;line-height:1.6;color:var(--text);">${dm}</div></div>`;
    }
    if (data.characters) dungeonRenderParty(data.characters);
    if (data.session) document.getElementById('dungeon-session-name').textContent = data.session.name + ' — ' + data.session.current_location;
    if (data.lastTurn && data.lastTurn.image_url) {
      document.getElementById('dungeon-scene-main').innerHTML = `<img src="${escapeHtml(data.lastTurn.image_url)}" style="width:100%;border-radius:8px;border:1px solid var(--border);">`;
    }
    narrative.scrollTop = narrative.scrollHeight;
  } catch (e) {
    narrative.innerHTML += `<div style="color:var(--red);padding:8px;">Erreur: ${escapeHtml(e.message)}</div>`;
  }
  btn.disabled = false;
  btn.textContent = 'Jouer';
}

async function dungeonQuickRoll(dice) {
  try {
    const data = await postApi('dungeon/roll', { dice });
    document.getElementById('dungeon-roll-result').innerHTML = data.result ? data.result.replace(/\*\*([^*]+)\*\*/g, '<b>$1</b>') : dice;
  } catch (e) {
    document.getElementById('dungeon-roll-result').textContent = 'Erreur: ' + e.message;
  }
}

async function dungeonGenerateScene() {
  if (!dungeonActiveSession) return;
  try {
    const data = await postApi('dungeon/scene', { session_id: dungeonActiveSession });
    if (data.result) {
      const imgMatch = data.result.match(/!\[.*?\]\((.+?)\)/);
      if (imgMatch) {
        document.getElementById('dungeon-scene-main').innerHTML = `<img src="${escapeHtml(imgMatch[1])}" style="width:100%;border-radius:8px;border:1px solid var(--border);">`;
      }
    }
  } catch (e) {
    console.error('Scene generation error:', e);
  }
}

async function dungeonDelete(id) {
  if (!confirm('Supprimer cette campagne?')) return;
  try {
    const res = await fetch('/api/dungeon/session/' + id, {
      method: 'DELETE',
      headers: getAuthHeaders(),
    });
  } catch {}
  await dungeonShowSessions();
}

function dungeonBackToSessions() {
  dungeonActiveSession = null;
  dungeonShowSessions();
}

// Voice Sidebar
// ══════════════════════════════════════════════════════════════
let voiceSidebarCollapsed = false;

function toggleVoiceSidebar() {
  const sidebar = document.getElementById('voice-sidebar');
  const floatBtn = document.getElementById('voice-float-toggle');
  voiceSidebarCollapsed = !voiceSidebarCollapsed;
  if (voiceSidebarCollapsed) {
    sidebar.classList.add('collapsed');
    floatBtn.classList.add('visible');
  } else {
    sidebar.classList.remove('collapsed');
    floatBtn.classList.remove('visible');
  }
}

// ══════════════════════════════════════════════════════════════
// Init
// ══════════════════════════════════════════════════════════════
async function init() {
  connectWS();
  authToken = localStorage.getItem(AUTH_TOKEN_STORAGE_KEY) || '';
  const tokenInput = document.getElementById('auth-token');
  if (tokenInput && authToken) tokenInput.value = authToken;
  updateDirectTargetUi();

  addMessage('kingston', 'system', 'Chat Kingston. Utilise le menu lateral pour naviguer.');
  addMessage('emile', 'system', 'Chat Emile.');
  addMessage('aster', 'system', 'Mode Aster: Kingston + Emile en parallele.');
  addMessage('conseil', 'system', 'Mode Conseil: Kingston et Emile collaborent tour par tour.');

  // Init voice system immediately (available on all views)
  loadVoice();

  // Restore chat sidebar state
  if (localStorage.getItem('chat_sidebar_collapsed') === 'true') {
    document.getElementById('chat-sidebar').classList.add('collapsed');
  }

  // Route from hash
  const hash = location.hash.replace('#', '') || 'chat';
  if (hash !== 'chat') navigate(hash);
}

// Listen for hash changes
window.addEventListener('hashchange', () => {
  const hash = location.hash.replace('#', '') || 'chat';
  if (hash !== currentView) navigate(hash);
});

init();

// ── PWA Service Worker + Push Notifications ──
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/sw.js')
    .then(reg => console.log('[PWA] Service worker registered', reg.scope))
    .catch(err => console.warn('[PWA] SW registration failed:', err));
}

async function enablePushNotifications() {
  try {
    if (!('serviceWorker' in navigator) || !('PushManager' in window)) return;
    const reg = await navigator.serviceWorker.ready;
    // Check if already subscribed
    const existing = await reg.pushManager.getSubscription();
    if (existing) return; // Already subscribed
    // Get VAPID key from server
    const resp = await fetch('/api/push/vapid-key');
    const { key } = await resp.json();
    if (!key) return; // No VAPID key configured
    const sub = await reg.pushManager.subscribe({
      userVisibleOnly: true,
      applicationServerKey: key
    });
    // Send subscription to server
    await fetch('/api/push/subscribe', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-Auth-Token': AUTH },
      body: JSON.stringify(sub.toJSON())
    });
    console.log('[PWA] Push notifications enabled');
  } catch (e) {
    console.warn('[PWA] Push setup failed:', e);
  }
}

// Auto-enable push after 3 seconds (non-blocking)
setTimeout(enablePushNotifications, 3000);
</script>
</body>
</html>
