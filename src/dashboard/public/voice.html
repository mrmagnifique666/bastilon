<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kingston — Tableau de Bord</title>
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#0f1923">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Kingston">
<link rel="apple-touch-icon" href="/icon-192.png">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #0b1017; --bg2: #111921; --bg3: #182230; --bg4: #1e2d3d;
    --border: #1e2d3d; --border2: #2a3f54;
    --text: #c8d6e5; --text2: #8899aa; --text3: #556677;
    --accent: #4facfe; --accent2: #00f2fe; --gold: #f0c27f;
    --green: #00d68f; --red: #ff6b6b; --purple: #a78bfa;
    --card-shadow: 0 2px 12px rgba(0,0,0,0.3);
  }
  body {
    font-family: 'Inter', -apple-system, sans-serif;
    background: var(--bg); color: var(--text);
    height: 100vh; display: flex; overflow: hidden;
  }

  /* ─── Left Sidebar ─── */
  .sidebar {
    width: 64px; background: var(--bg2); border-right: 1px solid var(--border);
    display: flex; flex-direction: column; align-items: center;
    padding: 16px 0; gap: 6px; z-index: 10;
  }
  .sidebar .logo {
    width: 40px; height: 40px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    display: flex; align-items: center; justify-content: center;
    font-weight: 700; font-size: 18px; color: #fff; margin-bottom: 16px;
    box-shadow: 0 4px 15px rgba(79,172,254,0.3);
  }
  .nav-btn {
    width: 44px; height: 44px; border-radius: 12px; border: none;
    background: transparent; color: var(--text3); cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; transition: all 0.2s; position: relative;
  }
  .nav-btn:hover { background: var(--bg3); color: var(--text); }
  .nav-btn.active { background: var(--bg3); color: var(--accent); }
  .nav-btn .badge {
    position: absolute; top: 4px; right: 4px;
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--green);
  }
  .sidebar-bottom { margin-top: auto; display: flex; flex-direction: column; gap: 6px; }

  /* ─── Main Content ─── */
  .main-content {
    flex: 1; display: flex; flex-direction: column; overflow: hidden;
    background: var(--bg);
  }
  /* Top Bar */
  .topbar {
    height: 56px; padding: 0 24px; display: flex; align-items: center;
    justify-content: space-between; border-bottom: 1px solid var(--border);
    background: var(--bg2);
  }
  .topbar-left { display: flex; align-items: center; gap: 16px; }
  .topbar-title { font-size: 16px; font-weight: 600; }
  .topbar-title span { color: var(--accent); }
  .topbar-mode {
    font-size: 11px; padding: 3px 10px; border-radius: 20px;
    background: var(--bg3); color: var(--text2); font-weight: 500;
  }
  .topbar-right { display: flex; align-items: center; gap: 12px; }
  .status-pill {
    display: flex; align-items: center; gap: 6px;
    padding: 4px 12px; border-radius: 20px; background: var(--bg3);
    font-size: 12px; color: var(--text2);
  }
  .status-pill .dot {
    width: 8px; height: 8px; border-radius: 50%;
    transition: background 0.3s;
  }
  .dot-off { background: var(--text3); }
  .dot-wake { background: var(--gold); animation: pulse 2.5s infinite; }
  .dot-on { background: var(--green); }
  .dot-speak { background: var(--accent); animation: blink 1s infinite; }
  .dot-think { background: var(--purple); animation: blink 0.7s infinite; }
  @keyframes pulse { 50% { opacity: 0.4; } }
  @keyframes blink { 50% { opacity: 0.3; } }

  .topbar-btn {
    padding: 6px 14px; border-radius: 8px; border: 1px solid var(--border2);
    background: transparent; color: var(--text2); cursor: pointer;
    font-size: 12px; font-family: inherit; transition: all 0.15s;
  }
  .topbar-btn:hover { background: var(--bg3); color: var(--text); border-color: var(--accent); }
  .topbar-btn.on { background: rgba(79,172,254,0.12); color: var(--accent); border-color: var(--accent); }

  /* ─── Center Panel ─── */
  .center {
    flex: 1; overflow-y: auto; padding: 24px;
    display: flex; flex-direction: column; gap: 20px;
  }

  /* Dashboard Cards */
  .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
  .card {
    background: var(--bg2); border: 1px solid var(--border); border-radius: 14px;
    padding: 20px; box-shadow: var(--card-shadow); transition: border-color 0.2s;
  }
  .card:hover { border-color: var(--border2); }
  .card-label { font-size: 11px; color: var(--text3); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
  .card-value { font-size: 28px; font-weight: 700; margin: 6px 0 2px; color: #fff; }
  .card-sub { font-size: 12px; color: var(--text2); }
  .card-icon { font-size: 24px; float: right; opacity: 0.5; }

  /* Agent Status */
  .agents-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 14px; }
  .agent-card {
    background: var(--bg2); border: 1px solid var(--border); border-radius: 12px;
    padding: 16px; display: flex; align-items: center; gap: 14px;
  }
  .agent-avatar {
    width: 42px; height: 42px; border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px; flex-shrink: 0;
  }
  .agent-info { flex: 1; min-width: 0; }
  .agent-name { font-size: 14px; font-weight: 600; color: #fff; }
  .agent-stat { font-size: 12px; color: var(--text2); }
  .agent-badge {
    padding: 3px 8px; border-radius: 6px; font-size: 10px;
    font-weight: 600; text-transform: uppercase;
  }
  .agent-badge.ok { background: rgba(0,214,143,0.15); color: var(--green); }
  .agent-badge.err { background: rgba(255,107,107,0.15); color: var(--red); }

  /* Section Headers */
  .section-header {
    font-size: 13px; font-weight: 600; color: var(--text2);
    text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 4px;
  }

  /* Visual content area */
  .visual-area {
    flex: 1; display: flex; align-items: center; justify-content: center;
    min-height: 200px;
  }
  .visual-area img {
    max-width: 100%; max-height: 60vh; border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  }
  .visual-placeholder {
    color: var(--text3); text-align: center; font-size: 14px;
  }
  .visual-placeholder svg { opacity: 0.15; margin-bottom: 12px; }

  /* ─── Right Chat Panel ─── */
  .chat-panel {
    width: 380px; border-left: 1px solid var(--border);
    display: flex; flex-direction: column; background: var(--bg2);
  }
  .chat-panel.hidden { display: none; }
  .chat-header {
    padding: 14px 18px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; justify-content: space-between;
  }
  .chat-header-title { font-size: 13px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; }
  .chat-close {
    width: 28px; height: 28px; border-radius: 6px; border: none;
    background: transparent; color: var(--text3); cursor: pointer; font-size: 16px;
  }
  .chat-close:hover { background: var(--bg3); color: var(--text); }

  .transcript {
    flex: 1; overflow-y: auto; padding: 14px;
    display: flex; flex-direction: column; gap: 8px;
  }
  .msg {
    max-width: 95%; padding: 10px 14px; border-radius: 12px;
    font-size: 13px; line-height: 1.5; word-wrap: break-word;
  }
  .msg.user { align-self: flex-end; background: #1a3a6a; border-bottom-right-radius: 4px; }
  .msg.model { align-self: flex-start; background: var(--bg3); border-bottom-left-radius: 4px; }
  .msg.system { align-self: center; color: var(--text3); font-size: 11px; font-style: italic; padding: 4px 10px; }
  .msg.tool {
    align-self: flex-start; background: var(--bg); border-left: 2px solid var(--accent);
    font-size: 11px; color: var(--text2); max-width: 95%; padding: 6px 10px;
  }
  .msg .lbl {
    font-size: 9px; color: var(--text3); margin-bottom: 2px;
    text-transform: uppercase; font-weight: 600; letter-spacing: 0.3px;
  }
  .msg img { max-width: 100%; border-radius: 8px; margin: 4px 0; cursor: pointer; }
  .msg code { background: var(--bg); padding: 2px 5px; border-radius: 4px; font-size: 12px; color: var(--purple); }
  .msg pre { background: var(--bg); padding: 8px 10px; border-radius: 8px; overflow-x: auto; margin: 4px 0; font-size: 12px; border: 1px solid var(--border); white-space: pre-wrap; }
  .msg pre code { background: none; padding: 0; }
  .msg a { color: var(--accent); text-decoration: none; }
  .msg a:hover { text-decoration: underline; }
  .msg strong { color: #fff; }
  .msg blockquote { border-left: 2px solid var(--accent); padding-left: 8px; margin: 4px 0; color: var(--text2); font-style: italic; }

  /* Wake bar */
  .wake-bar {
    padding: 6px 14px; background: var(--bg); border-top: 1px solid var(--border);
    min-height: 26px; display: none;
  }
  .wake-bar.active { display: block; }
  #wakeText { font-size: 11px; color: var(--text3); font-style: italic; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
  #wakeText.heard { color: var(--gold); }

  /* Chat input */
  .chat-input {
    padding: 12px 14px; border-top: 1px solid var(--border);
    display: flex; gap: 8px;
  }
  .chat-input input {
    flex: 1; padding: 10px 14px; border-radius: 10px; border: 1px solid var(--border);
    background: var(--bg); color: var(--text); font-size: 13px;
    font-family: inherit; outline: none;
  }
  .chat-input input:focus { border-color: var(--accent); }
  .chat-input button {
    padding: 10px 16px; border-radius: 10px; border: none;
    background: var(--accent); color: #fff; cursor: pointer;
    font-size: 13px; font-weight: 600; font-family: inherit;
  }

  /* Voice controls (floating) */
  .voice-controls {
    position: fixed; bottom: 24px; left: 50%;
    transform: translateX(calc(-50% + 32px));
    display: flex; align-items: center; gap: 12px;
    background: var(--bg2); border: 1px solid var(--border2);
    padding: 10px 20px; border-radius: 50px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    z-index: 50;
  }
  .mic-btn {
    width: 56px; height: 56px; border-radius: 50%;
    border: 2px solid var(--border2); background: var(--bg3);
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 24px; transition: all 0.2s;
  }
  .mic-btn:hover { border-color: var(--accent); }
  .mic-btn.active { border-color: var(--green); background: rgba(0,214,143,0.12); animation: glow-green 2s infinite; }
  .mic-btn.speaking { border-color: var(--accent); background: rgba(79,172,254,0.12); }
  .mic-btn.processing { border-color: var(--purple); background: rgba(167,139,250,0.12); }
  .mic-btn.wake { border-color: var(--gold); background: rgba(240,194,127,0.1); }
  @keyframes glow-green { 50% { box-shadow: 0 0 20px rgba(0,214,143,0.3); } }
  .vc-btn {
    padding: 8px 14px; border-radius: 20px; border: 1px solid var(--border);
    background: transparent; color: var(--text2); cursor: pointer;
    font-size: 12px; font-family: inherit; transition: all 0.15s;
  }
  .vc-btn:hover { background: var(--bg3); color: var(--text); }
  .vc-btn.on { border-color: var(--accent); color: var(--accent); background: rgba(79,172,254,0.08); }

  /* Fullscreen image overlay */
  .img-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.92); z-index: 1000; cursor: zoom-out;
    justify-content: center; align-items: center;
  }
  .img-overlay.active { display: flex; }
  .img-overlay img { max-width: 95%; max-height: 95%; object-fit: contain; border-radius: 10px; }

  /* Webcam */
  .webcam-float {
    position: fixed; top: 70px; right: 400px;
    width: 180px; border-radius: 12px; overflow: hidden;
    border: 2px solid var(--border); background: #000; z-index: 20;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  }
  .webcam-float.hidden { display: none; }
  .webcam-float.vision { border-color: var(--purple); }
  .webcam-float video { width: 100%; display: block; transform: scaleX(-1); }
  canvas { display: none; }
</style>
</head>
<body>

<div class="img-overlay" id="imgOverlay" onclick="this.classList.remove('active')">
  <img id="overlayImg" src="" alt="">
</div>

<!-- ─── Left Sidebar ─── -->
<nav class="sidebar">
  <div class="logo">K</div>
  <button class="nav-btn active" id="navDash" title="Dashboard">
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="3" y="13" width="7" height="4" rx="1"/><rect x="13" y="3" width="4" height="14" rx="1"/></svg>
  </button>
  <button class="nav-btn" id="navAgents" title="Agents">
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="10" cy="7" r="3"/><path d="M3 18c0-4 3-7 7-7s7 3 7 7"/></svg>
    <div class="badge"></div>
  </button>
  <button class="nav-btn" id="navMemory" title="Memoire">
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><path d="M10 2a8 8 0 1 0 0 16 8 8 0 0 0 0-16z"/><path d="M10 6v4l3 2"/></svg>
  </button>
  <button class="nav-btn" id="navTrading" title="Trading">
    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 14 7 10 11 13 17 5"/><polyline points="13 5 17 5 17 9"/></svg>
  </button>
  <div class="sidebar-bottom">
    <button class="nav-btn" id="navSettings" title="Parametres">
      <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2"><circle cx="10" cy="10" r="3"/><path d="M10 1v3m0 12v3M1 10h3m12 0h3M3.5 3.5l2 2m9 9 2 2M16.5 3.5l-2 2m-9 9-2 2"/></svg>
    </button>
  </div>
</nav>

<!-- ─── Main Content ─── -->
<div class="main-content">
  <div class="topbar">
    <div class="topbar-left">
      <div class="topbar-title"><span>Kingston</span> Dashboard</div>
      <div class="topbar-mode" id="modeLabel">Local</div>
    </div>
    <div class="topbar-right">
      <div class="status-pill">
        <div class="dot dot-off" id="statusDot"></div>
        <span id="statusLabel">Pret</span>
      </div>
      <button class="topbar-btn" id="modeBtn">Mode: Local</button>
      <button class="topbar-btn" id="wakeBtn">Computer</button>
      <button class="topbar-btn" id="chatToggle">Chat</button>
    </div>
  </div>

  <div class="center" id="centerPanel">
    <!-- Dashboard view (default) -->
    <div id="viewDash">
      <div class="section-header">Vue d'ensemble</div>
      <div class="cards" id="statsCards">
        <div class="card"><div class="card-icon">&#x23F1;</div><div class="card-label">Uptime</div><div class="card-value" id="statUptime">--</div><div class="card-sub">heures</div></div>
        <div class="card"><div class="card-icon">&#x1F4AC;</div><div class="card-label">Notes</div><div class="card-value" id="statNotes">--</div><div class="card-sub">enregistrees</div></div>
        <div class="card"><div class="card-icon">&#x1F9E0;</div><div class="card-label">Memoire</div><div class="card-value" id="statMemory">--</div><div class="card-sub">souvenirs</div></div>
        <div class="card"><div class="card-icon">&#x1F916;</div><div class="card-label">Skills</div><div class="card-value" id="statSkills">--</div><div class="card-sub">disponibles</div></div>
      </div>

      <div class="section-header" style="margin-top:8px">Agents</div>
      <div class="agents-grid" id="agentsGrid"></div>

      <div class="section-header" style="margin-top:8px">Contenu Visuel</div>
      <div class="visual-area" id="visualArea">
        <div class="visual-placeholder">
          <svg width="64" height="64" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="m21 15-5-5L5 21"/></svg>
          <div>Les images et visuels de Kingston apparaitront ici</div>
        </div>
      </div>
    </div>

    <!-- Agents view -->
    <div id="viewAgents" style="display:none">
      <div class="section-header">Agents — Statut Detaille</div>
      <div class="agents-grid" id="agentsDetailGrid"></div>
    </div>

    <!-- Memory view -->
    <div id="viewMemory" style="display:none">
      <div class="section-header">Memoire — Statistiques</div>
      <div class="cards" id="memoryCards"></div>
    </div>

    <!-- Trading view -->
    <div id="viewTrading" style="display:none">
      <div class="section-header">Trading — Portefeuille</div>
      <div class="cards" id="tradingCards"></div>
    </div>
  </div>
</div>

<!-- ─── Right Chat Panel ─── -->
<div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <span class="chat-header-title">Conversation</span>
    <button class="chat-close" id="chatCloseBtn" title="Fermer">&times;</button>
  </div>
  <div class="transcript" id="transcript">
    <div class="msg system">Dis "Computer" ou appuie sur le micro.</div>
  </div>
  <div class="wake-bar" id="wakeBar"><div id="wakeText">...</div></div>
  <div class="chat-input">
    <input id="textIn" placeholder="Message..." />
    <button id="textSend">&#x27A4;</button>
  </div>
</div>

<!-- Webcam float -->
<div class="webcam-float hidden" id="camBox">
  <video id="camVideo" autoplay playsinline muted></video>
  <canvas id="camCanvas"></canvas>
</div>

<!-- ─── Floating Voice Controls ─── -->
<div class="voice-controls" id="voiceControls">
  <button class="vc-btn" id="vcWake">Computer</button>
  <button class="mic-btn" id="micBtn" title="Parler">&#x1F3A4;</button>
  <button class="vc-btn" id="vcCam">Webcam</button>
</div>

<script>
// ═══════════════════════════════════════════════════════
// Kingston Dashboard — Voice + Dashboard + Agents
// ═══════════════════════════════════════════════════════

const API = window.location.origin;
const WS_URL = API.replace(/^http/, 'ws') + '/ws/voice';
const TOKEN = localStorage.getItem('bastilon_token') || '';
const WAKE_REGEX = /comput[eè]r|comput[eè]ur|komput[eè]r|ordinat[eè]ur|computer/i;

// Only prompt for token if server requires one (check /api/stats first)
if (!TOKEN) {
  fetch(API + '/api/stats').then(r => {
    if (r.status === 401 || r.status === 403) {
      const t = prompt('Token Bastilon:');
      if (t) { localStorage.setItem('bastilon_token', t); location.reload(); }
    }
    // If 200, no token needed — proceed without auth
  }).catch(() => {});
}

// ─── Mode ───
let voiceMode = localStorage.getItem('kingston_voice_mode') || 'local';

// ─── State ───
let ws = null, sessionActive = false, micStream = null, audioCtx = null, workletNode = null;
let playCtx = null, nextPlayTime = 0, playQueue = [];
let webcamOn = false, visionOn = false, visionInterval = null;
let currentTranscriptEl = null, isSpeaking = false;
let wakeWordEnabled = false, wakeRecognition = null, wakeWordActive = false;
let localRecognition = null, localListening = false, localProcessing = false;
let localAudio = null, localSilenceTimer = null, localFinalText = '';

// ─── Language detection for dual voice ───
// Returns 'fr-male' or 'en-male' based on text content
function detectVoice(text) {
  if (!text) return 'fr-male';
  const lower = text.toLowerCase();
  // Common French indicators (accents, words)
  const frSignals = (lower.match(/[àâäéèêëïîôùûüÿçœæ]/g) || []).length;
  const frWords = ['je ', 'tu ', 'il ', 'elle ', 'nous ', 'vous ', 'les ', 'des ', 'est ', 'une ', 'dans ', 'pour ', 'que ', 'qui ', 'sur ', 'avec ', 'pas ', 'mais ', 'oui ', 'non ', 'bien ', 'fait ', 'très ', 'comme ', 'cette ', 'sont ', 'tout ', 'aussi ', 'entre ', 'après ', 'donc ', 'ici ', 'ses ', 'mes ', 'tes ', 'leur ', "c'est ", "j'ai ", "l'", "d'", "n'", "qu'"];
  const enWords = ['the ', 'is ', 'are ', 'was ', 'were ', 'have ', 'has ', 'been ', 'will ', 'would ', 'could ', 'should ', 'this ', 'that ', 'with ', 'from ', 'they ', 'what ', 'when ', 'where ', 'which ', 'there ', 'their ', 'your ', 'about ', 'just ', 'been ', 'some ', 'than ', 'them ', 'into ', "it's ", "don't ", "can't ", "i'm ", "you're "];
  let frScore = frSignals * 2;
  let enScore = 0;
  for (const w of frWords) { if (lower.includes(w)) frScore++; }
  for (const w of enWords) { if (lower.includes(w)) enScore++; }
  return enScore > frScore ? 'en-male' : 'fr-male';
}

// ─── DOM ───
const $ = id => document.getElementById(id);
const statusDot = $('statusDot'), statusLabel = $('statusLabel');
const transcript = $('transcript'), micBtn = $('micBtn'), textIn = $('textIn');
const wakeBar = $('wakeBar'), wakeText = $('wakeText');
const chatPanel = $('chatPanel'), centerPanel = $('centerPanel');
const camVideo = $('camVideo'), camCanvas = $('camCanvas'), camBox = $('camBox');

// ═══════════════════════════════════════════════════════
// Status + UI
// ═══════════════════════════════════════════════════════
function setStatus(state, label) {
  statusLabel.textContent = label;
  statusDot.className = 'dot ' + ({
    disconnected:'dot-off', wakeword:'dot-wake', connecting:'dot-off',
    ready:'dot-on', 'local-listening':'dot-on', listening:'dot-on',
    speaking:'dot-speak', processing:'dot-think'
  }[state] || 'dot-off');
  const mic = micBtn;
  if (state === 'ready' || state === 'listening' || state === 'local-listening') {
    mic.className = 'mic-btn active'; mic.innerHTML = '&#x1F534;';
  } else if (state === 'speaking') {
    mic.className = 'mic-btn speaking'; mic.innerHTML = '&#x1F50A;';
  } else if (state === 'processing') {
    mic.className = 'mic-btn processing'; mic.innerHTML = '&#x23F3;';
  } else if (state === 'wakeword') {
    mic.className = 'mic-btn wake'; mic.innerHTML = '&#x1F514;';
  } else {
    mic.className = 'mic-btn'; mic.innerHTML = '&#x1F3A4;';
  }
}

function addMsg(role, text) {
  const div = document.createElement('div');
  div.className = 'msg ' + role;
  if (role === 'user' || role === 'model') {
    const lbl = document.createElement('div');
    lbl.className = 'lbl';
    lbl.textContent = role === 'user' ? 'Toi' : 'Kingston';
    div.appendChild(lbl);
  }
  const content = document.createElement('div');
  if (role === 'model' || role === 'tool') {
    content.innerHTML = renderRich(text);
    const imgs = content.querySelectorAll('img');
    imgs.forEach(img => {
      img.addEventListener('click', e => {
        e.stopPropagation();
        $('overlayImg').src = img.src;
        $('imgOverlay').classList.add('active');
        showVisual(img.src);
      });
    });
    // Auto-show first image in center visual area
    if (imgs.length > 0) setTimeout(() => showVisual(imgs[0].src), 100);
  } else { content.textContent = text; }
  div.appendChild(content);
  transcript.appendChild(div);
  transcript.scrollTop = transcript.scrollHeight;
  // Auto-show chat panel on new model messages
  if (role === 'model') chatPanel.classList.remove('hidden');
  return div;
}

function renderRich(t) {
  if (!t) return '';
  let h = t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  h = h.replace(/```(\w*)\n?([\s\S]*?)```/g, (_,l,c) => '<pre><code>'+c.trim()+'</code></pre>');
  h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
  h = h.replace(/!\[([^\]]*)\]\(([^)]+)\)/g, (_,a,u) => '<img src="'+u+'" alt="'+a+'" loading="lazy">');
  h = h.replace(/(^|\n)(https?:\/\/[^\s]+\.(?:png|jpg|jpeg|gif|webp|svg)(?:\?[^\s]*)?)(\n|$)/gi, (_,p,u,s) => p+'<img src="'+u+'" loading="lazy">'+s);
  h = h.replace(/(data:image\/[a-z+]+;base64,[A-Za-z0-9+/=]+)/g, '<img src="$1" loading="lazy">');
  h = h.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
  h = h.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  h = h.replace(/(^|\n)&gt; (.+)/g, '$1<blockquote>$2</blockquote>');
  h = h.replace(/\n/g, '<br>');
  return h;
}

function showVisual(src) {
  const area = $('visualArea');
  area.innerHTML = '<img src="'+src+'" style="cursor:pointer" onclick="document.getElementById(\'overlayImg\').src=this.src;document.getElementById(\'imgOverlay\').classList.add(\'active\')">';
}

// ═══════════════════════════════════════════════════════
// Dashboard Data
// ═══════════════════════════════════════════════════════
async function apiFetch(path) {
  const r = await fetch(API + path, { headers: { 'X-Auth-Token': TOKEN } });
  return r.ok ? r.json() : null;
}

async function loadDashboard() {
  const [stats, agents, memory, skills] = await Promise.all([
    apiFetch('/api/stats'), apiFetch('/api/agents'),
    apiFetch('/api/memory/stats'), apiFetch('/api/skills'),
  ]);
  if (stats) {
    $('statUptime').textContent = Math.floor(stats.uptime / 3600000);
    $('statNotes').textContent = stats.noteCount;
  }
  if (memory) $('statMemory').textContent = memory.total || memory.count || '?';
  if (skills) $('statSkills').textContent = Array.isArray(skills) ? skills.length : skills.total || '?';

  if (agents && Array.isArray(agents)) {
    const colors = { scout:'#4facfe', analyst:'#00d68f', learner:'#a78bfa', executor:'#f0c27f', 'trading-monitor':'#ff6b6b', sentinel:'#ff9800', mind:'#00f2fe' };
    const icons = { scout:'&#x1F50D;', analyst:'&#x1F4CA;', learner:'&#x1F4DA;', executor:'&#x2699;', 'trading-monitor':'&#x1F4C8;', sentinel:'&#x1F6E1;', mind:'&#x1F9E0;' };
    const html = agents.map(a => `
      <div class="agent-card">
        <div class="agent-avatar" style="background:${colors[a.agent_id]||'#333'}22;color:${colors[a.agent_id]||'#888'}">${icons[a.agent_id]||'&#x1F916;'}</div>
        <div class="agent-info">
          <div class="agent-name">${a.agent_id}</div>
          <div class="agent-stat">${a.successes}/${a.total} runs &bull; ${Math.round(a.avg_duration/1000)}s moy</div>
        </div>
        <div class="agent-badge ${a.errors > 0 ? 'err' : 'ok'}">${a.errors > 0 ? a.errors+' err' : 'OK'}</div>
      </div>`).join('');
    $('agentsGrid').innerHTML = html;
    $('agentsDetailGrid').innerHTML = html;
  }
}

// ═══════════════════════════════════════════════════════
// Navigation
// ═══════════════════════════════════════════════════════
const views = ['Dash','Agents','Memory','Trading'];
function showView(name) {
  views.forEach(v => {
    const el = $('view'+v); if (el) el.style.display = v === name ? '' : 'none';
    const btn = $('nav'+v); if (btn) btn.classList.toggle('active', v === name);
  });
}
$('navDash').onclick = () => showView('Dash');
$('navAgents').onclick = () => showView('Agents');
$('navMemory').onclick = () => { showView('Memory'); loadMemoryView(); };
$('navTrading').onclick = () => { showView('Trading'); loadTradingView(); };
$('navSettings').onclick = () => window.open('/', '_blank');

async function loadMemoryView() {
  const mem = await apiFetch('/api/memory/stats');
  if (!mem) return;
  $('memoryCards').innerHTML = `
    <div class="card"><div class="card-label">Total</div><div class="card-value">${mem.total||mem.count||0}</div></div>
    <div class="card"><div class="card-label">Categories</div><div class="card-value">${Object.keys(mem.byCategory||{}).length}</div></div>
  ` + Object.entries(mem.byCategory||{}).map(([k,v]) =>
    `<div class="card"><div class="card-label">${k}</div><div class="card-value">${v}</div></div>`
  ).join('');
}

async function loadTradingView() {
  const data = await apiFetch('/api/trading');
  if (!data) { $('tradingCards').innerHTML = '<div class="card"><div class="card-label">Trading</div><div class="card-sub">Pas de donnees</div></div>'; return; }
  $('tradingCards').innerHTML = `
    <div class="card"><div class="card-label">Portfolio</div><div class="card-value">$${(data.equity||0).toLocaleString()}</div></div>
    <div class="card"><div class="card-label">Positions</div><div class="card-value">${(data.positions||[]).length}</div></div>
    <div class="card"><div class="card-label">P&L Jour</div><div class="card-value" style="color:${(data.dailyPnl||0)>=0?'var(--green)':'var(--red)'}">$${(data.dailyPnl||0).toFixed(2)}</div></div>
  `;
}

// ═══════════════════════════════════════════════════════
// Mode switching
// ═══════════════════════════════════════════════════════
function updateMode() {
  $('modeBtn').textContent = 'Mode: ' + (voiceMode === 'local' ? 'Local' : 'Cloud');
  $('modeLabel').textContent = voiceMode === 'local' ? 'Local' : 'Gemini Live';
  $('modeBtn').classList.toggle('on', voiceMode === 'cloud');
}
$('modeBtn').onclick = () => {
  if (sessionActive) { if (voiceMode==='local') stopLocalSession(); else stopSession(); }
  voiceMode = voiceMode === 'local' ? 'cloud' : 'local';
  localStorage.setItem('kingston_voice_mode', voiceMode);
  updateMode();
  addMsg('system', 'Mode: ' + (voiceMode === 'local' ? 'Local' : 'Cloud'));
  if (wakeWordEnabled && !sessionActive) restartWakeWord();
};

// ═══════════════════════════════════════════════════════
// Chat panel toggle
// ═══════════════════════════════════════════════════════
$('chatToggle').onclick = () => chatPanel.classList.toggle('hidden');
$('chatCloseBtn').onclick = () => chatPanel.classList.add('hidden');

// ═══════════════════════════════════════════════════════
// Wake Word — Web Speech API
// ═══════════════════════════════════════════════════════
function hasWebSpeech() { return !!(window.SpeechRecognition || window.webkitSpeechRecognition); }

function startWakeWord() {
  if (!hasWebSpeech() || wakeWordActive || sessionActive) return;
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  wakeRecognition = new SR();
  wakeRecognition.continuous = true;
  wakeRecognition.interimResults = true;
  // fr-CA handles bilingual (French + English) better than fr-FR
  wakeRecognition.lang = 'fr-CA';
  wakeRecognition.onstart = () => {
    wakeWordActive = true; wakeBar.classList.add('active');
    wakeText.textContent = 'Ecoute...'; wakeText.className = '';
    if (!sessionActive) setStatus('wakeword', 'Dis "Computer"...');
  };
  wakeRecognition.onresult = (e) => {
    let interim = '', final = '';
    for (let i = e.resultIndex; i < e.results.length; i++) {
      const t = e.results[i][0].transcript;
      if (e.results[i].isFinal) final += t; else interim += t;
    }
    const display = (final||interim).trim();
    if (display) wakeText.textContent = display;
    const check = (final||interim).toLowerCase().replace(/[.,!?;:'"]/g, '');
    if (WAKE_REGEX.test(check)) onWakeWordDetected();
  };
  wakeRecognition.onerror = (e) => {
    if (e.error==='no-speech'||e.error==='aborted') return;
    if (e.error==='not-allowed') { wakeWordActive=false; wakeWordEnabled=false; $('vcWake').classList.remove('on'); wakeBar.classList.remove('active'); return; }
    if (wakeWordEnabled && !sessionActive) setTimeout(restartWakeWord, 500);
  };
  wakeRecognition.onend = () => {
    wakeWordActive = false;
    if (wakeWordEnabled && !sessionActive) {
      // KEY FIX: do NOT hide the bar — restart silently to avoid flash
      setTimeout(restartWakeWord, 300);
    } else {
      wakeBar.classList.remove('active');
      if (!sessionActive) setStatus('disconnected','Pret');
    }
  };
  try { wakeRecognition.start(); } catch {}
}
function stopWakeWord() { wakeWordActive=false; try{if(wakeRecognition)wakeRecognition.stop();}catch{} wakeRecognition=null; wakeBar.classList.remove('active'); }
function restartWakeWord() { if(!wakeWordEnabled||sessionActive||wakeWordActive)return; wakeWordActive=false; try{if(wakeRecognition)wakeRecognition.stop();}catch{} wakeRecognition=null; setTimeout(()=>{if(wakeWordEnabled&&!sessionActive)startWakeWord();},200); }

function onWakeWordDetected() {
  // Anti-double: cross-tab lock via localStorage
  const lastWake = parseInt(localStorage.getItem('kingston_wake_lock') || '0');
  if (Date.now() - lastWake < 3000) return; // Another tab already handling
  localStorage.setItem('kingston_wake_lock', String(Date.now()));

  addMsg('system','"Computer" detecte!');
  playBeep(880,120); wakeText.textContent='Detecte!'; wakeText.className='heard';
  stopWakeWord();
  speakGreeting().then(()=>{ if(voiceMode==='local')startLocalSession(); else startSession(); });
}
async function speakGreeting() {
  const texts=['Bonjour Nicolas!','Oui Nicolas?','Je t\'ecoute Nicolas.','A ton service Nicolas.'];
  const text=texts[Math.floor(Math.random()*texts.length)];
  addMsg('model',text); setStatus('speaking','Kingston...');
  try {
    // Init audio context early (some browsers need it before first play)
    if(!playCtx){playCtx=new AudioContext({sampleRate:24000});}
    if(playCtx.state==='suspended')await playCtx.resume();
    const r=await fetch(API+'/api/tts',{method:'POST',headers:{'Content-Type':'application/json','X-Auth-Token':TOKEN},body:JSON.stringify({text,voice:'fr-male'})});
    if(r.ok){
      const ab=await r.arrayBuffer();
      // Decode MP3 → play through AudioContext (bypasses autoplay restrictions)
      const decoded=await playCtx.decodeAudioData(ab);
      const src=playCtx.createBufferSource();src.buffer=decoded;src.connect(playCtx.destination);
      await new Promise(res=>{src.onended=res;src.start();});
    }else{console.warn('[greeting] TTS returned',r.status);}
  }catch(e){console.warn('[greeting] TTS error:',e);}
}
function toggleWakeWord() {
  wakeWordEnabled=!wakeWordEnabled; $('vcWake').classList.toggle('on',wakeWordEnabled); $('wakeBtn').classList.toggle('on',wakeWordEnabled);
  if(wakeWordEnabled){if(!sessionActive){startWakeWord();addMsg('system','Wake word active.');}}
  else{stopWakeWord();if(!sessionActive)setStatus('disconnected','Pret');addMsg('system','Wake word off.');}
}
function playBeep(f,d){try{const c=new AudioContext();const o=c.createOscillator();const g=c.createGain();o.frequency.value=f;o.type='sine';g.gain.value=0.12;o.connect(g);g.connect(c.destination);o.start();g.gain.exponentialRampToValueAtTime(0.001,c.currentTime+d/1000);o.stop(c.currentTime+d/1000+.05);setTimeout(()=>c.close(),d+200);}catch{}}

// ═══════════════════════════════════════════════════════
// LOCAL MODE — Web Speech → Claude API → Edge TTS
// ═══════════════════════════════════════════════════════
function startLocalSession(){if(sessionActive)return;sessionActive=true;localProcessing=false;localFinalText='';stopWakeWord();addMsg('system','Mode local — parle, Kingston ecoute...');startLocalListening();}

function startLocalListening(){
  if(!hasWebSpeech()||localProcessing||localListening)return;
  const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
  localRecognition=new SR(); localRecognition.continuous=true; localRecognition.interimResults=true; localRecognition.lang='fr-CA';
  localRecognition.onstart=()=>{localListening=true;localFinalText='';wakeBar.classList.add('active');wakeText.textContent='Ecoute...';wakeText.className='';setStatus('local-listening','Kingston ecoute...');};
  localRecognition.onresult=(e)=>{
    let interim='',nf='';
    for(let i=e.resultIndex;i<e.results.length;i++){const t=e.results[i][0].transcript;if(e.results[i].isFinal)nf+=t;else interim+=t;}
    if(nf)localFinalText+=(localFinalText?' ':'')+nf.trim();
    const d=(localFinalText+(interim?' '+interim:'')).trim();
    if(d)wakeText.textContent=d;
    clearTimeout(localSilenceTimer);
    // Adaptive silence: generous thresholds to avoid cutting mid-sentence
    if(localFinalText){const words=localFinalText.trim().split(/\s+/).length;const silenceMs=words<5?4000:words<12?3000:2000;localSilenceTimer=setTimeout(()=>{if(localFinalText&&!localProcessing&&sessionActive)processLocal(localFinalText.trim());},silenceMs);}
  };
  localRecognition.onerror=(e)=>{if(e.error==='no-speech'||e.error==='aborted')return;if(e.error==='not-allowed'){stopLocalSession();return;}if(sessionActive&&!localProcessing){localListening=false;setTimeout(()=>{if(sessionActive&&!localProcessing)startLocalListening();},500);}};
  localRecognition.onend=()=>{localListening=false;if(sessionActive&&!localProcessing){setTimeout(()=>{if(sessionActive&&!localProcessing)startLocalListening();},400);}else{wakeBar.classList.remove('active');}};
  try{localRecognition.start();}catch{localListening=false;}
}
function stopLocalListening(){localListening=false;clearTimeout(localSilenceTimer);try{if(localRecognition)localRecognition.stop();}catch{}localRecognition=null;wakeBar.classList.remove('active');}

async function processLocal(text){
  if(!text||localProcessing)return; localProcessing=true; localFinalText='';
  stopLocalListening(); addMsg('user',text);
  setStatus('processing','Kingston reflechit...'); wakeBar.classList.add('active'); wakeText.textContent='Reflexion...'; wakeText.className='';
  // Pre-warm AudioContext
  if(!playCtx){playCtx=new AudioContext({sampleRate:24000});}
  if(playCtx.state==='suspended')playCtx.resume().catch(()=>{});
  try{
    const ctrl=new AbortController(); const to=setTimeout(()=>ctrl.abort(),120000);
    const r=await fetch(API+'/api/chat/voice',{method:'POST',headers:{'Content-Type':'application/json','X-Auth-Token':TOKEN},body:JSON.stringify({message:text}),signal:ctrl.signal});
    clearTimeout(to);
    if(!r.ok)throw new Error('API '+r.status);
    const d=await r.json(); const resp=d.response||'Desole, pas de reponse.';
    addMsg('model',resp);
    const mdImg=resp.match(/!\[[^\]]*\]\(([^)]+)\)/);
    const rawImg=resp.match(/https?:\/\/[^\s]+\.(?:png|jpg|jpeg|gif|webp)/i);
    if(mdImg)showVisual(mdImg[1]);else if(rawImg)showVisual(rawImg[0]);
    // Clean response for TTS: strip thinking headers, markdown artifacts, code blocks
    let ttsText=resp.replace(/\*\*[A-Z][^*]{3,60}\*\*\n?/g,'') // **Thinking Headers**
      .replace(/```[\s\S]*?```/g,'') // code blocks
      .replace(/#{1,3}\s+/g,'') // markdown headers
      .replace(/\*\*([^*]+)\*\*/g,'$1') // bold → plain
      .replace(/\[([^\]]+)\]\([^)]+\)/g,'$1') // links → text only
      .replace(/\n{2,}/g,'. ').replace(/\n/g,' ') // newlines → sentence breaks
      .replace(/\s{2,}/g,' ').trim();
    if(!ttsText)ttsText='Hmm, laisse-moi reflechir.';
    setStatus('speaking','Kingston parle...'); wakeText.textContent='Synthese...';
    const tCtrl=new AbortController();const tTo=setTimeout(()=>tCtrl.abort(),15000);
    const ttsVoice=detectVoice(ttsText);
    const tr=await fetch(API+'/api/tts',{method:'POST',headers:{'Content-Type':'application/json','X-Auth-Token':TOKEN},body:JSON.stringify({text:ttsText.slice(0,500),voice:ttsVoice}),signal:tCtrl.signal});
    clearTimeout(tTo);
    if(tr.ok){
      if(playCtx.state==='suspended')await playCtx.resume();
      const ab=await tr.arrayBuffer();
      const decoded=await playCtx.decodeAudioData(ab);
      const src=playCtx.createBufferSource();src.buffer=decoded;src.connect(playCtx.destination);
      localAudio={stop:()=>{try{src.stop();}catch{}}};
      await new Promise(res=>{src.onended=()=>{localAudio=null;res();};src.start();});
    }else{console.warn('[local-tts] TTS returned',tr.status);}
  }catch(err){if(err.name==='AbortError')addMsg('system','Timeout.');else addMsg('system','Erreur: '+(err.message||''));}
  localProcessing=false; if(sessionActive)startLocalListening();
}
function stopLocalSession(){sessionActive=false;localProcessing=false;localFinalText='';clearTimeout(localSilenceTimer);stopLocalListening();if(localAudio){try{localAudio.stop();}catch{}localAudio=null;}if(wakeWordEnabled)setTimeout(()=>{if(!sessionActive){startWakeWord();setStatus('wakeword','Dis "Computer"...');}},500);else setStatus('disconnected','Pret');}

// ═══════════════════════════════════════════════════════
// CLOUD MODE — Gemini Live WebSocket
// ═══════════════════════════════════════════════════════
let wsRetries=0;const MAX_WS_RETRIES=3;
function connectWS(){
  if(ws)return; setStatus('connecting','Connexion...');
  try{ws=new WebSocket(WS_URL);}catch(e){addMsg('system','Erreur WebSocket: '+e.message);ws=null;return;}
  ws.onopen=()=>{wsRetries=0;ws.send(JSON.stringify({type:'auth',token:TOKEN,voice:'Enceladus',language:'fr,en'}));setStatus('connecting','Auth...');};
  ws.onmessage=(ev)=>{let m;try{m=JSON.parse(ev.data);}catch{return;}handleWS(m);};
  ws.onerror=(e)=>{console.warn('[ws] error',e);};
  ws.onclose=()=>{
    ws=null;
    if(sessionActive&&wsRetries<MAX_WS_RETRIES){
      wsRetries++;addMsg('system',`Reconnexion... (${wsRetries}/${MAX_WS_RETRIES})`);
      setTimeout(()=>{if(sessionActive)connectWS();},1500*wsRetries);
    }else if(sessionActive){addMsg('system','Connexion perdue apres '+MAX_WS_RETRIES+' essais.');stopSession();}
  };
}
function handleWS(m){
  switch(m.type){
    case 'ready':setStatus('ready','Kingston ecoute...');addMsg('system','Gemini Live connecte.');startMic();break;
    case 'audio':playChunk(m.data);if(!isSpeaking){isSpeaking=true;setStatus('speaking','Kingston parle...');}break;
    case 'transcript':
      if(m.role==='model'){
        if(!currentTranscriptEl||currentTranscriptEl.dataset.role!=='model'){currentTranscriptEl=addMsg('model',m.text);currentTranscriptEl.dataset.role='model';currentTranscriptEl._raw=m.text;}
        else{currentTranscriptEl._raw=(currentTranscriptEl._raw||'')+m.text;const c=currentTranscriptEl.querySelector('div:last-child');if(c)c.innerHTML=renderRich(currentTranscriptEl._raw);transcript.scrollTop=transcript.scrollHeight;}
      }else{currentTranscriptEl=addMsg('user',m.text);currentTranscriptEl.dataset.role='user';}break;
    case 'interrupted':stopPlayback();isSpeaking=false;setStatus('ready','Kingston ecoute...');currentTranscriptEl=null;break;
    case 'turn_complete':isSpeaking=false;setStatus('ready','Kingston ecoute...');currentTranscriptEl=null;break;
    case 'tool':if(m.status==='calling')addMsg('tool','> '+m.name+'...');else if(m.status==='done')addMsg('tool','< '+m.name+': '+(m.result||'').slice(0,200));break;
    case 'session_closed':addMsg('system','Session Gemini expiree — reconnexion...');if(ws){try{ws.close();}catch{}ws=null;}stopMic();stopPlayback();isSpeaking=false;currentTranscriptEl=null;setTimeout(()=>{if(sessionActive){setStatus('connecting','Reconnexion...');connectWS();}},1500);break;
    case 'error':addMsg('system','Erreur: '+m.message);break;
  }
}

// ─── Mic capture (PCM 16kHz) ───
async function startMic(){
  try{
    // Request mic permission first (user gesture propagation)
    micStream=await navigator.mediaDevices.getUserMedia({audio:{channelCount:1,sampleRate:16000,echoCancellation:true,noiseSuppression:true}});
    audioCtx=new AudioContext({sampleRate:16000});
    if(audioCtx.state==='suspended')await audioCtx.resume();
    const code=`class P extends AudioWorkletProcessor{constructor(){super();this.b=[];}process(i){const c=i[0]?.[0];if(!c)return true;for(let j=0;j<c.length;j++)this.b.push(c[j]);if(this.b.length>=1600){this.port.postMessage(new Float32Array(this.b.splice(0,1600)));}return true;}}registerProcessor('p',P);`;
    const blob=new Blob([code],{type:'application/javascript'});const url=URL.createObjectURL(blob);await audioCtx.audioWorklet.addModule(url);URL.revokeObjectURL(url);
    const src=audioCtx.createMediaStreamSource(micStream);workletNode=new AudioWorkletNode(audioCtx,'p');
    workletNode.port.onmessage=(e)=>{if(!ws||ws.readyState!==1)return;const f=e.data;const i=new Int16Array(f.length);for(let j=0;j<f.length;j++)i[j]=Math.max(-32768,Math.min(32767,Math.round(f[j]*32767)));const b=new Uint8Array(i.buffer);let s='';for(let j=0;j<b.length;j++)s+=String.fromCharCode(b[j]);ws.send(JSON.stringify({type:'audio',data:btoa(s)}));};
    src.connect(workletNode);
    // Connect to a silent gain node (some browsers need graph connection for process() to fire)
    const silentGain=audioCtx.createGain();silentGain.gain.value=0;
    workletNode.connect(silentGain);silentGain.connect(audioCtx.destination);
    console.log('[mic] Started — AudioWorklet capturing PCM 16kHz');
  }catch(err){console.warn('[mic] Worklet fail:',err);addMsg('system','Erreur micro: '+err.message);}
}
function stopMic(){if(workletNode){workletNode.disconnect();workletNode=null;}if(micStream){micStream.getTracks().forEach(t=>t.stop());micStream=null;}if(audioCtx){audioCtx.close().catch(()=>{});audioCtx=null;}}

// ─── Audio playback (PCM 24kHz) ───
function ensurePlay(){if(!playCtx)playCtx=new AudioContext({sampleRate:24000});if(playCtx.state==='suspended')playCtx.resume();}
function playChunk(b64){ensurePlay();const r=atob(b64);const b=new Uint8Array(r.length);for(let i=0;i<r.length;i++)b[i]=r.charCodeAt(i);const i16=new Int16Array(b.buffer);const f=new Float32Array(i16.length);for(let i=0;i<i16.length;i++)f[i]=i16[i]/32768;const buf=playCtx.createBuffer(1,f.length,24000);buf.getChannelData(0).set(f);const s=playCtx.createBufferSource();s.buffer=buf;s.connect(playCtx.destination);const now=playCtx.currentTime;const at=Math.max(now+.01,nextPlayTime);s.start(at);nextPlayTime=at+buf.duration;playQueue.push(s);s.onended=()=>{const idx=playQueue.indexOf(s);if(idx>=0)playQueue.splice(idx,1);};}
function stopPlayback(){playQueue.forEach(s=>{try{s.stop();}catch{}});playQueue=[];nextPlayTime=0;}

// ─── Webcam ───
async function toggleCam(){
  if(webcamOn){camVideo.srcObject?.getTracks().forEach(t=>t.stop());camVideo.srcObject=null;webcamOn=false;camBox.classList.add('hidden');$('vcCam').classList.remove('on');}
  else{try{const s=await navigator.mediaDevices.getUserMedia({video:{width:{ideal:640},height:{ideal:480}},audio:false});camVideo.srcObject=s;webcamOn=true;camBox.classList.remove('hidden');$('vcCam').classList.add('on');}catch(e){addMsg('system','Webcam: '+e.message);}}
}

// ─── Session management ───
function startSession(){if(sessionActive)return;if(voiceMode==='local'){startLocalSession();return;}sessionActive=true;stopWakeWord();connectWS();}
function stopSession(){if(voiceMode==='local'){stopLocalSession();return;}sessionActive=false;stopMic();stopPlayback();if(ws){ws.close();ws=null;}isSpeaking=false;currentTranscriptEl=null;if(wakeWordEnabled)setTimeout(()=>{if(!sessionActive){startWakeWord();setStatus('wakeword','Dis "Computer"...');}},500);else setStatus('disconnected','Pret');}
function toggleSession(){if(sessionActive)stopSession();else startSession();}

// ─── Text input ───
function sendText(){
  const t=textIn.value.trim();if(!t)return;textIn.value='';
  if(voiceMode==='local'){processLocal(t);return;}
  if(!sessionActive){startSession();const w=setInterval(()=>{if(ws&&ws.readyState===1){clearInterval(w);addMsg('user',t);ws.send(JSON.stringify({type:'text',text:t}));}},200);setTimeout(()=>clearInterval(w),10000);return;}
  if(!ws||ws.readyState!==1)return;addMsg('user',t);ws.send(JSON.stringify({type:'text',text:t}));
}

// ═══════════════════════════════════════════════════════
// Event Listeners
// ═══════════════════════════════════════════════════════
micBtn.onclick = toggleSession;
$('vcWake').onclick = toggleWakeWord;
$('wakeBtn').onclick = toggleWakeWord;
$('vcCam').onclick = toggleCam;
textIn.addEventListener('keydown', e => { if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendText();} });
$('textSend').onclick = sendText;
document.addEventListener('keydown', e => { if(e.key==='Escape'&&sessionActive){stopSession();addMsg('system','Session arretee.');} });

// ── PWA ──
if('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});
let deferredInstall=null;
window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredInstall=e;});

// ── Init ──
updateMode();
loadDashboard();
setInterval(loadDashboard, 60000); // Refresh every minute

if(hasWebSpeech()){wakeWordEnabled=true;$('vcWake').classList.add('on');$('wakeBtn').classList.add('on');startWakeWord();}
else setStatus('disconnected','Pret');
</script>
</body>
</html>
